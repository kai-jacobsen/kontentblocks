/*! Kontentblocks ProdVersion 2015-02-21 06:02 */
var KB=KB||{};KB.Config={},KB.Backbone={Backend:{},Frontend:{},Shared:{},Common:{},Sidebar:{AreaOverview:{},AreaDetails:{}},Inline:{}},KB.Fields={},KB.Utils={},KB.Ext={},KB.OSConfig={},KB.IEdit={},KB.Events={},_.extend(KB,Backbone.Events),_.extend(KB.Events,Backbone.Events),KB.Ajax=function(a){return{send:function(b,c,d,e){var f,g=e||{};f=b.postId?b.postId:KB.Environment&&KB.Environment.postId?KB.Environment.postId:!1;var h=_.extend({supplemental:b.supplemental||{},count:parseInt(KB.Environment.moduleCount,10),nonce:a("#_kontentblocks_ajax_nonce").val(),post_id:f,kbajax:!0},b);return a("#publish").attr("disabled","disabled"),a.ajax({url:ajaxurl,data:h,type:"POST",dataType:"json",success:function(a){a&&(d&&c?c.call(d,a,g):c&&c(a,g))},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){a("#publish").removeAttr("disabled")}})}}}(jQuery),KB.Checks=function(a){return{blockLimit:function(b){var c=b.get("limit"),d=a("#"+b.get("id")+" li.kb-module").length;return 0!==c&&d===c?!1:!0},userCan:function(b){var c=a.inArray(b,KB.Config.get("caps"));return-1!==c}}}(jQuery),KB.Config=function(){var a=KB.appData.config;return{get:function(b){return b?a[b]?a[b]:null:a},getNonce:function(b){var c=["update","create","delete","read"];return-1!==_.indexOf(c,b)?a.nonces[b]:(_K.error("Invalid nonce requested in kb.cm.Config.js"),null)},inDevMode:function(){return a.env.dev},getRootURL:function(){return a.env.rootUrl},getFieldJsUrl:function(){return a.env.fieldJsUrl},getHash:function(){return a.env.hash}}}(jQuery),KB.FieldCollection=Backbone.View.extend({attachedFields:[],addField:function(a,b,c){_.isEmpty(c)?this.attachedFields[a]=b:this.attachedFields[c][a]=b},hasField:function(a,b){return _.isEmpty(b)?a in this.attachedFields:(this.attachedFields[b]||(this.attachedFields[b]={}),a in this.attachedFields[b])},getField:function(a,b){return _.isEmpty(b)?this.attachedFields[a]:this.attachedFields[b][a]},clearFields:function(){this.attachedFields={}}}),KB.Backbone.Common.FieldConfigModel=Backbone.Model.extend({idAttribute:"uid",initialize:function(){var a=this.get("fieldId");a&&(this.ModuleModel=KB.Modules.get(a))&&this.getType()&&(this.set("ModuleModel",this.ModuleModel),this.setData(),this.bindHandlers(),this.setupType())},bindHandlers:function(){this.listenToOnce(this.ModuleModel,"remove",this.remove),this.listenTo(this.ModuleModel,"change:moduleData",this.setData),this.listenTo(this.ModuleModel,"modal.serialize",this.rebind),this.listenTo(this.ModuleModel,"modal.serialize.before",this.unbind)},setupType:function(){(obj=this.getType())&&(this.FieldView=new obj({el:this.getElement(),model:this}))},getElement:function(){return jQuery('*[data-kbfuid="'+this.get("uid")+'"]')[0]},getType:function(){var a=this.get("type");if(!KB.Checks.userCan("edit_kontentblocks"))return!1;var b=KB.Fields.get(a);return b&&b.prototype.hasOwnProperty("initialize")?b:!1},setData:function(a){var b=a||this.get("ModuleModel");this.set("value",KB.Util.getIndex(b.get("moduleData"),this.get("kpath")))},remove:function(){this.stopListening(),KB.FieldConfigs.remove(this)},rebind:function(){this.FieldView&&(this.FieldView.setElement(this.getElement()),this.FieldView.render())},unbind:function(){this.FieldView&&this.FieldView.derender&&this.FieldView.derender()}}),KB.Backbone.Common.FieldConfigModelModal=KB.Backbone.Common.FieldConfigModel.extend({initialize:function(){KB.Backbone.Common.FieldConfigModel.prototype.initialize.call(this,arguments)},bindHandlers:function(){this.listenToOnce(this.ModuleModel,"remove",this.remove),this.listenTo(this.ModuleModel,"change:moduleData",this.setData),this.listenTo(KB.Events,"modal.reload",this.rebind),this.listenTo(KB.Events,"modal.close",this.remove)},rebind:function(){this.FieldView&&(this.FieldView.setElement(this.getElement()),this.FieldView.render(),console.log("re-render"))},getElement:function(){return jQuery('*[data-kbfuid="'+this.get("uid")+'"]',KB.EditModalModules.$el)[0]}}),_.extend(KB.Fields,Backbone.Events),_.extend(KB.Fields,{fields:{},addEvent:function(){this.listenTo(KB,"kb:ready",this.init),this.listenTo(this,"newModule",this.newModule)},register:function(a,b){_.extend(b,Backbone.Events),this.fields[a]=b},registerObject:function(a,b){_.extend(b,Backbone.Events),this.fields[a]=b},init:function(){var a=this;_.each(this.fields,function(b){b.hasOwnProperty("init")&&b.init.call(b),b.listenTo(a,"update",b.update),b.listenTo(a,"frontUpdate",b.frontUpdate)})},newModule:function(a){var b=this;a.listenTo(this,"update",a.update),a.listenTo(this,"frontUpdate",a.frontUpdate),setTimeout(function(){b.trigger("update")},750)},get:function(a){return this.fields[a]?this.fields[a]:null}}),KB.Fields.addEvent(),KB.Backbone.Common.FieldConfigsCollection=Backbone.Collection.extend({model:KB.Backbone.Common.FieldConfigModel,initialize:function(){this.listenTo(this,"add",this.log)},log:function(a){console.log("coll add",a)}}),Logger.useDefaults();var _K=Logger.get("_K"),_KS=Logger.get("_KS");_K.setLevel(_K.INFO),_KS.setLevel(_KS.INFO),KB.Config.inDevMode()||_K.setLevel(Logger.OFF),Logger.setHandler(function(a,b){if(KB.Menubar&&2===b.level.value&&"_KS"===b.name)a[0]&&KB.Menubar.StatusBar.setMsg(a[0]);else{var c=window.console,d=c.log;b.name&&(a[0]="["+b.name+"] "+a[0]),b.level===Logger.WARN&&c.warn?d=c.warn:b.level===Logger.ERROR&&c.error?d=c.error:b.level===Logger.INFO&&c.info&&(d=c.info),d.apply(c,a)}}),KB.Utils.MediaWorkflow=function(a){function b(){return f?f:(f=wp.media({title:g.title,button:{text:g.buttontext},multiple:g.multiple,library:{type:g.type}}),f.on("ready",d),f.state("library").on("select",e),f)}function c(a){g=_.isUndefined(a)?_.extend(h,{}):_.extend(h,a),b().open()}function d(){}function e(){g.select===!1&&alert("No callback given"),g.select(this)}var f,g,h={buttontext:"Buttontext",multiple:!1,type:"image",title:"",select:!1,ready:!1};c(a)},KB.Menus=function(a){return{loadingContainer:null,initiatorEl:null,sendButton:null,createSanitizedId:function(b,c){this.initiatorEl=a(b),this.loadingContainer=this.initiatorEl.closest(".kb-menu-field").addClass("loading"),this.$sendButton=a("#kb-submit"),this.disableSendButton(),KB.Ajax.send({inputvalue:b.value,checkmode:c,action:"getSanitizedId",_ajax_nonce:KB.Config.getNonce("read")},this.insertId,this)},insertId:function(b){b.success?(a(".kb-js-area-id").val(b.data.id),this.enableSendButton()):(this.initiatorEl.addClass(),a(".kb-js-area-id").val("Please chose a different name")),this.loadingContainer.removeClass("loading")},disableSendButton:function(){this.$sendButton.attr("disabled","disabled").val("Disabled")},enableSendButton:function(){this.$sendButton.attr("disabled",!1).val("Create")}}}(jQuery),KB.Backbone.ModulesDefinitionsCollection=Backbone.Collection.extend({initialize:function(a,b){this.area=b.area},setup:function(){return this.categories=this.prepareCategories(),this.sortToCategories(),this},getModules:function(a){return this.categories[a].modules},sortToCategories:function(){var a=this;_.each(this.models,function(b){if(a.validateVisibility(b)){var c=_.isUndefined(b.get("settings").category)?"standard":b.get("settings").category;a.categories[c].modules.push(b)}})},validateVisibility:function(a){return a.get("settings").hidden?!1:a.get("settings").disabled?!1:!(!a.get("settings").globallyAvailable&&this.area.model.get("dynamic"))},prepareCategories:function(){var a={};return _.each(KB.payload.ModuleCategories,function(b,c){a[c]={id:c,name:b,modules:[]}}),a}}),KB.Backbone.ModuleBrowserModuleDescription=Backbone.View.extend({initialize:function(a){this.options=a||{},this.options.browser.on("browser:close",this.close,this)},update:function(){this.$el.empty(),this.$el.html(this.model.get("template")?KB.Templates.render("backend/modulebrowser/module-template-description",{module:this.model.toJSON()}):KB.Templates.render("backend/modulebrowser/module-description",{module:this.model.toJSON()})),this.model.get("settings").poster!==!1&&this.$el.append(KB.Templates.render("backend/modulebrowser/poster",{module:this.model.toJSON()})),this.model.get("settings").helpfile!==!1&&this.$el.append(KB.Templates.render(this.model.get("settings").helpfile,{module:this.model.toJSON()}))},close:function(){}}),KB.Backbone.ModuleBrowserListItem=Backbone.View.extend({tagName:"li",className:"modules-list-item",initialize:function(a){this.options=a||{},this.area=a.browser.area},render:function(a){this.$el.html(this.model.get("template")?KB.Templates.render("backend/modulebrowser/module-template-list-item",{module:this.model.toJSON()}):KB.Templates.render("backend/modulebrowser/module-list-item",{module:this.model.toJSON()})),a.append(this.$el)},events:{click:"loadDetails","click .kb-js-create-module":"createModule"},loadDetails:function(){this.options.browser.loadDetails(this.model)},createModule:function(){this.options.browser.createModule(this.model)},close:function(){this.remove()}}),KB.Backbone.ModuleBrowserModulesList=Backbone.View.extend({initialize:function(a){this.options=a||{}},modules:{},subviews:{},setModules:function(a){return this.modules=a,this},update:function(){var a=this,b=!1;this.$el.empty(),_.each(this.modules,function(c){a.subviews[c.cid]=new KB.Backbone.ModuleBrowserListItem({model:c,parent:a,browser:a.options.browser}),b===!1&&(a.options.browser.loadDetails(c),b=!b),a.$el.append(a.subviews[c.cid].render(a.$el))})}}),KB.Backbone.ModuleBrowser=Backbone.View.extend({initialize:function(a){this.options=a||{},this.area=this.options.area,this.modulesDefinitions=new KB.Backbone.ModulesDefinitionsCollection(this.prepareAssignedModules(),{model:KB.Backbone.ModuleDefinition,area:this.options.area}).setup();var b=this.getViewMode();this.$el.append(KB.Templates.render("backend/modulebrowser/module-browser",{viewMode:b})),this.subviews.ModulesList=new KB.Backbone.ModuleBrowserModulesList({el:jQuery(".modules-list",this.$el),browser:this}),this.subviews.ModuleDescription=new KB.Backbone.ModuleBrowserModuleDescription({el:jQuery(".module-description",this.$el),browser:this}),this.subviews.Navigation=new KB.Backbone.ModuleBrowserNavigation({el:jQuery(".module-categories",this.$el),cats:this.modulesDefinitions.categories,browser:this}),this.listenTo(this.subviews.Navigation,"browser:change",this.update)},tagName:"div",id:"module-browser",className:"kb-overlay",events:{"click .close-browser":"close","click .module-browser--switch__list-view":"toggleViewMode","click .module-browser--switch__excerpt-view":"toggleViewMode"},subviews:{},toggleViewMode:function(){jQuery(".module-browser-wrapper",this.$el).toggleClass("module-browser--list-view module-browser--excerpt-view");var a="mdb_"+this.area.model.get("id")+"_state",b=store.get(a);"module-browser--list-view"==b?store.set(a,"module-browser--excerpt-view"):store.set(a,"module-browser--list-view")},render:function(){this.open()},getViewMode:function(){var a="mdb_"+this.area.model.get("id")+"_state";return store.get(a)?store.get(a):(store.set(a,"module-browser--list-view"),"module-browser--list-view")},open:function(){this.$el.appendTo("body"),jQuery("#wpwrap").addClass("module-browser-open"),jQuery(".kb-nano").nanoScroller({flash:!0,contentClass:"kb-nano-content"})},close:function(){jQuery("#wpwrap").removeClass("module-browser-open"),this.trigger("browser:close"),this.$el.detach()},update:function(a){var b=a.get("id"),c=this.modulesDefinitions.getModules(b);this.subviews.ModulesList.setModules(c).update()},loadDetails:function(a){this.subviews.ModuleDescription.model=a,this.subviews.ModuleDescription.update()},createModule:function(a){var b,c;return KB.Checks.userCan("create_kontentblocks")||KB.Notice.notice("You're not allowed to do this","error"),b=KB.Areas.get(this.options.area.model.get("id")),KB.Checks.blockLimit(b)?(c={action:"createNewModule","class":a.get("settings")["class"],master:a.get("master"),masterRef:a.get("masterRef"),template:a.get("template"),templateRef:a.get("templateRef"),areaContext:this.options.area.model.get("context"),area:this.options.area.model.get("id"),_ajax_nonce:KB.Config.getNonce("create"),frontend:KB.appData.config.frontend},this.close(),void KB.Ajax.send(c,this.success,this)):(KB.Notice.notice("Limit for this area reached","error"),!1)},success:function(a){var b,c;c=a.data,this.options.area.modulesList.append(c.html),b=KB.Modules.add(c.module),this.options.area.attachModuleView(b),this.parseAdditionalJSON(c.json),KB.TinyMCE.addEditor(b.View.$el),KB.Fields.trigger("newModule",b.View),b.View.$el.addClass("kb-open")},parseAdditionalJSON:function(a){KB.payload.Fields||(KB.payload.Fields={}),_.extend(KB.payload.Fields,a.Fields),KB.Payload.parseAdditionalJSON(a)},prepareAssignedModules:function(){var a=this.area.model.get("assignedModules"),b=[];return _.each(KB.payload.ModuleDefinitions,function(c){-1!==_.indexOf(a,c.settings["class"])&&b.push(c)}),b}}),KB.Backbone.ModuleBrowserNavigation=Backbone.View.extend({item:Backbone.View.extend({initialize:function(a){this.options=a||{}},tagName:"li",className:"cat-item",events:{click:"change"},change:function(){this.options.parent.trigger("browser:change",this.model),this.$el.addClass("active"),jQuery("li").not(this.$el).removeClass("active")},render:function(){var a=_.keys(this.model.get("modules")).length,b="("+a+")";return 0===a?!1:(this.options.parent.catSet===!1&&(this.options.parent.catSet=!0,this.options.browser.update(this.model),this.$el.addClass("active")),void this.options.parent.$list.append(this.$el.html(this.model.get("name")+'<span class="module-count">'+b+"</span>")))}}),catSet:!1,initialize:function(a){var b=this;this.options=a||{},this.$list=jQuery("<ul></ul>").appendTo(this.$el),_.each(this.options.cats,function(a){var c=new Backbone.Model(a);new b.item({parent:b,model:c,browser:b.options.browser}).render()})}}),KB.Notice=function(){"use strict";return{notice:function(a,b){alertify.log(a,b,3500)},confirm:function(a,b,c,d){alertify.confirm(a,function(a){a?b.call(d):c.call(d)})}}}(jQuery),KB.Payload=function(){return{getFieldData:function(a,b,c,d){var e;return this._typeExists(a)?(e=KB.payload.fieldData[a],e[b]?_.isEmpty(d)?e[b][c]?e[b][c]:[]:e[b][d]&&e[b][d][c]?e[b][d][c]:[]:[]):[]},_typeExists:function(a){return!_.isUndefined(KB.payload.fieldData[a])},getFieldArgs:function(a,b){return KB.payload.Fields&&KB.payload.Fields[a]?b&&KB.payload.Fields[a][b]?KB.payload.Fields[a][b]:KB.payload.Fields[a]:null},parseAdditionalJSON:function(a){var b;return b={Fields:[]},a&&a.Fields&&(b.Fields=KB.FieldConfigs.add(_.toArray(a.Fields))),b}}}(jQuery),KB.Backbone.Frontend.StatusBar=Backbone.View.extend({messages:[],className:"kb-statusbar kb-brand",initialize:function(){this.$statusbar=jQuery('<span class="kb-brand kb-status-bar">Kontentblocks</span>').appendTo(this.$el),this.interval(this.handleMsg,500,1e4)},reset:function(){this.$statusbar.text("kontentblocks")},setMsg:function(a){this.messages.push(a)},printMsg:function(a){var b=this;this.$statusbar.fadeTo(50,0,function(){b.$statusbar.text(a),b.$statusbar.fadeTo(50,1)})},handleMsg:function(){this.messages.length>0&&this.printMsg(this.messages.shift())},interval:function(a,b,c){var d=this,e=function(b,c){return function(){if("undefined"==typeof c||c-->0){setTimeout(e,b);try{a.call(d)}catch(f){throw c=0,f.toString()}}}}(b,c);setTimeout(e,b)}}),KB.Templates=function(a){function b(b,c){var e;if(c=c||{},!d[b]){tplDir=KB.Config.getRootURL()+"js/templates";var f=tplDir+"/"+b+".hbs?"+KB.Config.getHash(),g=/^https?:\/\//i;g.test(b)&&(f=b),KB.Util.stex.get(f)?e=KB.Util.stex.get(f):a.ajax({url:f,method:"GET",async:!1,success:function(a){e=a,KB.Util.stex.set(f,e,12e4)}}),d[b]=HandlebarsKB.compile(e)}return d[b](c)}function c(b){if(!e[b]){var c;a.ajax({url:b,method:"GET",async:!1,dataType:"html",success:function(a){c=a}}),e[b]=b}return e[b]}var d={},e={};return{render:b,helpfile:c}}(jQuery),KB.TinyMCE=function(a){return{removeEditors:function(){a(".wp-editor-area").each(function(){if("wp-content-wrap"===a(this).attr("id")||"ghosteditor"===a(this).attr("id"));else{var b=this.id;tinyMCE.execCommand("mceRemoveEditor",!0,b)}})},restoreEditors:function(){a(".wp-editor-wrap").each(function(){var b=a(this).find("textarea").attr("id"),c=a(this).find("textarea");"ghosteditor"!==b&&(c.val(switchEditors.wpautop(c.val())),tinyMCE.execCommand("mceAddEditor",!0,b),switchEditors.go(b,"tmce"))})},addEditor:function(b,c,d,e){if(!b)return _K.error("No scope element ($el) provided"),!1;if(_.isUndefined(tinyMCEPreInit))return!1;var f=d||350,g=_.isUndefined(e)?!0:!1;a(".wp-editor-area",b).each(function(){var a=this.id,b=_.clone(tinyMCEPreInit.mceInit.ghosteditor);b.elements=a,b.selector="#"+a,b.id=a,b.kblive=g,b.height=f,b.remove_linebreaks=!1,b.setup=function(a){a.on("init",function(){KB.Events.trigger("KB::tinymce.new-editor",a)}),a.on("change",function(){var b;a.module||(b=jQuery(a.editorContainer).closest(".kb-module"),a.module=KB.Views.Modules.get(b.attr("id"))),a.module.$el.trigger("tinymce.change")})},tinymce.init(b),tinyMCEPreInit.mceInit[a]||(tinyMCEPreInit.mceInit[a]=b);var c={buttons:"",disabled_buttons:"",id:a},d=jQuery("#qt_"+a+"_toolbar");d.length||new QTags(c)}),setTimeout(function(){a(".wp-editor-wrap",b).removeClass("html-active").addClass("tmce-active"),QTags._buttonsInit()},1500)},remoteGetEditor:function(a,b,c,d,e,f,g){var h=e||KB.appData.config.post.ID,c=c||a.attr("id");if(!f)var f=!1;var i=d||"";return KB.Ajax.send({action:"getRemoteEditor",editorId:c+"_ed",editorName:b,post_id:h,editorContent:i,_ajax_nonce:KB.Config.getNonce("read"),args:{media_buttons:f}},function(b){b.success?(a.empty().append(b.data.html),this.addEditor(a,null,150,g)):_K.info("Editor markup could not be retrieved from the server")},this)}}}(jQuery),KB.Ui=function(a){return{isSorting:!1,init:function(){var b=this,c=a("body");this.initTabs(),this.initSortable(),this.initToggleBoxes(),this.flexContext(),this.flushLocalStorage(),c.on("mousedown",".kb_field",function(){activeField=this}),c.on("mousedown",".kb-module",function(){activeBlock=this.id}),c.on("mouseenter",".kb-js-field-identifier",function(){KB.currentFieldId=this.id}),c.on("mouseenter",".kb-area__list-item li",function(){KB.currentModuleId=this.id}),jQuery(document).ajaxComplete(function(a,c,d){b.metaBoxReorder(a,c,d,"restore")}),jQuery(document).ajaxSend(function(a,c,d){b.metaBoxReorder(a,c,d,"remove")})},flexContext:function(){var b=a(".area-side"),c=a(".area-normal"),d=(a("#kontentblocks-core-ui"),this);jQuery("body").on("mouseover",".kb_module--body",function(){var b=a(this).closest(".kb-context-container");return b.addClass("active-context").removeClass("non-active-context"),b.hasClass("area-top")||b.hasClass("area-bottom")?!1:void a(".kb-context-container").not(b).addClass("non-active-context").removeClass("active-context")}),b.on("click",".kb-toggle",function(){return d.isSorting?!1:(b.addClass("active-context").removeClass("non-active-context"),void c.addClass("non-active-context"))}),b.on("mouseenter",".kb-open .kb-module__controls-inner",function(){b.hasClass("non-active-context")&&(b.addClass("active-context").removeClass("non-active-context"),c.addClass("non-active-context").removeClass("active-context"))}),c.on("mouseenter",".kb-open .kb-module__controls-inner",function(){c.hasClass("non-active-context")&&(c.addClass("active-context").removeClass("non-active-context"),b.addClass("non-active-context").removeClass("active-context"))}),c.on("click",".kb-toggle",function(){return d.isSorting?!1:(b.delay(700).removeClass("active-context").addClass("non-active-context"),void c.delay(700).removeClass("non-active-context").addClass("active-context"))})},repaint:function(a){this.initTabs(),this.initToggleBoxes(),KB.TinyMCE.addEditor(a)},initTabs:function(b){var c=b||jQuery("body"),d=a(".kb_fieldtabs",c);d.tabs({activate:function(){a(".kb-nano").nanoScroller({contentClass:"kb-nano-content"}),KB.Events.trigger("modal.recalibrate")}}),d.each(function(){var b=a(".ui-tabs-nav li",a(this)).length;1===b&&a(this).find(".ui-tabs-nav").css("display","none")})},initToggleBoxes:function(){a(".kb-togglebox-header").on("click",function(){a(this).next("div").slideToggle()}),a(".kb_fieldtoggles div:first-child").trigger("click")},initSortable:function(b){function c(){var a=f.get("limit"),b=d(f.get("id"));return-1===_.indexOf(f.get("assignedModules"),e.get("settings")["class"])?!1:0!==a&&b-1>=a?(KB.Notice.notice("Not allowed here","error"),!1):!0}function d(b){return a("#"+b+" li.kb-module").length}var e,f,g=b||jQuery("body"),h=this;a(".kb-module-ui__sortable",g).sortable({placeholder:"ui-state-highlight",ghost:!0,connectWith:".kb-module-ui__sortable--connect",handle:".kb-move",cancel:"li.disabled, li.cantsort",tolerance:"pointer",delay:150,revert:350,start:function(b,c){h.isSorting=!0,a("#kontentblocks-core-ui").addClass("kb-is-sorting"),e=KB.Modules.get(c.item.attr("id")),f=KB.currentArea,a(KB).trigger("kb:sortable::start"),a(".kb-open").toggleClass("kb-open"),a(".kb-module__body").hide(),KB.TinyMCE.removeEditors(),a(document).trigger("kb_sortable_start",[b,c])},stop:function(b,c){h.isSorting=!1,a("#kontentblocks-core-ui").removeClass("kb-is-sorting"),KB.TinyMCE.restoreEditors(),a(document).trigger("kb_sortable_stop",[b,c]),e.get("open")&&e.view.toggleBody(155)},over:function(){f=KB.Areas.get(this.id)},receive:function(b,d){c()||(KB.Notice.notice("Module not allowed in this area","error"),a(d.sender).sortable("cancel"))},update:function(b,d){if(!c())return!1;if(this!==d.item.parent("ul")[0]||d.sender){if(d.sender){if(d.item.parent("ul")[0].id===d.sender.attr("id"))return!1;a.when(h.changeArea(f,e)).then(function(a){return a.success?void h.resort(d.sender):!1}).done(function(){h.triggerAreaChange(f,e),a(KB).trigger("kb:sortable::update"),e.View.clearFields(),KB.Notice.notice("Area change and order were updated successfully","success")})}}else a.when(h.resort(d.sender)).done(function(b){return b.success?(a(KB).trigger("kb:sortable::update"),void KB.Notice.notice(b.message,"success")):(KB.Notice.notice(b.message,"error"),!1)})}})},flushLocalStorage:function(){var a=KB.Config.get("env").hash;store.get("kbhash")!==a&&(store.clear(),store.set("kbhash",a))},resort:function(){var b={};return a(".kb-module-ui__sortable").each(function(){b[this.id]=a("#"+this.id).sortable("serialize",{attribute:"rel"})}),KB.Ajax.send({action:"resortModules",data:b,_ajax_nonce:KB.Config.getNonce("update")})},changeArea:function(a,b){return KB.Ajax.send({action:"changeArea",_ajax_nonce:KB.Config.getNonce("update"),mid:b.get("instance_id"),area_id:a.get("id"),context:a.get("context")})},triggerAreaChange:function(a,b){b.unsubscribeFromArea(),b.setEnvVar("areaContext",a.get("context")),b.setEnvVar("area",a.get("id"))},toggleModule:function(){a("body").on("click",".kb-toggle",function(){KB.isLocked()&&!KB.userCan("lock_kontentblocks")?KB.notice(kontentblocks.l18n.gen_no_permission,"alert"):(a(this).parent().nextAll(".kb-module__body:first").slideToggle("fast",function(){a("body").trigger("module::opened")}),a("#"+activeBlock).toggleClass("kb-open",1e3))})},metaBoxReorder:function(b,c,d,e){if(d.data){var f=d.data,g=f.split("&"),h={};a.each(g,function(a,b){var c=b.split("=");h[c[0]]=c[1]}),"meta-box-order"===h.action&&("restore"===e?KB.TinyMCE.restoreEditors():"remove"===e&&KB.TinyMCE.removeEditors())}}}}(jQuery),KB.Ui.init(),KB.Util=function(){return{stex:{set:function(a,b,c){store.set(a,{val:b,exp:c,time:(new Date).getTime()})},get:function(a){var b=store.get(a);return b?(new Date).getTime()-b.time>b.exp?null:b.val:null}},setIndex:function(a,b,c){return"string"==typeof b?this.setIndex(a,b.split("."),c):1==b.length&&void 0!==c?a[b[0]]=c:0==b.length?a:this.setIndex(a[b[0]],b.slice(1),c)},getIndex:function(a,b){b=b.replace(/\[(\w+)\]/g,".$1"),b=b.replace(/^\./,"");for(var c=b.split(".");c.length;){var d=c.shift();if(!(d in a))return;a=a[d]}return a},cleanArray:function(a){for(var b=new Array,c=0;c<a.length;c++)_.isUndefined(a[c])||_.isEmpty(a[c])||b.push(a[c]);return b},sleep:function(a){for(var b=(new Date).getTime(),c=0;1e7>c&&!((new Date).getTime()-b>a);c++);}}}(jQuery),KB.ViewsCollection=function(){this.views={},this.lastViewAdded=null,this.add=function(a,b){return this.views[a]||(this.views[a]=b,KB.trigger("kb:"+b.model.get("class")+":added",b),this.trigger("view:add",b),this.lastViewAdded=b),b},this.ready=function(){_.each(this.views,function(a){a.trigger("kb:"+a.model.get("class"),a),KB.trigger("kb:"+a.model.get("class")+":loaded",a)}),KB.trigger("kb:ready")},this.readyOnFront=function(){_.each(this.views,function(a){a.trigger("kb:"+a.model.get("class"),a),KB.trigger("kb:"+a.model.get("class")+":loadedOnFront",a)}),KB.trigger("kb:ready")},this.remove=function(a){var b=this.get(a);b.model.Area.View.trigger("kb.module.deleted",b),this.trigger("kb.modules.view.deleted",b),delete this.views[a],b.dispose()},this.get=function(a){return this.views[a]?this.views[a]:void 0},this.filterByModelAttr=function(a,b){return _.filter(this.views,function(c){return c.model.get(a)===b})}},_.extend(KB.ViewsCollection.prototype,Backbone.Events),HandlebarsKB.registerHelper("debug",function(a){console.log("Current Context"),console.log("===================="),console.log(this),a&&(console.log("Value"),console.log("===================="),console.log(a))}),HandlebarsKB.registerHelper("fieldName",function(a,b,c){return a+"["+b+"]["+c+"]"}),HandlebarsKB.registerHelper("trimString",function(a,b){b=b||50;var c=a.length>b,d=a.substring(0,b);return c&&(d+="…"),new HandlebarsKB.SafeString(d)});