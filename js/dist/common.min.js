/*! kontentblocks 2014-03-03 */
var KB=KB||{};KB.Ajax=function(a){return{send:function(b,c,d){var e=KB.Screen&&KB.Screen.post_id?KB.Screen.post_id:!1,f=_.extend({supplemental:b.supplemental||{},count:parseInt(a("#kb_all_blocks").val(),10),nonce:a("#_kontentblocks_ajax_nonce").val(),post_id:e,kbajax:!0},b);return a("#publish").attr("disabled","disabled"),a.ajax({url:ajaxurl,data:f,type:"POST",dataType:"json",success:function(a){a&&(d&&c?c.call(d,a):c&&c(a))},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){a("#publish").removeAttr("disabled")}})}}}(jQuery);var KB=KB||{};KB.Checks=function(a){return{blockLimit:function(b){var c=b.get("limit"),d=a("#"+b.get("id")+" li.kb_block").length;return 0!==c&&d===c?(console.log("asdf"),!1):!0},userCan:function(b){var c=a.inArray(b,kontentblocks.caps);return-1!==c?!0:!1}}}(jQuery);var KB=KB||{};KB.Utils=KB.Utils||{},KB.Utils.MediaWorkflow=function(a){function b(){return f?f:(f=wp.media({title:"",button:{text:g.buttontext},multiple:!0,library:{type:"image"}}),f.on("ready",d),f.state("library").on("select",e),f)}function c(a){g=_.isUndefined(a)?_.extend(h,{}):_.extend(h,a),b().open()}function d(){}function e(){g.select===!1&&alert("No callbak given"),console.log(g.select),g.select(this)}var f,g,h={buttontext:"Buttontext",multiple:!1,type:"image",select:!1,ready:!1};c(a)},KB.Menus=function(a){return{loadingContainer:null,initiatorEl:null,sendButton:null,createSanitizedId:function(b,c){this.initiatorEl=a(b),this.loadingContainer=this.initiatorEl.closest(".kb-menu-field").addClass("loading"),this.$sendButton=a("#kb-submit"),this.disableSendButton(),KB.Ajax.send({inputvalue:b.value,checkmode:c,action:"getSanitizedId",_ajax_nonce:kontentblocks.nonces.read},this.insertId,this)},insertId:function(b){"translate"===b?(this.initiatorEl.addClass(),a(".kb-js-area-id").val("Please chose a different name")):(a(".kb-js-area-id").val(b),this.enableSendButton()),this.loadingContainer.removeClass("loading")},disableSendButton:function(){this.$sendButton.attr("disabled","disabled").val("Disabled")},enableSendButton:function(){this.$sendButton.attr("disabled",!1).val("Create")}}}(jQuery);var KB=KB||{};KB.Notice=function(){"use strict";return{notice:function(a,b){alertify.log(a,b,3500)},confirm:function(a,b,c){alertify.confirm(a,function(a){a?b():c()})}}}(jQuery);var KB=KB||{};KB.Templates=function(a){function b(b,c){if(!d[b]){var e=kontentblocks.config.url+"js/templates",f=e+"/"+b+".html",g=/^https?:\/\//i;g.test(b)&&(f=b);var h;a.ajax({url:f,method:"GET",async:!1,success:function(a){h=a}}),d[b]=_.template(h)}return d[b](c)}function c(b){if(!e[b]){var c;a.ajax({url:b,method:"GET",async:!1,dataType:"html",success:function(a){c=a}}),e[b]=b}return e[b]}var d={},e={};return{render:b,helpfile:c}}(jQuery);var KB=KB||{};KB.TinyMCE=function(a){return{removeEditors:function(){a(".wp-editor-area").each(function(){if("wp-content-wrap"===a(this).attr("id"));else{var b=this.id;console.log(b,"removeEd"),tinyMCE.execCommand("mceRemoveEditor",!1,b)}})},restoreEditors:function(){a(".wp-editor-wrap").each(function(){var b=tinyMCEPreInit.mceInit.content,c=a(this).find("textarea").attr("id");b.elements=c,b.selector="#"+c,b.id=c,b.height=350,b.setup=function(a){a.on("init",function(){jQuery(document).trigger("newEditor",a)})},tinymce.init(b)})},addEditor:function(b){var c=tinyMCEPreInit.mceInit.content;b||(b=KB.lastAddedModule.view.$el),a(".wp-editor-area",b).each(function(){var a=this.id;c.elements=a,c.selector="#"+a,c.id=a,c.height=350,c.setup=function(a){a.on("init",function(){jQuery(document).trigger("newEditor",a)})},tinymce.init(c);var b={buttons:"",disabled_buttons:"",id:a};new QTags(b)}),setTimeout(function(){a(".wp-editor-wrap",b).removeClass("html-active").addClass("tmce-active"),QTags._buttonsInit()},1500)},remoteGetEditor:function(a,b,c,d,e){var f=d||KB.Screen.post_id,g=a.attr("id");if(!e)var e=!1;KB.Ajax.send({action:"getRemoteEditor",editorId:g+"_ed",editorName:b,post_id:f,editorContent:c,_ajax_nonce:kontentblocks.nonces.read,args:{media_buttons:e}},function(b){a.empty().append(b),this.addEditor(a)},this)}}}(jQuery);var KB=KB||{};KB.Ui=function(a){return{isSorting:!1,init:function(){var b=this;this.initTabs(),this.initSortable(),this.initToggleBoxes(),this.flexContext(),a("body").on("mousedown",".kb_field",function(){activeField=this}),a("body").on("mousedown",".kb_block",function(){activeBlock=this.id}),jQuery(document).ajaxComplete(function(a,c,d){b.metaBoxReorder(a,c,d,"restore")}),jQuery(document).ajaxSend(function(a,c,d){b.metaBoxReorder(a,c,d,"remove")})},flexContext:function(){var b=a(".area-side"),c=a(".area-normal");a("#kontentblocks_stage");var d=this;jQuery(".kb_inner").on("mouseover",function(){var b=a(this).closest(".kb-context-container");return b.addClass("active-context").removeClass("non-active-context"),b.hasClass("area-top")||b.hasClass("area-bottom")?!1:(a(".kb-context-container").not(b).addClass("non-active-context").removeClass("active-context"),void 0)}),jQuery(".kb-toggle",b).click(function(){return d.isSorting?!1:(b.addClass("active-context").removeClass("non-active-context"),c.addClass("non-active-context"),void 0)}),jQuery(".kb-toggle",c).click(function(){return d.isSorting?!1:(b.delay(700).removeClass("active-context").addClass("non-active-context"),c.delay(700).removeClass("non-active-context").addClass("active-context"),void 0)})},repaint:function(a){this.initTabs(),this.initToggleBoxes(),KB.TinyMCE.addEditor(a)},initTabs:function(){a(".kb_fieldtabs").tabs({activate:function(){a(".nano").nanoScroller(),a("body").trigger("kontentblocks::tabsChange")}}),a(".kb_fieldtabs").each(function(){var b=a(".ui-tabs-nav li",a(this)).length;1===b&&a(this).find(".ui-tabs-nav").css("display","none")})},initToggleBoxes:function(){a(".kb-togglebox-header").on("click",function(){a(this).next("div").slideToggle().toggleClass("kb-toggle-open").end().toggleClass("kb-toggle-open")}),a(".kb_fieldtoggles div:first-child").trigger("click")},initSortable:function(){function b(){var a=e.get("limit"),b=c(e.get("id"));return-1===_.indexOf(e.get("assignedModules"),d.get("settings").class)?!1:0!==a&&b-1>=a?(KB.Notice.notice("Not allowed here","error"),!1):!0}function c(b){return a("#"+b+" li.kb_block").length}var d,e,f=this;a(".kb_sortable").sortable({placeholder:"ui-state-highlight",ghost:!0,connectWith:".kb_connect",handle:".kb-move",cancel:"li.disabled, li.cantsort",tolerance:"pointer",delay:150,revert:350,start:function(b,c){f.isSorting=!0,a("#kontentblocks_stage").addClass("kb-is-sorting"),d=KB.Modules.get(c.item.attr("id")),a(KB).trigger("kb:sortable::start"),a(".kb-open").toggleClass("kb-open"),a(".kb_inner").hide(),KB.TinyMCE.removeEditors(),a(document).trigger("kb_sortable_start",[b,c])},stop:function(b,c){f.isSorting=!1,a("#kontentblocks_stage").removeClass("kb-is-sorting"),KB.TinyMCE.restoreEditors(),a(document).trigger("kb_sortable_stop",[b,c]),d.get("open")&&d.view.toggleBody(155)},over:function(){e=KB.Areas.get(this.id)},receive:function(c,d){b()||(KB.Notice.notice("Module not allowed in this area","error"),a(d.sender).sortable("cancel"))},update:function(c,g){if(!b())return!1;if(this!==g.item.parent("ul")[0]||g.sender){if(g.sender){if(g.item.parent("ul")[0].id===g.sender.attr("id"))return!1;a.when(f.changeArea(e,d)).then(function(){f.resort(g.sender)}).done(function(){f.triggerAreaChange(e,d),a(KB).trigger("kb:sortable::update"),KB.Notice.notice("Area change and order were updated successfully","success")})}}else a.when(f.resort(g.sender)).done(function(){a(KB).trigger("kb:sortable::update"),KB.Notice.notice("Order was updated successfully","success")})}})},resort:function(){var b={};return a(".kb_sortable").each(function(){b[this.id]=a("#"+this.id).sortable("serialize",{attribute:"rel"})}),KB.Ajax.send({action:"resortModules",data:b,_ajax_nonce:kontentblocks.nonces.update})},changeArea:function(a,b){return KB.Ajax.send({action:"changeArea",block_id:b.get("instance_id"),area_id:a.get("id"),context:a.get("context")})},triggerAreaChange:function(a,b){b.set("areaContext",a.get("context")),b.set("area",a.get("id"))},toggleModule:function(){a("body").on("click",".kb-toggle",function(){KB.isLocked()&&!KB.userCan("lock_kontentblocks")?KB.notice(kontentblocks.l18n.gen_no_permission,"alert"):(a(this).parent().nextAll(".kb_inner:first").slideToggle("fast",function(){a("body").trigger("module::opened")}),a("#"+activeBlock).toggleClass("kb-open",1e3))})},metaBoxReorder:function(b,c,d,e){if(d.data){var f=d.data,g=f.split("&"),h={};a.each(g,function(a,b){var c=b.split("=");h[c[0]]=c[1]}),"meta-box-order"===h.action&&("restore"===e?KB.restore_tinymce():"remove"===e&&KB.remove_tinymce())}}}}(jQuery),KB.Ui.init();var KB=KB||{};KB.ViewsCollection=function(){this.views={},this.add=function(a,b){this.views[a]=b,this.trigger("kb:viewAdded",b)},this.remove=function(a){var b=this.get(a);this.trigger("kb:backend::viewDeleted",b),delete this.views[a]},this.get=function(a){return this.views[a]?this.views[a]:void 0},this.filterByModelAttr=function(a,b){return _.filter(this.views,function(c){return c.model.get(a)===b})}},_.extend(KB.ViewsCollection.prototype,Backbone.Events);var KB=KB||{};KB.Fields={},_.extend(KB.Fields,Backbone.Events),_.extend(KB.Fields,{fields:{},register:function(a,b){_.extend(b,Backbone.Events),this.fields[a]=b,b.hasOwnProperty("init")&&b.init(),b.listenTo(this,"update",b.update)},get:function(a){return this.fields[a]?this.fields[a]:null}});