/*! Kontentblocks ProdVersion 2014-09-05 12:09 */
var KB=KB||{};KB.Config={},KB.Backbone={},KB.Fields={},KB.Utils={},KB.Ext={},KB.OSConfig={},KB.IEdit={},KB.Events={},_.extend(KB,Backbone.Events),_.extend(KB.Events,Backbone.Events),KB.Config=function(){var config=KB.appData.config;return{get:function(key){return key?config[key]?config[key]:null:config},getNonce:function(mode){var modes=["update","create","delete","read"];return-1!==_.indexOf(modes,mode)?config.nonces[mode]:(_K.error("Invalid nonce requested in kb.cm.Config.js"),null)},inDevMode:function(){return config.env.dev},getRootURL:function(){return config.env.url},getHash:function(){return config.env.hash}}}(jQuery),KB.Ajax=function($){return{send:function(data,callback,scope){var pid=KB.Screen&&KB.Screen.post_id?KB.Screen.post_id:!1,sned=_.extend({supplemental:data.supplemental||{},count:parseInt($("#kb_all_blocks").val(),10),nonce:$("#_kontentblocks_ajax_nonce").val(),post_id:pid,kbajax:!0},data);return $("#publish").attr("disabled","disabled"),$.ajax({url:ajaxurl,data:sned,type:"POST",dataType:"json",success:function(data){data&&(scope&&callback?callback.call(scope,data):callback&&callback(data))},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){$("#publish").removeAttr("disabled")}})}}}(jQuery),KB.Checks=function($){return{blockLimit:function(areamodel){var limit=areamodel.get("limit"),children=$("#"+areamodel.get("id")+" li.kb-module").length;return 0!==limit&&children===limit?!1:!0},userCan:function(cap){var check=$.inArray(cap,KB.Config.get("caps"));return-1!==check}}}(jQuery),_.extend(KB.Fields,Backbone.Events),_.extend(KB.Fields,{fields:{},addEvent:function(){this.listenTo(KB,"kb:ready",this.init),this.listenTo(this,"newModule",this.newModule)},register:function(id,object){_.extend(object,Backbone.Events),this.fields[id]=object},init:function(){var that=this;_.each(_.toArray(this.fields),function(object){object.hasOwnProperty("init")&&object.init(),object.listenTo(that,"update",object.update),object.listenTo(that,"frontUpdate",object.frontUpdate)})},newModule:function(object){_K.info("new Module added for Fields");var that=this;object.listenTo(this,"update",object.update),object.listenTo(this,"frontUpdate",object.frontUpdate),setTimeout(function(){that.trigger("update")},750)},get:function(id){return this.fields[id]?this.fields[id]:null}}),KB.Fields.addEvent(),Logger.useDefaults();var _K=Logger.get("_K");_K.setLevel(_K.INFO),KB.Config.inDevMode()||_K.setLevel(Logger.OFF),KB.Utils.MediaWorkflow=function(args){function frame(){return _frame?_frame:(_frame=wp.media({title:options.title,button:{text:options.buttontext},multiple:options.multiple,library:{type:options.type}}),_frame.on("ready",ready),_frame.state("library").on("select",select),_frame)}function init(args){options=_.isUndefined(args)?_.extend(defaults,{}):_.extend(defaults,args),frame().open()}function ready(){}function select(){options.select===!1&&alert("No callback given"),options.select(this)}var _frame,options,defaults={buttontext:"Buttontext",multiple:!1,type:"image",title:"",select:!1,ready:!1};init(args)},KB.Menus=function($){return{loadingContainer:null,initiatorEl:null,sendButton:null,createSanitizedId:function(el,mode){this.initiatorEl=$(el),this.loadingContainer=this.initiatorEl.closest(".kb-menu-field").addClass("loading"),this.$sendButton=$("#kb-submit"),this.disableSendButton(),KB.Ajax.send({inputvalue:el.value,checkmode:mode,action:"getSanitizedId",_ajax_nonce:KB.Config.getNonce("read")},this.insertId,this)},insertId:function(res){"translate"===res?(this.initiatorEl.addClass(),$(".kb-js-area-id").val("Please chose a different name")):($(".kb-js-area-id").val(res),this.enableSendButton()),this.loadingContainer.removeClass("loading")},disableSendButton:function(){this.$sendButton.attr("disabled","disabled").val("Disabled")},enableSendButton:function(){this.$sendButton.attr("disabled",!1).val("Create")}}}(jQuery),KB.Notice=function(){"use strict";return{notice:function(msg,type){alertify.log(msg,type,3500)},confirm:function(msg,yes,no){alertify.confirm(msg,function(e){e?yes():no()})}}}(jQuery),KB.Payload=function(){return{getFieldData:function(type,moduleId,key,arrayKey){var typeData;return this._typeExists(type)?(typeData=KB.payload.fieldData[type],typeData[moduleId]?_.isEmpty(arrayKey)?typeData[moduleId][key]?typeData[moduleId][key]:[]:typeData[moduleId][arrayKey]?typeData[moduleId][arrayKey][key]?typeData[moduleId][arrayKey][key]:[]:[]:[]):[]},_typeExists:function(type){return!_.isUndefined(KB.payload.fieldData[type])},getFieldArgs:function(id,key){return KB.payload.Fields&&KB.payload.Fields[id]?key&&KB.payload.Fields[id][key]?KB.payload.Fields[id][key]:KB.payload.Fields[id]:null}}}(jQuery),KB.Templates=function($){function render(tmpl_name,tmpl_data){var tmpl_string;if(!tmpl_cache[tmpl_name]){var tmpl_dir=KB.Config.getRootURL()+"js/templates",tmpl_url=tmpl_dir+"/"+tmpl_name+".hbs?"+KB.Config.getHash(),pat=/^https?:\/\//i;pat.test(tmpl_name)&&(tmpl_url=tmpl_name),KB.Util.stex.get(tmpl_url)?tmpl_string=KB.Util.stex.get(tmpl_url):$.ajax({url:tmpl_url,method:"GET",async:!1,success:function(data){tmpl_string=data,KB.Util.stex.set(tmpl_url,tmpl_string,12e4)}}),tmpl_cache[tmpl_name]=HandlebarsKB.compile(tmpl_string)}return tmpl_cache[tmpl_name](tmpl_data)}function helpfile(hlpf_url){if(!hlpf_cache[hlpf_url]){var hlpf_string;$.ajax({url:hlpf_url,method:"GET",async:!1,dataType:"html",success:function(data){hlpf_string=data}}),hlpf_cache[hlpf_url]=hlpf_url}return hlpf_cache[hlpf_url]}var tmpl_cache={},hlpf_cache={};return{render:render,helpfile:helpfile}}(jQuery),KB.TinyMCE=function($){return{removeEditors:function(){$(".wp-editor-area").each(function(){if("wp-content-wrap"===$(this).attr("id"));else{var textarea=this.id;tinyMCE.execCommand("mceRemoveEditor",!1,textarea)}})},restoreEditors:function(){$(".wp-editor-wrap").each(function(){var settings=tinyMCEPreInit.mceInit.content,id=$(this).find("textarea").attr("id");settings.elements=id,settings.selector="#"+id,settings.id=id,settings.height=350,settings.setup=function(ed){ed.on("init",function(){KB.Events.trigger("KB::tinymce.new-editor",ed)}),ed.on("change",function(){var $module;ed.module||($module=jQuery(ed.editorContainer).closest(".kb-module"),ed.module=KB.Views.Modules.get($module.attr("id"))),ed.module.$el.trigger("tinymce.change")})},tinymce.init(settings)})},addEditor:function($el,quicktags,height,watch){var settings=tinyMCEPreInit.mceInit.content,edHeight=height||350,live=_.isUndefined(watch)?!0:!1;$el||($el=KB.lastAddedModule.view.$el),$(".wp-editor-area",$el).each(function(){var id=this.id;settings.elements=id,settings.selector="#"+id,settings.id=id,settings.kblive=live,settings.height=edHeight,settings.setup=function(ed){ed.on("init",function(){KB.Events.trigger("KB::tinymce.new-editor",ed)}),ed.on("change",function(){var $module;ed.module||($module=jQuery(ed.editorContainer).closest(".kb-module"),ed.module=KB.Views.Modules.get($module.attr("id"))),ed.module.$el.trigger("tinymce.change")})},tinymce.init(settings),tinyMCEPreInit.mceInit[id]||(tinyMCEPreInit.mceInit[id]=settings);var qtsettings={buttons:"",disabled_buttons:"",id:id},qts=jQuery("#qt_"+id+"_toolbar");qts.length||new QTags(qtsettings)}),setTimeout(function(){$(".wp-editor-wrap",$el).removeClass("html-active").addClass("tmce-active"),QTags._buttonsInit()},1500)},remoteGetEditor:function($el,name,id,content,post_id,media,watch){var pid=post_id||KB.appData.config.post.ID,id=id||$el.attr("id");if(!media)var media=!1;var editorContent=content||"";return KB.Ajax.send({action:"getRemoteEditor",editorId:id+"_ed",editorName:name,post_id:pid,editorContent:editorContent,_ajax_nonce:KB.Config.getNonce("read"),args:{media_buttons:media}},function(data){$el.empty().append(data),this.addEditor($el,null,150,watch)},this)}}}(jQuery),KB.Ui=function($){return{isSorting:!1,init:function(){var that=this,$body=$("body");this.initTabs(),this.initSortable(),this.initToggleBoxes(),this.flexContext(),this.flushLocalStorage(),$body.on("mousedown",".kb_field",function(){activeField=this}),$body.on("mousedown",".kb-module",function(){activeBlock=this.id}),$body.on("mouseenter",".kb-js-field-identifier",function(){KB.currentFieldId=this.id,_K.info("Current Field Id set to:",KB.currentFieldId)}),$body.on("mouseenter",".kb-area__list-item li",function(){KB.currentModuleId=this.id}),jQuery(document).ajaxComplete(function(e,o,settings){that.metaBoxReorder(e,o,settings,"restore")}),jQuery(document).ajaxSend(function(e,o,settings){that.metaBoxReorder(e,o,settings,"remove")})},flexContext:function(){var side=$(".area-side"),normal=$(".area-normal");$("#kontentblocks_stage");var that=this;jQuery("body").on("mouseover",".kb_module--body",function(){var $con=$(this).closest(".kb-context-container");return $con.addClass("active-context").removeClass("non-active-context"),$con.hasClass("area-top")||$con.hasClass("area-bottom")?!1:($(".kb-context-container").not($con).addClass("non-active-context").removeClass("active-context"),void 0)}),side.on("click",".kb-toggle",function(){return that.isSorting?!1:(side.addClass("active-context").removeClass("non-active-context"),normal.addClass("non-active-context"),void 0)}),normal.on("click",".kb-toggle",function(){return that.isSorting?!1:(side.delay(700).removeClass("active-context").addClass("non-active-context"),normal.delay(700).removeClass("non-active-context").addClass("active-context"),void 0)})},repaint:function($el){this.initTabs(),this.initToggleBoxes(),KB.TinyMCE.addEditor($el)},initTabs:function($cntxt){var $context=$cntxt||jQuery("body"),selector=$(".kb_fieldtabs",$context);selector.tabs({activate:function(){$(".nano").nanoScroller(),KB.Events.trigger("KB::ui-tabs-change"),KB.Events.trigger("KB::edit-modal-refresh")}}),selector.each(function(){var length=$(".ui-tabs-nav li",$(this)).length;1===length&&$(this).find(".ui-tabs-nav").css("display","none")})},initToggleBoxes:function(){$(".kb-togglebox-header").on("click",function(){console.log("cliky"),$(this).next("div").slideToggle()}),$(".kb_fieldtoggles div:first-child").trigger("click")},initSortable:function($cntxt){function isValidModule(){var limit=areaOver.get("limit"),nom=numberOfModulesInArea(areaOver.get("id"));return-1===_.indexOf(areaOver.get("assignedModules"),currentModule.get("settings").class)?!1:0!==limit&&nom-1>=limit?(KB.Notice.notice("Not allowed here","error"),!1):!0}function numberOfModulesInArea(id){return $("#"+id+" li.kb-module").length}var currentModule,areaOver,$context=$cntxt||jQuery("body"),that=this;$(".kb-module-ui__sortable",$context).sortable({placeholder:"ui-state-highlight",ghost:!0,connectWith:".kb-module-ui__sortable--connect",handle:".kb-move",cancel:"li.disabled, li.cantsort",tolerance:"pointer",delay:150,revert:350,start:function(event,ui){that.isSorting=!0,$("#kontentblocks_stage").addClass("kb-is-sorting"),currentModule=KB.Modules.get(ui.item.attr("id")),areaOver=KB.currentArea,$(KB).trigger("kb:sortable::start"),$(".kb-open").toggleClass("kb-open"),$(".kb-module__body").hide(),KB.TinyMCE.removeEditors(),$(document).trigger("kb_sortable_start",[event,ui])},stop:function(event,ui){that.isSorting=!1,$("#kontentblocks_stage").removeClass("kb-is-sorting"),KB.TinyMCE.restoreEditors(),$(document).trigger("kb_sortable_stop",[event,ui]),currentModule.get("open")&&currentModule.view.toggleBody(155)},over:function(){areaOver=KB.Areas.get(this.id)},receive:function(event,ui){isValidModule()||(KB.Notice.notice("Module not allowed in this area","error"),$(ui.sender).sortable("cancel"))},update:function(ev,ui){if(!isValidModule())return!1;if(this!==ui.item.parent("ul")[0]||ui.sender){if(ui.sender){if(ui.item.parent("ul")[0].id===ui.sender.attr("id"))return!1;$.when(that.changeArea(areaOver,currentModule)).then(function(){that.resort(ui.sender)}).done(function(){that.triggerAreaChange(areaOver,currentModule),$(KB).trigger("kb:sortable::update"),currentModule.view.clearFields(),KB.Notice.notice("Area change and order were updated successfully","success")})}}else $.when(that.resort(ui.sender)).done(function(){$(KB).trigger("kb:sortable::update"),KB.Notice.notice("Order was updated successfully","success")})}})},flushLocalStorage:function(){var hash=KB.Config.get("env").hash;store.get("kbhash")!==hash&&(store.clear(),store.set("kbhash",hash))},resort:function(){var serializedData={};return $(".kb-module-ui__sortable").each(function(){serializedData[this.id]=$("#"+this.id).sortable("serialize",{attribute:"rel"})}),KB.Ajax.send({action:"resortModules",data:serializedData,_ajax_nonce:KB.Config.getNonce("update")})},changeArea:function(targetArea,module){return KB.Ajax.send({action:"changeArea",_ajax_nonce:KB.Config.getNonce("update"),block_id:module.get("instance_id"),area_id:targetArea.get("id"),context:targetArea.get("context")})},triggerAreaChange:function(newArea,module){module.set("areaContext",newArea.get("context")),module.set("area",newArea.get("id"))},toggleModule:function(){$("body").on("click",".kb-toggle",function(){KB.isLocked()&&!KB.userCan("lock_kontentblocks")?KB.notice(kontentblocks.l18n.gen_no_permission,"alert"):($(this).parent().nextAll(".kb-module__body:first").slideToggle("fast",function(){$("body").trigger("module::opened")}),$("#"+activeBlock).toggleClass("kb-open",1e3))})},metaBoxReorder:function(e,o,settings,action){if(settings.data){var a=settings.data,b=a.split("&"),result={};$.each(b,function(x,y){var temp=y.split("=");result[temp[0]]=temp[1]}),"meta-box-order"===result.action&&("restore"===action?KB.TinyMCE.restoreEditors():"remove"===action&&KB.TinyMCE.removeEditors())}}}}(jQuery),KB.Ui.init(),KB.Util=function(){return{stex:{set:function(key,val,exp){store.set(key,{val:val,exp:exp,time:(new Date).getTime()})},get:function(key){var info=store.get(key);return info?(new Date).getTime()-info.time>info.exp?null:info.val:null}},setIndex:function(obj,is,value){return"string"==typeof is?this.setIndex(obj,is.split("."),value):1==is.length&&void 0!==value?obj[is[0]]=value:0==is.length?obj:this.setIndex(obj[is[0]],is.slice(1),value)},getIndex:function(obj,s){s=s.replace(/\[(\w+)\]/g,".$1"),s=s.replace(/^\./,"");for(var a=s.split(".");a.length;){var n=a.shift();if(!(n in obj))return;obj=obj[n]}return obj},cleanArray:function(actual){for(var newArray=new Array,i=0;i<actual.length;i++)_.isUndefined(actual[i])||_.isEmpty(actual[i])||newArray.push(actual[i]);return newArray}}}(jQuery),KB.ViewsCollection=function(){this.views={},this.lastViewAdded=null,this.add=function(id,view){return this.views[id]||(this.views[id]=view,KB.trigger("kb:"+view.model.get("class")+":added",view),this.lastViewAdded=view),view},this.ready=function(){_.each(this.views,function(view){view.trigger("kb:"+view.model.get("class"),view),KB.trigger("kb:"+view.model.get("class")+":loaded",view)}),KB.trigger("kb:ready")},this.readyOnFront=function(){_.each(this.views,function(view){view.trigger("kb:"+view.model.get("class"),view),KB.trigger("kb:"+view.model.get("class")+":loadedOnFront",view)}),KB.trigger("kb:ready")},this.remove=function(id){var view=this.get(id);this.trigger("KB::backend.module.view.deleted",view),delete this.views[id]},this.get=function(id){return this.views[id]?this.views[id]:void 0},this.filterByModelAttr=function(attr,value){return _.filter(this.views,function(view){return view.model.get(attr)===value})}},_.extend(KB.ViewsCollection.prototype,Backbone.Events),HandlebarsKB.registerHelper("debug",function(optionalValue){console.log("Current Context"),console.log("===================="),console.log(this),optionalValue&&(console.log("Value"),console.log("===================="),console.log(optionalValue))}),HandlebarsKB.registerHelper("fieldName",function(base,index,key){return base+"["+index+"]["+key+"]"});