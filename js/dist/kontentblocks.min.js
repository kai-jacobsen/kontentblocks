/*! kontentblocks 2013-10-21 */
var latestBlock,activeBlock,activeArea,activeField,kbMetaBox,KB=KB||{};!function(a){_.extend(KB,{duplicate:!1,postContext:!0,openedModal:!1,init:function(){vex.defaultOptions.className="vex-theme-flat-attack",kbMetaBox=a("#kontentblocks_stage"),a(".kb_fieldtabs")&&KB.ktftabs(),a(".area-blocks-menu-tabs")&&KB.menutabs(),a(".reveal-modal").bind("reveal:opened",function(){KB.openedModal=a(this)}),jQuery("#submit").mousedown(function(){tinyMCE.triggerSave()}),KB.titleToggle(),KB.userCan("sort_kontentblocks")&&KB.kbSortable(),a(kbMetaBox).on("click",".kb_delete_block",function(){KB.isDisabled()?KB.notice(kontentblocks.l18n.block_disabled_delete,"alert"):KB.blockDelete()}),a(kbMetaBox).on("click",".modules-link",function(b){b.preventDefault(),activeArea=a(this).attr("data-area"),openedModal=vex.open({content:a("#"+activeArea+"-nav").html(),afterOpen:function(){KB.menutabs(),a("#"+activeArea+"-nav")},contentClassName:"modules-menu"})}),a(kbMetaBox).on("click",".kb-duplicate",function(){KB.duplicateBlock()}),a(kbMetaBox).on("click",".kb_set_status",function(){$caller=a(this),KB.isDisabled()?KB.notice(kontentblocks.l18n.block_disabled_delete,"alert"):KB.blockStatus($caller)}),a(kbMetaBox).on("click",".kb-lock",function(b){$caller=a(this),b.preventDefault(),KB.userCan("lock_kontentblocks")?KB.blockLock($caller):KB.userCan("lock_kontentblocks")||KB.notice(kontentblocks.l18n.sec_no_permission,"alert")}),jQuery(document).ajaxComplete(function(a,b,c){KB.metaBoxReorder(a,b,c,"restore")}),jQuery(document).ajaxSend(function(a,b,c){KB.metaBoxReorder(a,b,c,"remove")}),a(kbMetaBox).on("mousedown",".wp-editor-wrap",function(){wpActiveEditor=this.id.slice(3,-5)}),a(kbMetaBox).on("mousedown",".quicktags",function(){wpActiveEditor=a(this).find("textarea").attr("id")}),a("body").on("mousedown",".kb_block",function(){activeBlock=this.id}),a("body").on("mousedown",".kb_field",function(){activeField=this}),a(".kb_area_list_item").mousedown(function(){activeArea=this.id}),a(kbMetaBox).on("change",".kb_field input, .kb_field select, .kb_field textarea",function(){$notice=a(this).closest(".kb_inner").find(".block-notice"),a(window).trigger("input:change"),a($notice).fadeIn(750)}),a("body").on("click",".media-modal-close, .media-modal-backdrop",function(){a("body").trigger("modal-close")}),a(document).on("keyup",function(b){27===b.which&&a("body").trigger("modal-close")})},menutabs:function(){a(".area-blocks-menu-tabs").tabs({show:function(){}})},ktftabs:function(){if(a(".kb_fieldtabs")){var b=a(".kb_fieldtabs li").length;a(".kb_fieldtabs").tabs({activate:function(){$window=a(window).height(),a(".nano").nanoScroller()}}),a(".kb_fieldtabs").each(function(){1===b&&a(this).find(".ui-tabs-nav").css("display","none")})}a(document).on("kb_block_added",function(){a(".kb_fieldtabs")&&a(".kb_fieldtabs").tabs()})},titleToggle:function(){a(kbMetaBox).on("click",".kb-toggle",function(){KB.isLocked()&&!KB.userCan("lock_kontentblocks")?KB.notice(kontentblocks.l18n.gen_no_permission,"alert"):(a(this).parent().nextAll(".kb_inner:first").slideToggle("fast",function(){a("body").trigger("module::opened")}),a("#"+activeBlock).toggleClass("kb-open",1e3))}),a(" .kb_inner").hide()},initChzn:function(){},tinymce:function(b,c){var d=tinyMCEPreInit.mceInit.content;d.elements=b,tinyMCEPreInit.mceInit[b]=d,qtsettings={buttons:"",disabled_buttons:"",id:b},tinyMCEPreInit.qtInit[b]=qtsettings,ed=new tinymce.Editor(b,d),ed.render(),new QTags(qtsettings),setTimeout(function(){a(c).removeClass("html-active").addClass("tmce-active"),QTags._buttonsInit()},1500)},remove_tinymce:function(){return"undefined"==typeof tinyMCE?!1:(a(".wp-editor-wrap").each(function(){"wp-content-wrap"===a(this).attr("id")||(textarea=jQuery(this).find("textarea").attr("id"),tinyMCE.execCommand("mceRemoveControl",!1,textarea))}),void 0)},restore_tinymce:function(){return"undefined"==typeof tinyMCE?!1:(jQuery("#kontentblocks_stage .wp-editor-wrap").each(function(){textarea=jQuery(this).find("textarea").attr("id"),tinyMCE.execCommand("mceAddControl",!1,textarea),a(this).hasClass("html-active")&&a(this).removeClass("html-active").addClass("tmce-active")}),void 0)},resort:function(){var a=jQuery("#post_ID").val();data={},jQuery(".kb_sortable").each(function(){data[this.id]=jQuery("#"+this.id).sortable("serialize",{attribute:"rel"})}),KB.ajax({action:"resortModules",data:data,post_id:a},function(){KB.notice(kontentblocks.l18n.block_resorting)})},notice:function(a,b){noty({text:a,layout:"topRight",type:b,textAlign:"center",easing:"swing",animateOpen:{opacity:"toggle"},animateClose:{opacity:"toggle"},speed:"750",timeout:"2500",closable:!0,closeOnSelfClick:!0})},confirm:function(a,b,c){noty({text:a,speed:"350",modal:!0,layout:"center",buttons:[{type:"button green",text:"Ok",click:function(){"function"==typeof b&&b()}},{type:"button pink",text:"Cancel",click:function(){"function"==typeof c&&c()}}],closable:!1,timeout:!1})},alert:function(a,b){noty({text:a,speed:"350",modal:!0,layout:"center",buttons:[{type:"button green",text:"Ok",click:function(){"function"==typeof b&&b()}}],closable:!1,timeout:!1})},ajax:function(b,c){nonce=a("#_kontentblocks_ajax_nonce").val(),post_id=a("#post_ID").val(),b._kb_nonce=nonce,b.post_id=post_id,b.kbajax="true",a(kbMetaBox).addClass("kb_loading"),a("#publish").attr("disabled","disabled"),a.ajax({url:ajaxurl,data:b,type:"POST",dataType:"json",success:function(a){"nonce unset"==a?(KB.notice(kontentblocks.l18n.sec_nonce_failed,"error"),c(!1)):"wrong nonce"==a?(KB.notice(kontentblocks.l18n.sec_nonce_failed,"error"),c(!1)):c(a)},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){a(kbMetaBox).removeClass("kb_loading"),a("#publish").removeAttr("disabled")}})},metaBoxReorder:function(b,c,d,e){if(d.data){var f=d.data,g=f.split("&"),h={};a.each(g,function(a,b){var c=b.split("=");h[c[0]]=c[1]}),"meta-box-order"===h.action&&("restore"===e?KB.restore_tinymce():"remove"===e&&KB.remove_tinymce())}},kbSortable:function(){a(".kb_sortable").sortable({placeholder:"ui-state-highlight",ghost:!0,connectWith:".kb_connect",handle:".kb-move",cancel:"li.disabled, li.cantsort",start:function(b,c){a(c.item).find(".kb_inner").hide(),a(".kb-open").toggleClass("kb-open"),a(".kb_inner").hide(),KB.remove_tinymce(),a(document).trigger("kb_sortable_start",[b,c])},stop:function(b,c){KB.restore_tinymce(),a(document).trigger("kb_sortable_stop",[b,c])},over:function(b,c){var d=this.id,e=a("#"+d).attr("data-blacklist");blackblocks=""!==e?e.split(" "):{},itemclass=c.item[0].dataset.blockclass,blacklisted=a.inArray(itemclass,blackblocks),-1===blacklisted?console.log("line 544:"+c.helper):console.log("line 548:"+c.helper)},receive:function(b,c){var d=this.id,e=activeBlock,f=a("#"+d).attr("data-limit"),g=a("#"+d+" .kb_block").length,h=a("#"+d).attr("data-blacklist");blackblocks=""!==h?h.split(" "):{},itemclass=c.item[0].dataset.blockclass,blacklisted=a.inArray(itemclass,blackblocks),-1===blacklisted?KB.alert(kontentblocks.l18n.area_block_not_allowed,function(){a(c.sender).sortable("cancel")}):"0"!==f&&g>f?KB.alert(kontentblocks.l18n.area_sort_full,function(){a(c.sender).sortable("cancel")}):KB.ajax({action:"changeArea",block_id:e,area_id:d},function(b){return 0==b?(a(c.sender).sortable("cancel"),void 0):(KB.notice("Area change saved","alert"),KB.resort(),void 0)})},update:function(a,b){data={},jQuery(".kb_sortable").each(function(){data[this.id]=jQuery("#"+this.id).sortable("serialize",{attribute:"rel"})}),this!==b.item.parent("ul")[0]||b.sender?b.sender:KB.resort()}})},duplicateBlock:function(){KB.confirm(kontentblocks.l18n.block_duplicate,function(){KB.duplicate=activeBlock,KB.blockCreate(a("#"+activeBlock))},function(){KB.notice(kontentblocks.l18n.block_duplicate_success)})},blockCreate:function(b){var c={};if(c.type=a(b).attr("data-value")?a(b).attr("data-value"):a(b).attr("data-blockclass"),c.template=a(b).attr("data-instance_id")?a(b).attr("data-instance_id"):!1,c.master=a(b).attr("data-master")?!0:!1,c.page_template=a("#"+activeArea).attr("data-page_template"),c.post_type=a("#"+activeArea).attr("data-post_type")?a("#"+activeArea).attr("data-post_type"):!1,c.post_id=a("#post_ID").val(),c.count=a("#kb_all_blocks").val(),c.duplicate=KB.duplicate,c.area=activeArea,c.context=a("#"+activeArea).attr("data-context"),list_limit=a("#"+activeArea).attr("data-limit"),list_children=a("#"+activeArea+" li.kb_block").length,0!==list_limit&&list_children===list_limit)return KB.alert(kontentblocks.l18n.area_create_full),!1;a(this).parent().fadeOut("fast");var d=a(b).closest(".kb_area_head").find(".kb-ajax-status");a(d).show(),KB.ajax({action:"kb_generate_blocks",data:c},function(b){KB.duplicate=!1,result=b,a("#"+activeArea).append(result.html),a(d).hide(),latestBlock=result.id,c.count=parseInt(c.count)+1,a("#kb_all_blocks").val(c.count),a(".kb_properties_title").nextAll(".kb_properties").hide(),textareas=jQuery("#"+latestBlock).find(".wp-editor-wrap textarea"),a(textareas).each(function(){var b=a(this).closest(".wp-editor-wrap"),c=a(this).attr("id");KB.tinymce(c,b)}),a(document).trigger("kb_block_added")})},blockDelete:function(){KB.confirm(kontentblocks.l18n.block_delete,function(){a("#"+activeBlock+" .kb-ajax-status").show();var b=activeBlock;KB.ajax({action:"removeModules",block_id:b},function(b){1==b?KB.notice(kontentblocks.l18n.block_deleted_and_data,"alert"):0==b?KB.notice(kontentblocks.l18n.block_delete_error,"error"):2==b&&KB.notice(kontentblocks.l18n.block_deleted,"alert"),a("#"+activeBlock).slideUp(350,function(){a(this).remove()})})},function(){KB.notice("Allright, lets keep it then")})},blockStatus:function(b){a("#"+activeBlock+" .kb-ajax-status").show();var c=a(b),d=activeBlock;KB.ajax({action:"changeModuleStatus",block_id:d},function(b){return 0==b?(a(".kb-ajax-status").hide(),void 0):(1==b?KB.notice(kontentblocks.l18n.block_deactivated,"alert"):2==b&&KB.notice(kontentblocks.l18n.block_reactivated,"alert"),a("#"+activeBlock).toggleClass("kb_inactive"),a(c).toggleClass("kb_inactive"),a(".kb-ajax-status").hide(),void 0)})},blockLock:function(b){a("#"+activeBlock+" .kb-ajax-status").show();var c=a(b),d=activeBlock;KB.ajax({action:"kb_lock_block",block_id:d},function(b){return 0==b?(a(".kb-ajax-status").hide(),void 0):(1==b?KB.notice(kontentblocks.l18n.block_locked,"alert"):2==b&&KB.notice(kontentblocks.l18n.block_unlocked,"alert"),a("#"+activeBlock).toggleClass("locked"),c.hasClass("locked")?(c.removeClass("locked"),c.addClass("unlocked")):(c.removeClass("unlocked"),c.addClass("locked")),a("#"+activeBlock).hasClass("kb-open")&&(a("#"+activeBlock).find(".kb_inner").slideToggle("fast"),a("#"+activeBlock).removeClass("kb-open")),a(".kb-ajax-status").hide(),void 0)})},validateForm:function(b){return!a(b).find(".form-required").filter(function(){return""==a("input:visible",this).val()}).addClass("form-invalid").find("input:visible").change(function(){a(this).closest(".form-invalid").removeClass("form-invalid")}).size()},userCan:function(b){return check=a.inArray(b,kontentblocks.caps),-1!=check?!0:!1},isLocked:function(){return a("#"+activeBlock).hasClass("locked")},isDisabled:function(){return a("#"+activeBlock).hasClass("disabled")}})}(jQuery),jQuery(document).ready(function(a){KB.init(),a("#stage-inner").delegate(".kb_save_area","click",function(b){b.preventDefault();var c=a(this).prevAll("select:first").val(),d=a(this).closest(".kb_block").attr("id");a.post(ajaxurl,{action:"kb_save_area",block_id:d,area_id:c},function(b){area_meta=a("#"+d+" .area-meta"),a(area_meta).fadeTo(500,0,function(){a(this).empty(),a(this).append(b).fadeTo(500,1)})})});var b=!1;a("body").on("click",".kb_dd_menu",function(b){b.preventDefault(),b.target==this&&(menus=a(".kb_open"),a(menus).each(function(){a(this).hasClass("kb_open")&&a(this).fadeOut("fast").toggleClass("kb_open")}),menu=a(this).parent().find(".kb_dd_list"),a(menu).slideToggle("fast").toggleClass("kb_open"))}),a(".kb_dd_menu, .kb_dd_list").hover(function(){b=!0},function(){b=!1}),a("body").mouseup(function(){0==b&&(menus=a(".kb_open"),a(menus).each(function(){a(this).hasClass("kb_open")&&a(this).fadeOut("fast").toggleClass("kb_open")}))}),a(".kb_area_head").mousedown(function(){activeArea=a(this).next().attr("id")}),a("body").on("click",".blocks-menu li",function(){caller=a(this),KB.userCan("create_kontentblocks")?(vex.close(openedModal.data().vex.id),KB.blockCreate(caller),menus=a(".kb_open"),a(menus).each(function(){a(this).hasClass("kb_open")&&a(this).fadeOut("fast").toggleClass("kb_open")})):KB.notice(kontentblocks.l18n.sec_no_permission,"alert")})});