/*! kontentblocks 2013-12-22 */
var KB,latestBlock,activeBlock,activeArea,activeField,kbMetaBox;!function($){_.extend(KB,{duplicate:!1,postContext:!0,openedModal:!1,init:function(){vex.defaultOptions.className="vex-theme-flat-attack",kbMetaBox=$("#kontentblocks_stage"),$(".kb_fieldtabs")&&KB.ktftabs(),$(".area-blocks-menu-tabs")&&KB.menutabs(),$(".reveal-modal").bind("reveal:opened",function(){KB.openedModal=$(this)}),jQuery("#submit").mousedown(function(){tinyMCE.triggerSave()}),$(kbMetaBox).on("mousedown",".wp-editor-wrap",function(){wpActiveEditor=this.id.slice(3,-5)}),$(kbMetaBox).on("mousedown",".quicktags",function(){wpActiveEditor=$(this).find("textarea").attr("id")}),$("body").on("mousedown",".kb_block",function(){activeBlock=this.id}),$("body").on("mousedown",".kb_field",function(){activeField=this}),$(".kb_area_list_item").mousedown(function(){activeArea=this.id}),$(kbMetaBox).on("change",".kb_field input, .kb_field select, .kb_field textarea",function(){$notice=$(this).closest(".kb_inner").find(".block-notice"),$(window).trigger("input:change"),$($notice).fadeIn(750)}),$("body").on("click",".media-modal-close, .media-modal-backdrop",function(){$("body").trigger("modal-close")}),$(document).on("keyup",function(e){27===e.which&&$("body").trigger("modal-close")})},menutabs:function(){$(".area-blocks-menu-tabs").tabs({show:function(){}})},ktftabs:function(){if($(".kb_fieldtabs")){var length=$(".kb_fieldtabs li").length;$(".kb_fieldtabs").tabs({activate:function(){$window=$(window).height(),$(".nano").nanoScroller()}}),$(".kb_fieldtabs").each(function(){1===length&&$(this).find(".ui-tabs-nav").css("display","none")})}$(document).on("kb_block_added",function(){$(".kb_fieldtabs")&&$(".kb_fieldtabs").tabs()})},tinymce:function(newid,parent){var settings=tinyMCEPreInit.mceInit.content;settings.elements=newid,tinyMCEPreInit.mceInit[newid]=settings,qtsettings={buttons:"",disabled_buttons:"",id:newid},tinyMCEPreInit.qtInit[newid]=qtsettings,ed=new tinymce.Editor(newid,settings),ed.render(),new QTags(qtsettings),setTimeout(function(){$(parent).removeClass("html-active").addClass("tmce-active"),QTags._buttonsInit()},1500)},remove_tinymce:function(){return"undefined"==typeof tinyMCE?!1:($(".wp-editor-wrap").each(function(){"wp-content-wrap"===$(this).attr("id")||(textarea=jQuery(this).find("textarea").attr("id"),tinyMCE.execCommand("mceRemoveControl",!1,textarea))}),void 0)},restore_tinymce:function(){return"undefined"==typeof tinyMCE?!1:(jQuery("#kontentblocks_stage .wp-editor-wrap").each(function(){textarea=jQuery(this).find("textarea").attr("id"),tinyMCE.execCommand("mceAddControl",!1,textarea),$(this).hasClass("html-active")&&$(this).removeClass("html-active").addClass("tmce-active")}),void 0)},resort:function(){var post_id=jQuery("#post_ID").val();data={},jQuery(".kb_sortable").each(function(){data[this.id]=jQuery("#"+this.id).sortable("serialize",{attribute:"rel"})}),KB.ajax({action:"resortModules",data:data,post_id:post_id},function(){KB.notice(kontentblocks.l18n.block_resorting)})},notice:function(msg,type){noty({text:msg,layout:"topRight",type:type,textAlign:"center",easing:"swing",animateOpen:{opacity:"toggle"},animateClose:{opacity:"toggle"},speed:"750",timeout:"2500",closable:!0,closeOnSelfClick:!0})},confirm:function(msg,pos_cb,neg_cb){noty({text:msg,speed:"350",modal:!0,layout:"center",buttons:[{type:"button green",text:"Ok",click:function(){"function"==typeof pos_cb&&pos_cb()}},{type:"button pink",text:"Cancel",click:function(){"function"==typeof neg_cb&&neg_cb()}}],closable:!1,timeout:!1})},alert:function(msg,pos_cb){noty({text:msg,speed:"350",modal:!0,layout:"center",buttons:[{type:"button green",text:"Ok",click:function(){"function"==typeof pos_cb&&pos_cb()}}],closable:!1,timeout:!1})},ajax:function(data,callback){nonce=$("#_kontentblocks_ajax_nonce").val(),post_id=$("#post_ID").val(),data._kb_nonce=nonce,data.post_id=post_id,data.kbajax="true",$(kbMetaBox).addClass("kb_loading"),$("#publish").attr("disabled","disabled"),$.ajax({url:ajaxurl,data:data,type:"POST",dataType:"json",success:function(data){"nonce unset"==data?(KB.notice(kontentblocks.l18n.sec_nonce_failed,"error"),callback(!1)):"wrong nonce"==data?(KB.notice(kontentblocks.l18n.sec_nonce_failed,"error"),callback(!1)):callback(data)},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){$(kbMetaBox).removeClass("kb_loading"),$("#publish").removeAttr("disabled")}})},blockLock:function(caller){$("#"+activeBlock+" .kb-ajax-status").show();var $object=$(caller),this_id=activeBlock;KB.ajax({action:"kb_lock_block",block_id:this_id},function(response){return 0==response?($(".kb-ajax-status").hide(),void 0):(1==response?KB.notice(kontentblocks.l18n.block_locked,"alert"):2==response&&KB.notice(kontentblocks.l18n.block_unlocked,"alert"),$("#"+activeBlock).toggleClass("locked"),$object.hasClass("locked")?($object.removeClass("locked"),$object.addClass("unlocked")):($object.removeClass("unlocked"),$object.addClass("locked")),$("#"+activeBlock).hasClass("kb-open")&&($("#"+activeBlock).find(".kb_inner").slideToggle("fast"),$("#"+activeBlock).removeClass("kb-open")),$(".kb-ajax-status").hide(),void 0)})},validateForm:function(form){return!$(form).find(".form-required").filter(function(){return""==$("input:visible",this).val()}).addClass("form-invalid").find("input:visible").change(function(){$(this).closest(".form-invalid").removeClass("form-invalid")}).size()},isLocked:function(){return $("#"+activeBlock).hasClass("locked")},isDisabled:function(){return $("#"+activeBlock).hasClass("disabled")}})}(jQuery),jQuery(document).ready(function($){KB.init(),$("#stage-inner").delegate(".kb_save_area","click",function(e){e.preventDefault();var area_id=$(this).prevAll("select:first").val(),block_id=$(this).closest(".kb_block").attr("id");$.post(ajaxurl,{action:"kb_save_area",block_id:block_id,area_id:area_id},function(response){area_meta=$("#"+block_id+" .area-meta"),$(area_meta).fadeTo(500,0,function(){$(this).empty(),$(this).append(response).fadeTo(500,1)})})}),$(".kb_area_head").mousedown(function(){activeArea=$(this).next().attr("id")})});