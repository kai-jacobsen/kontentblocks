/*! kontentblocks 2014-01-03 */
var KB, latestBlock, activeBlock, activeArea, activeField, kbMetaBox;

(function($) {
    _.extend(KB, {
        duplicate: false,
        postContext: true,
        openedModal: false,
        init: function() {
            vex.defaultOptions.className = "vex-theme-flat-attack";
            kbMetaBox = $("#kontentblocks_stage");
            if ($(".kb_fieldtabs")) {
                KB.ktftabs();
            }
            if ($(".area-blocks-menu-tabs")) {
                KB.menutabs();
            }
            $(".reveal-modal").bind("reveal:opened", function() {
                KB.openedModal = $(this);
            });
            jQuery("#submit").mousedown(function() {
                tinyMCE.triggerSave();
            });
            $(kbMetaBox).on("mousedown", ".wp-editor-wrap", function(e) {
                wpActiveEditor = this.id.slice(3, -5);
            });
            $(kbMetaBox).on("mousedown", ".quicktags", function(e) {
                wpActiveEditor = $(this).find("textarea").attr("id");
            });
            $("body").on("mousedown", ".kb_block", function(e) {
                activeBlock = this.id;
            });
            $("body").on("mousedown", ".kb_field", function(e) {
                activeField = this;
            });
            $(".kb_area_list_item").mousedown(function() {
                activeArea = this.id;
            });
            $(kbMetaBox).on("change", ".kb_field input, .kb_field select, .kb_field textarea", function(e) {
                $notice = $(this).closest(".kb_inner").find(".block-notice");
                $(window).trigger("input:change");
                $($notice).fadeIn(750);
            });
            $("body").on("click", ".media-modal-close, .media-modal-backdrop", function(e) {
                $("body").trigger("modal-close");
            });
            $(document).on("keyup", function(e) {
                if (e.which === 27) {
                    $("body").trigger("modal-close");
                }
            });
        },
        menutabs: function() {
            $(".area-blocks-menu-tabs").tabs({
                show: function(event, ui) {}
            });
        },
        ktftabs: function() {
            if ($(".kb_fieldtabs")) {
                var length = $(".kb_fieldtabs li").length;
                $(".kb_fieldtabs").tabs({
                    activate: function() {
                        $window = $(window).height();
                        $(".nano").nanoScroller();
                    }
                });
                $(".kb_fieldtabs").each(function() {
                    if (length === 1) {
                        $(this).find(".ui-tabs-nav").css("display", "none");
                    }
                });
            }
            $(document).on("kb_block_added", function(event) {
                if ($(".kb_fieldtabs")) {
                    $(".kb_fieldtabs").tabs();
                }
            });
        },
        tinymce: function(newid, parent) {
            var settings = tinyMCEPreInit.mceInit["content"];
            settings["elements"] = newid;
            tinyMCEPreInit.mceInit[newid] = settings;
            qtsettings = {
                buttons: "",
                disabled_buttons: "",
                id: newid
            };
            tinyMCEPreInit.qtInit[newid] = qtsettings;
            ed = new tinymce.Editor(newid, settings);
            ed.render();
            var qt = new QTags(qtsettings);
            setTimeout(function() {
                $(parent).removeClass("html-active").addClass("tmce-active");
                QTags._buttonsInit();
            }, 1500);
        },
        remove_tinymce: function() {
            if (typeof tinyMCE === "undefined") return false;
            $(".wp-editor-wrap").each(function() {
                if ($(this).attr("id") === "wp-content-wrap") {} else {
                    textarea = jQuery(this).find("textarea").attr("id");
                    tinyMCE.execCommand("mceRemoveControl", false, textarea);
                }
            });
        },
        restore_tinymce: function() {
            if (typeof tinyMCE === "undefined") return false;
            jQuery("#kontentblocks_stage .wp-editor-wrap").each(function() {
                textarea = jQuery(this).find("textarea").attr("id");
                tinyMCE.execCommand("mceAddControl", false, textarea);
                if ($(this).hasClass("html-active")) {
                    $(this).removeClass("html-active").addClass("tmce-active");
                }
            });
        },
        resort: function() {
            var post_id = jQuery("#post_ID").val();
            data = {};
            jQuery(".kb_sortable").each(function() {
                data[this.id] = jQuery("#" + this.id).sortable("serialize", {
                    attribute: "rel"
                });
            });
            KB.ajax({
                action: "resortModules",
                data: data,
                post_id: post_id
            }, function(response) {
                KB.notice(kontentblocks.l18n.block_resorting);
            });
        },
        notice: function(msg, type) {
            noty({
                text: msg,
                layout: "topRight",
                type: type,
                textAlign: "center",
                easing: "swing",
                animateOpen: {
                    opacity: "toggle"
                },
                animateClose: {
                    opacity: "toggle"
                },
                speed: "750",
                timeout: "2500",
                closable: true,
                closeOnSelfClick: true
            });
        },
        confirm: function(msg, pos_cb, neg_cb) {
            noty({
                text: msg,
                speed: "350",
                modal: true,
                layout: "center",
                buttons: [ {
                    type: "button green",
                    text: "Ok",
                    click: function() {
                        if (typeof pos_cb == "function") {
                            pos_cb();
                        }
                    }
                }, {
                    type: "button pink",
                    text: "Cancel",
                    click: function() {
                        if (typeof neg_cb == "function") {
                            neg_cb();
                        }
                    }
                } ],
                closable: false,
                timeout: false
            });
        },
        alert: function(msg, pos_cb, neg_cb) {
            noty({
                text: msg,
                speed: "350",
                modal: true,
                layout: "center",
                buttons: [ {
                    type: "button green",
                    text: "Ok",
                    click: function() {
                        if (typeof pos_cb == "function") {
                            pos_cb();
                        }
                    }
                } ],
                closable: false,
                timeout: false
            });
        },
        ajax: function(data, callback) {
            nonce = $("#_kontentblocks_ajax_nonce").val();
            post_id = $("#post_ID").val();
            data._kb_nonce = nonce;
            data.post_id = post_id;
            data.kbajax = "true";
            $(kbMetaBox).addClass("kb_loading");
            $("#publish").attr("disabled", "disabled");
            $.ajax({
                url: ajaxurl,
                data: data,
                type: "POST",
                dataType: "json",
                success: function(data) {
                    if (data == "nonce unset") {
                        KB.notice(kontentblocks.l18n.sec_nonce_failed, "error");
                        callback(false);
                    } else if (data == "wrong nonce") {
                        KB.notice(kontentblocks.l18n.sec_nonce_failed, "error");
                        callback(false);
                    } else {
                        callback(data);
                    }
                },
                error: function() {
                    KB.notice("<p>Generic Ajax Error</p>", "error");
                },
                complete: function() {
                    $(kbMetaBox).removeClass("kb_loading");
                    $("#publish").removeAttr("disabled");
                }
            });
        },
        blockLock: function(caller) {
            $("#" + activeBlock + " .kb-ajax-status").show();
            var $object = $(caller);
            var this_id = activeBlock;
            KB.ajax({
                action: "kb_lock_block",
                block_id: this_id
            }, function(response) {
                if (response == false) {
                    $(".kb-ajax-status").hide();
                    return;
                } else if (response == 1) {
                    KB.notice(kontentblocks.l18n.block_locked, "alert");
                } else if (response == 2) {
                    KB.notice(kontentblocks.l18n.block_unlocked, "alert");
                }
                $("#" + activeBlock).toggleClass("locked");
                if ($object.hasClass("locked")) {
                    $object.removeClass("locked");
                    $object.addClass("unlocked");
                } else {
                    $object.removeClass("unlocked");
                    $object.addClass("locked");
                }
                if ($("#" + activeBlock).hasClass("kb-open")) {
                    $("#" + activeBlock).find(".kb_inner").slideToggle("fast");
                    $("#" + activeBlock).removeClass("kb-open");
                }
                $(".kb-ajax-status").hide();
            });
        },
        validateForm: function(form) {
            return !$(form).find(".form-required").filter(function() {
                return $("input:visible", this).val() == "";
            }).addClass("form-invalid").find("input:visible").change(function() {
                $(this).closest(".form-invalid").removeClass("form-invalid");
            }).size();
        },
        isLocked: function() {
            return $("#" + activeBlock).hasClass("locked");
        },
        isDisabled: function() {
            return $("#" + activeBlock).hasClass("disabled");
        }
    });
})(jQuery);

jQuery(document).ready(function($) {
    KB.init();
    $("#stage-inner").delegate(".kb_save_area", "click", function(e) {
        e.preventDefault();
        var area_id = $(this).prevAll("select:first").val();
        var block_id = $(this).closest(".kb_block").attr("id");
        $.post(ajaxurl, {
            action: "kb_save_area",
            block_id: block_id,
            area_id: area_id
        }, function(response) {
            area_meta = $("#" + block_id + " .area-meta");
            $(area_meta).fadeTo(500, 0, function() {
                $(this).empty();
                $(this).append(response).fadeTo(500, 1);
            });
        });
    });
    $(".kb_area_head").mousedown(function() {
        activeArea = $(this).next().attr("id");
    });
});