/*! kontentblocks 2013-11-08 */
var latestBlock,activeBlock,activeArea,activeField,kbMetaBox,KB=KB||{};!function($){_.extend(KB,{duplicate:!1,postContext:!0,openedModal:!1,init:function(){vex.defaultOptions.className="vex-theme-flat-attack",kbMetaBox=$("#kontentblocks_stage"),$(".kb_fieldtabs")&&KB.ktftabs(),$(".area-blocks-menu-tabs")&&KB.menutabs(),$(".reveal-modal").bind("reveal:opened",function(){KB.openedModal=$(this)}),jQuery("#submit").mousedown(function(){tinyMCE.triggerSave()}),$(kbMetaBox).on("click",".kb-duplicate",function(){KB.duplicateBlock()}),$(kbMetaBox).on("click",".kb-lock",function(e){$caller=$(this),e.preventDefault(),KB.userCan("lock_kontentblocks")?KB.blockLock($caller):KB.userCan("lock_kontentblocks")||KB.notice(kontentblocks.l18n.sec_no_permission,"alert")}),jQuery(document).ajaxComplete(function(e,o,settings){KB.metaBoxReorder(e,o,settings,"restore")}),jQuery(document).ajaxSend(function(e,o,settings){KB.metaBoxReorder(e,o,settings,"remove")}),$(kbMetaBox).on("mousedown",".wp-editor-wrap",function(){wpActiveEditor=this.id.slice(3,-5)}),$(kbMetaBox).on("mousedown",".quicktags",function(){wpActiveEditor=$(this).find("textarea").attr("id")}),$("body").on("mousedown",".kb_block",function(){activeBlock=this.id}),$("body").on("mousedown",".kb_field",function(){activeField=this}),$(".kb_area_list_item").mousedown(function(){activeArea=this.id}),$(kbMetaBox).on("change",".kb_field input, .kb_field select, .kb_field textarea",function(){$notice=$(this).closest(".kb_inner").find(".block-notice"),$(window).trigger("input:change"),$($notice).fadeIn(750)}),$("body").on("click",".media-modal-close, .media-modal-backdrop",function(){$("body").trigger("modal-close")}),$(document).on("keyup",function(e){27===e.which&&$("body").trigger("modal-close")})},menutabs:function(){$(".area-blocks-menu-tabs").tabs({show:function(){}})},ktftabs:function(){$(document).on("kb_block_added",function(){$(".kb_fieldtabs")&&$(".kb_fieldtabs").tabs()})},resort:function(){var post_id=jQuery("#post_ID").val();data={},jQuery(".kb_sortable").each(function(){data[this.id]=jQuery("#"+this.id).sortable("serialize",{attribute:"rel"})}),KB.ajax({action:"resortModules",data:data,post_id:post_id},function(){KB.notice(kontentblocks.l18n.block_resorting)})},notice:function(msg,type){noty({text:msg,layout:"topRight",type:type,textAlign:"center",easing:"swing",animateOpen:{opacity:"toggle"},animateClose:{opacity:"toggle"},speed:"750",timeout:"2500",closable:!0,closeOnSelfClick:!0})},confirm:function(msg,pos_cb,neg_cb){noty({text:msg,speed:"350",modal:!0,layout:"center",buttons:[{type:"button green",text:"Ok",click:function(){"function"==typeof pos_cb&&pos_cb()}},{type:"button pink",text:"Cancel",click:function(){"function"==typeof neg_cb&&neg_cb()}}],closable:!1,timeout:!1})},alert:function(msg,pos_cb){noty({text:msg,speed:"350",modal:!0,layout:"center",buttons:[{type:"button green",text:"Ok",click:function(){"function"==typeof pos_cb&&pos_cb()}}],closable:!1,timeout:!1})},ajax:function(data,callback){nonce=$("#_kontentblocks_ajax_nonce").val(),post_id=$("#post_ID").val(),data._kb_nonce=nonce,data.post_id=post_id,data.kbajax="true",$(kbMetaBox).addClass("kb_loading"),$("#publish").attr("disabled","disabled"),$.ajax({url:ajaxurl,data:data,type:"POST",dataType:"json",success:function(data){"nonce unset"==data?(KB.notice(kontentblocks.l18n.sec_nonce_failed,"error"),callback(!1)):"wrong nonce"==data?(KB.notice(kontentblocks.l18n.sec_nonce_failed,"error"),callback(!1)):callback(data)},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){$(kbMetaBox).removeClass("kb_loading"),$("#publish").removeAttr("disabled")}})},metaBoxReorder:function(e,o,settings,action){if(settings.data){var a=settings.data,b=a.split("&"),result={};$.each(b,function(x,y){var temp=y.split("=");result[temp[0]]=temp[1]}),"meta-box-order"===result.action&&("restore"===action?KB.restore_tinymce():"remove"===action&&KB.remove_tinymce())}},blockCreate:function(caller){var data={};if(data.type=$(caller).attr("data-value")?$(caller).attr("data-value"):$(caller).attr("data-blockclass"),data.template=$(caller).attr("data-instance_id")?$(caller).attr("data-instance_id"):!1,data.master=$(caller).attr("data-master")?!0:!1,data.page_template=$("#"+activeArea).attr("data-page_template"),data.post_type=$("#"+activeArea).attr("data-post_type")?$("#"+activeArea).attr("data-post_type"):!1,data.post_id=$("#post_ID").val(),data.count=$("#kb_all_blocks").val(),data.duplicate=KB.duplicate,data.area=activeArea,data.context=$("#"+activeArea).attr("data-context"),list_limit=$("#"+activeArea).attr("data-limit"),list_children=$("#"+activeArea+" li.kb_block").length,0!==list_limit&&list_children===list_limit)return KB.alert(kontentblocks.l18n.area_create_full),!1;$(this).parent().fadeOut("fast");var spinner=$(caller).closest(".kb_area_head").find(".kb-ajax-status");$(spinner).show(),KB.ajax({action:"kb_generate_blocks",data:data},function(response){KB.duplicate=!1,result=response,$("#"+activeArea).append(result.html),$(spinner).hide(),latestBlock=result.id,data.count=parseInt(data.count)+1,$("#kb_all_blocks").val(data.count),$(".kb_properties_title").nextAll(".kb_properties").hide(),textareas=jQuery("#"+latestBlock).find(".wp-editor-wrap textarea"),$(textareas).each(function(){var daddy=$(this).closest(".wp-editor-wrap"),newid=$(this).attr("id");KB.tinymce(newid,daddy)}),KB.Modules.add(result.module),$(document).trigger("kb_block_added")})},blockLock:function(caller){$("#"+activeBlock+" .kb-ajax-status").show();var $object=$(caller),this_id=activeBlock;KB.ajax({action:"kb_lock_block",block_id:this_id},function(response){return 0==response?($(".kb-ajax-status").hide(),void 0):(1==response?KB.notice(kontentblocks.l18n.block_locked,"alert"):2==response&&KB.notice(kontentblocks.l18n.block_unlocked,"alert"),$("#"+activeBlock).toggleClass("locked"),$object.hasClass("locked")?($object.removeClass("locked"),$object.addClass("unlocked")):($object.removeClass("unlocked"),$object.addClass("locked")),$("#"+activeBlock).hasClass("kb-open")&&($("#"+activeBlock).find(".kb_inner").slideToggle("fast"),$("#"+activeBlock).removeClass("kb-open")),$(".kb-ajax-status").hide(),void 0)})},userCan:function(cap){return check=$.inArray(cap,kontentblocks.caps),-1!=check?!0:!1},isLocked:function(){return $("#"+activeBlock).hasClass("locked")},isDisabled:function(){return $("#"+activeBlock).hasClass("disabled")}})}(jQuery),jQuery(document).ready(function($){KB.init(),$("#stage-inner").delegate(".kb_save_area","click",function(e){e.preventDefault();var area_id=$(this).prevAll("select:first").val(),block_id=$(this).closest(".kb_block").attr("id");$.post(ajaxurl,{action:"kb_save_area",block_id:block_id,area_id:area_id},function(response){area_meta=$("#"+block_id+" .area-meta"),$(area_meta).fadeTo(500,0,function(){$(this).empty(),$(this).append(response).fadeTo(500,1)})})});var mouse_inside_menu=!1;$("body").on("click",".kb_dd_menu",function(data){data.preventDefault(),data.target==this&&(menus=$(".kb_open"),$(menus).each(function(){$(this).hasClass("kb_open")&&$(this).fadeOut("fast").toggleClass("kb_open")}),menu=$(this).parent().find(".kb_dd_list"),$(menu).slideToggle("fast").toggleClass("kb_open"))}),$(".kb_dd_menu, .kb_dd_list").hover(function(){mouse_inside_menu=!0},function(){mouse_inside_menu=!1}),$("body").mouseup(function(){0==mouse_inside_menu&&(menus=$(".kb_open"),$(menus).each(function(){$(this).hasClass("kb_open")&&$(this).fadeOut("fast").toggleClass("kb_open")}))}),$(".kb_area_head").mousedown(function(){activeArea=$(this).next().attr("id")})});