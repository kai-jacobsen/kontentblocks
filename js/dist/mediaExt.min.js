/*! Kontentblocks ProdVersion 2021-11-26 08:11 */

!function(i,e){if(i&&i.media){media=i.media,l10n=media.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n;var t=i.media.view.MediaFrame.ImageDetails;i.media.view.MediaFrame.KBImageDetails=t.extend({initialize:function(){t.prototype.initialize.apply(this,arguments)}}),media.view.Toolbar.KBSelect=media.view.Toolbar.Select.extend({initialize:function(){var e=this.options;_.bindAll(this,"clickSelect"),_.defaults(e,{event:"select",state:"kb-cropper",reset:!0,close:!1,text:l10n.select,requires:{selection:!0}}),e.items=_.defaults(e.items||{},{select:{style:"primary",text:e.text,priority:80,click:this.clickSelect,requires:e.requires}}),media.view.Toolbar.prototype.initialize.apply(this,arguments)}}),media.view.KBCropper=media.View.extend({className:"crop-content",template:media.template("crop-content"),initialize:function(){_.bindAll(this,"onImageLoad")},ready:function(){this.controller.frame.on("content:error:crop",this.onError,this),this.$image=this.$el.find(".crop-image"),this.$image.on("load",this.onImageLoad),jQuery(window).on("resize.cropper",_.debounce(this.onImageLoad,250))},prepare:function(){return{title:l10n.cropYourImage,url:this.options.attachment.get("url")}},onImageLoad:function(){var e=this.controller.get("imgSelectOptions");"function"==typeof e&&(e=e(this.options.attachment,this.controller)),e=_.extend(e,{parent:this.$el}),this.trigger("image-loaded"),this.controller.imgSelect=this.$image.imgAreaSelect(e)},onError:function(){var e=this.options.attachment.get("filename");this.views.add(".upload-errors",new media.view.UploaderStatusError({filename:media.view.UploaderStatus.prototype.filename(e),message:_wpMediaViewsL10n.cropError}),{at:0})}}),media.controller.KBCropper=media.controller.State.extend({defaults:{id:"kb-cropper",title:l10n.cropImage,toolbar:"crop",content:"crop",router:!1,canSkipCrop:!1},activate:function(){this.frame.on("content:create:crop",this.createCropContent,this),this.frame.on("close",this.removeCropper,this),this.set("selection",new Backbone.Collection(this.frame._selection.single))},deactivate:function(){this.frame.toolbar.mode("browse")},createCropContent:function(){this.cropperView=new i.media.view.KBCropper({controller:this,attachment:this.get("selection").first()}),this.cropperView.on("image-loaded",this.createCropToolbar,this),this.frame.content.set(this.cropperView)},removeCropper:function(){this.imgSelect.cancelSelection(),this.imgSelect.setOptions({remove:!0}),this.imgSelect.update(),this.cropperView.remove()},createCropToolbar:function(){var e,t;e=this.get("canSkipCrop")||!1,t={controller:this.frame,items:{insert:{style:"primary",text:l10n.cropImage,priority:80,requires:{library:!1,selection:!1},click:function(){var t=this,e=this.controller.state().get("selection").first();e.set({cropDetails:this.controller.state().imgSelect.getSelection(),cropOptions:this.controller.state().frame.options.cropOptions}),this.$el.text(l10n.cropping),this.$el.attr("disabled",!0),this.controller.state().doCrop(e).done(function(e){t.controller.trigger("cropped",e),t.controller.handleCroppedImage(e),t.controller.setState("library"),t.controller.toolbar.mode("select"),t.controller.createSelection(),t.controller.dispose(),t.controller.close()}).fail(function(){t.controller.trigger("content:error:crop")})}}}},e&&_.extend(t.items,{skip:{style:"secondary",text:l10n.skipCropping,priority:70,requires:{library:!1,selection:!1},click:function(){var e=this.controller.state().get("selection").first();this.controller.state().cropperView.remove(),this.controller.trigger("skippedcrop",e),this.controller.close()}}}),this.frame.toolbar.set(new i.media.view.Toolbar(t))},doCrop:function(e){return i.ajax.post("cropImage",{nonce:e.get("nonces").edit,_ajax_nonce:KB.appData.config.nonces.create,id:e.get("id"),cropDetails:e.get("cropDetails"),cropOptions:e.get("cropOptions")})}}),media.view.KBCropperFrame=media.view.MediaFrame.Select.extend({initialize:function(){this.options.cropOptions||(this.options.cropOptions={}),this.options.cropOptions=_.defaults(this.options.cropOptions,{maxWidth:500,maxHeight:500}),_.defaults(this.options,{selection:[],library:{type:"image"},cache:!1,multiple:!1,state:"library",content:"library"}),this.options.croppedCallback||(this.options.croppedCallback=jQuery.noop),media.view.MediaFrame.prototype.initialize.apply(this,arguments),this.createSelection(),this.createStates(),this.bindHandlers(),this.states.get("library").get("selection").on("add",function(i){var o=this;i.on("change:uploading",function(){var e,t;e=i.get("width"),t=i.get("height"),(e<o.options.cropOptions.maxWidth||t<o.options.cropOptions.maxHeight)&&(o.options.cropOptions.maxWidth=o.options.cropOptions.maxWidth/2,o.options.cropOptions.maxHeight=o.options.cropOptions.maxHeight/2)})},this)},reset:function(){return this.states.invoke("trigger","reset"),this.createSelection(),this},createStates:function(){var e=this.options;this.states.add([new media.controller.KBCropper({imgSelectOptions:this.calculateImageSelectOptions})]),this.states.add([new media.controller.Library({library:media.query(e.library),multiple:e.multiple,title:e.title,menu:!1,priority:20})])},createSelectToolbar:function(e,t){(t=t||this.options.button||{}).controller=this,e.view=new media.view.Toolbar.KBSelect(t)},calculateImageSelectOptions:function(e,t){var i,o,r,a,n,l=parseInt(t.frame.options.cropOptions.maxWidth,10),s=parseInt(t.frame.options.cropOptions.maxHeight,10);return(i=l/s)<(o=n=e.get("width"))/(r=a=e.get("height"))?l=(s=r)*i:s=(l=o)/i,{handles:"corners",aspectRatio:l+":"+s,keys:!0,instance:!0,persistent:!0,imageWidth:n,imageHeight:a,x1:0,y1:0,x2:l,y2:s,minWidth:t.frame.options.cropOptions.maxWidth,minHeight:t.frame.options.cropOptions.maxHeight,fadeSpeed:1e3}},handleCroppedImage:function(e){var t=new i.media.model.Attachment(e);this.options.croppedCallback.call(this.options.parentController,t)}})}}(window.wp,jQuery),function(e,t){e&&e.media&&(media=e.media,l10n=media.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n,media.view.KBGallery=media.view.MediaFrame.Select.extend({initialize:function(){_.defaults(this.options,{selection:[],library:{},multiple:!1,state:"gallery",content:"library"}),media.view.MediaFrame.prototype.initialize.apply(this,arguments),this.createSelection(),this.createStates(),this.bindHandlers()},bindHandlers:function(){var e;media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("activate",this.activate,this),void 0!==_.find(this.counts,function(e){return 0===e.count})&&this.listenTo(media.model.Attachments.all,"change:type",this.mediaTypeCounts),this.on("menu:create:gallery",this.createMenu,this),this.on("toolbar:create:main-gallery",this.createToolbar,this),e={content:{"edit-image":"editImageContent","edit-selection":"editSelectionContent"},toolbar:{"main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar"}},_.each(e,function(e,i){_.each(e,function(e,t){this.on(i+":render:"+t,this[e],this)},this)},this)},reset:function(){return this.states.invoke("trigger","reset"),this.createSelection(),this},createStates:function(){var e=this.options;this.states.add([new media.controller.Library({id:"gallery",title:l10n.createGalleryTitle,priority:40,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:media.query(_.defaults({type:"image"},e.library))}),new media.controller.GalleryEdit({library:e.selection,editing:e.editing,menu:"gallery"}),new media.controller.GalleryAdd])},mainGalleryToolbar:function(e){var o=this;this.selectionStatusToolbar(e),e.set("gallery",{style:"primary",text:l10n.createNewGallery,priority:60,requires:{selection:!0},click:function(){var e=o.state().get("selection"),t=o.state("gallery-edit"),i=e.where({type:"image"});t.set("library",new media.model.Selection(i,{props:e.props.toJSON(),multiple:!0})),this.controller.setState("gallery-edit"),this.controller.modal.focusManager.focus()}})},galleryEditToolbar:function(){var e=this.state().get("editing");this.toolbar.set(new media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:e?l10n.updateGallery:l10n.insertGallery,priority:80,requires:{library:!0},click:function(){var e=this.controller,t=e.state();e.close(),t.trigger("update",t.get("library")),e.setState(e.options.state),e.reset()}}}}))},galleryAddToolbar:function(){this.toolbar.set(new media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:l10n.addToGallery,priority:80,requires:{selection:!0},click:function(){var e=this.controller,t=e.state();e.state("gallery-edit").get("library").add(t.get("selection").models),t.trigger("reset"),e.setState("gallery-edit")}}}}))},selectionStatusToolbar:function(e){var t=this.state().get("editable");e.set("selection",new media.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:t&&function(){this.controller.content.mode("edit-selection")}}).render())}}))}(window.wp,jQuery);