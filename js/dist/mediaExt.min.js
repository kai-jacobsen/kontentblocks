/*! Kontentblocks ProdVersion 2016-07-10 02:07 */
!function(a,b){if(a&&a.media){media=a.media,l10n=media.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n;var c=a.media.view.MediaFrame.ImageDetails;a.media.view.MediaFrame.KBImageDetails=c.extend({initialize:function(){c.prototype.initialize.apply(this,arguments)}}),media.view.Toolbar.KBSelect=media.view.Toolbar.Select.extend({initialize:function(){var a=this.options;_.bindAll(this,"clickSelect"),_.defaults(a,{event:"select",state:"kb-cropper",reset:!0,close:!1,text:l10n.select,requires:{selection:!0}}),a.items=_.defaults(a.items||{},{select:{style:"primary",text:a.text,priority:80,click:this.clickSelect,requires:a.requires}}),media.view.Toolbar.prototype.initialize.apply(this,arguments)}}),media.view.KBCropper=media.View.extend({className:"crop-content",template:media.template("crop-content"),initialize:function(){_.bindAll(this,"onImageLoad")},ready:function(){this.controller.frame.on("content:error:crop",this.onError,this),this.$image=this.$el.find(".crop-image"),this.$image.on("load",this.onImageLoad),b(window).on("resize.cropper",_.debounce(this.onImageLoad,250))},prepare:function(){return{title:l10n.cropYourImage,url:this.options.attachment.get("url")}},onImageLoad:function(){var a=this.controller.get("imgSelectOptions");"function"==typeof a&&(a=a(this.options.attachment,this.controller)),a=_.extend(a,{parent:this.$el}),this.trigger("image-loaded"),this.controller.imgSelect=this.$image.imgAreaSelect(a)},onError:function(){var a=this.options.attachment.get("filename");this.views.add(".upload-errors",new media.view.UploaderStatusError({filename:media.view.UploaderStatus.prototype.filename(a),message:_wpMediaViewsL10n.cropError}),{at:0})}}),media.controller.KBCropper=media.controller.State.extend({defaults:{id:"kb-cropper",title:l10n.cropImage,toolbar:"crop",content:"crop",router:!1,canSkipCrop:!1},activate:function(){this.frame.on("content:create:crop",this.createCropContent,this),this.frame.on("close",this.removeCropper,this),this.set("selection",new Backbone.Collection(this.frame._selection.single))},deactivate:function(){this.frame.toolbar.mode("browse")},createCropContent:function(){this.cropperView=new a.media.view.KBCropper({controller:this,attachment:this.get("selection").first()}),this.cropperView.on("image-loaded",this.createCropToolbar,this),this.frame.content.set(this.cropperView)},removeCropper:function(){this.imgSelect.cancelSelection(),this.imgSelect.setOptions({remove:!0}),this.imgSelect.update(),this.cropperView.remove()},createCropToolbar:function(){var b,c;b=this.get("canSkipCrop")||!1,c={controller:this.frame,items:{insert:{style:"primary",text:l10n.cropImage,priority:80,requires:{library:!1,selection:!1},click:function(){var a=this,b=this.controller.state().get("selection").first();b.set({cropDetails:this.controller.state().imgSelect.getSelection(),cropOptions:this.controller.state().frame.options.cropOptions}),this.$el.text(l10n.cropping),this.$el.attr("disabled",!0),this.controller.state().doCrop(b).done(function(b){a.controller.trigger("cropped",b),a.controller.handleCroppedImage(b),a.controller.setState("library"),a.controller.toolbar.mode("select"),a.controller.createSelection(),a.controller.dispose(),a.controller.close()}).fail(function(){a.controller.trigger("content:error:crop")})}}}},b&&_.extend(c.items,{skip:{style:"secondary",text:l10n.skipCropping,priority:70,requires:{library:!1,selection:!1},click:function(){var a=this.controller.state().get("selection").first();this.controller.state().cropperView.remove(),this.controller.trigger("skippedcrop",a),this.controller.close()}}}),this.frame.toolbar.set(new a.media.view.Toolbar(c))},doCrop:function(b){return a.ajax.post("cropImage",{nonce:b.get("nonces").edit,_ajax_nonce:KB.appData.config.nonces.create,id:b.get("id"),cropDetails:b.get("cropDetails"),cropOptions:b.get("cropOptions")})}}),media.view.KBCropperFrame=media.view.MediaFrame.Select.extend({initialize:function(){this.options.cropOptions||(this.options.cropOptions={}),this.options.cropOptions=_.defaults(this.options.cropOptions,{maxWidth:500,maxHeight:500}),_.defaults(this.options,{selection:[],library:{type:"image"},cache:!1,multiple:!1,state:"library",content:"library"}),this.options.croppedCallback||(this.options.croppedCallback=jQuery.noop),media.view.MediaFrame.prototype.initialize.apply(this,arguments),this.createSelection(),this.createStates(),this.bindHandlers(),this.states.get("library").get("selection").on("add",function(a){var b=this;a.on("change:uploading",function(){var c,d;c=a.get("width"),d=a.get("height"),(c<b.options.cropOptions.maxWidth||d<b.options.cropOptions.maxHeight)&&(b.options.cropOptions.maxWidth=b.options.cropOptions.maxWidth/2,b.options.cropOptions.maxHeight=b.options.cropOptions.maxHeight/2)})},this)},reset:function(){return this.states.invoke("trigger","reset"),this.createSelection(),this},createStates:function(){var a=this.options;this.states.add([new media.controller.KBCropper({imgSelectOptions:this.calculateImageSelectOptions})]),this.states.add([new media.controller.Library({library:media.query(a.library),multiple:a.multiple,title:a.title,menu:!1,priority:20})])},createSelectToolbar:function(a,b){b=b||this.options.button||{},b.controller=this,a.view=new media.view.Toolbar.KBSelect(b)},calculateImageSelectOptions:function(a,b){var c,d,e,f,g,h,i=parseInt(b.frame.options.cropOptions.maxWidth,10),j=parseInt(b.frame.options.cropOptions.maxHeight,10);return g=a.get("width"),f=a.get("height"),c=i/j,d=g,e=f,d/e>c?(j=e,i=j*c):(i=d,j=i/c),h={handles:"corners",aspectRatio:i+":"+j,keys:!0,instance:!0,persistent:!0,imageWidth:g,imageHeight:f,x1:0,y1:0,x2:i,y2:j,minWidth:b.frame.options.cropOptions.maxWidth,minHeight:b.frame.options.cropOptions.maxHeight,fadeSpeed:1e3}},handleCroppedImage:function(b){var c=new a.media.model.Attachment(b);this.options.croppedCallback.call(this.options.parentController,c)}})}}(window.wp,jQuery),function(a,b){a&&a.media&&(media=a.media,l10n=media.view.l10n="undefined"==typeof _wpMediaViewsL10n?{}:_wpMediaViewsL10n,media.view.KBGallery=media.view.MediaFrame.Select.extend({initialize:function(){_.defaults(this.options,{selection:[],library:{},multiple:!1,state:"gallery",content:"library"}),media.view.MediaFrame.prototype.initialize.apply(this,arguments),this.createSelection(),this.createStates(),this.bindHandlers()},bindHandlers:function(){var a,b;media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("activate",this.activate,this),b=_.find(this.counts,function(a){return 0===a.count}),"undefined"!=typeof b&&this.listenTo(media.model.Attachments.all,"change:type",this.mediaTypeCounts),this.on("menu:create:gallery",this.createMenu,this),this.on("toolbar:create:main-gallery",this.createToolbar,this),a={content:{"edit-image":"editImageContent","edit-selection":"editSelectionContent"},toolbar:{"main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar"}},_.each(a,function(a,b){_.each(a,function(a,c){this.on(b+":render:"+c,this[a],this)},this)},this)},reset:function(){return this.states.invoke("trigger","reset"),this.createSelection(),this},createStates:function(){var a=this.options;this.states.add([new media.controller.Library({id:"gallery",title:l10n.createGalleryTitle,priority:40,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:media.query(_.defaults({type:"image"},a.library))}),new media.controller.GalleryEdit({library:a.selection,editing:a.editing,menu:"gallery"}),new media.controller.GalleryAdd])},mainGalleryToolbar:function(a){var b=this;this.selectionStatusToolbar(a),a.set("gallery",{style:"primary",text:l10n.createNewGallery,priority:60,requires:{selection:!0},click:function(){var a=b.state().get("selection"),c=b.state("gallery-edit"),d=a.where({type:"image"});c.set("library",new media.model.Selection(d,{props:a.props.toJSON(),multiple:!0})),this.controller.setState("gallery-edit"),this.controller.modal.focusManager.focus()}})},galleryEditToolbar:function(){var a=this.state().get("editing");this.toolbar.set(new media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:a?l10n.updateGallery:l10n.insertGallery,priority:80,requires:{library:!0},click:function(){var a=this.controller,b=a.state();a.close(),b.trigger("update",b.get("library")),a.setState(a.options.state),a.reset()}}}}))},galleryAddToolbar:function(){this.toolbar.set(new media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:l10n.addToGallery,priority:80,requires:{selection:!0},click:function(){var a=this.controller,b=a.state(),c=a.state("gallery-edit");c.get("library").add(b.get("selection").models),b.trigger("reset"),a.setState("gallery-edit")}}}}))},selectionStatusToolbar:function(a){var b=this.state().get("editable");a.set("selection",new media.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:b&&function(){this.controller.content.mode("edit-selection")}}).render())}}))}(window.wp,jQuery);