/*! Kontentblocks ProdVersion 2014-11-24 03:11 */
KB.Fields.register("Color",function($){return{init:function(){$("body").on("mouseup",".kb-field--color",function(){setTimeout(function(){KB.FrontendEditModal&&KB.FrontendEditModal.recalibrate()},150)}),$(".kb-color-picker").wpColorPicker({change:function(){},clear:function(){pickColor("")}})},update:function(){this.init()},frontUpdate:function(){this.init()}}}(jQuery)),KB.Fields.register("Date",function($){var settings={};return{defaults:{format:"d M Y",offset:[0,250],onSelect:function(selected,machine,Date){$("#"+KB.currentFieldId).find(".kb-date-machine-format").val(machine),$("#"+KB.currentFieldId).find(".kb-date-unix-format").val(Math.round(Date.getTime()/1e3))}},init:function(){var that=this;_.each($(".kb-datepicker"),function(item){var id=$(item).closest(".kb-field-wrapper").attr("id");id&&KB.payload.Fields[id].settings&&(settings=KB.payload.Fields[id].settings||{}),$(item).Zebra_DatePicker(_.extend(that.defaults,settings))})},update:function(){this.init()}}}(jQuery)),KB.Fields.register("DateTime",function($){var settings={};return{defaults:{format:"d.m.Y H:i",inline:!1,mask:!0,lang:"de",allowBlank:!0},init:function(){var that=this;_.each($(".kb-datetimepicker"),function(item){var $field=$(item).closest(".kb-field-wrapper"),id=$field.attr("id"),args=KB.Payload.getFieldArgs(id,"settings");id&&args&&(settings=args),_.extend(that.defaults,{onChangeDateTime:function(current){$(".kb-datetimepicker--js-unix",$field).val(current.dateFormat("unixtime")),$(".kb-datetimepicker--js-sql",$field).val(current.dateFormat("Y-m-d H:i:s"))}}),$(item).datetimepicker(_.extend(that.defaults,settings))})},update:function(){this.init()}}}(jQuery)),KB.Fields.register("File",function($){var self,attachment;return self={selector:".kb-js-add-file",remove:".kb-js-reset-file",container:null,init:function(){var that=this;$("body").on("click",this.selector,function(e){e.preventDefault(),that.container=$(".kb-field-file-wrapper",activeField),that.frame().open()}),$("body").on("click",this.remove,function(e){e.preventDefault(),that.container=$(".kb-field-file-wrapper",activeField),that.resetFields()})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:KB.i18n.Refields.file.modalTitle,button:{text:KB.i18n.Refields.common.select},multiple:!1,library:{type:""}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){$(".media-modal").addClass(" smaller no-sidebar")},select:function(){attachment=this.get("selection").first(),self.handleAttachment(attachment)},handleAttachment:function(attachment){$(".kb-file-filename",this.container).html(attachment.get("filename")),$(".kb-file-attachment-id",this.container).val(attachment.get("id")),$(".kb-file-title",this.container).html(attachment.get("title")),$(".kb-file-id",this.container).html(attachment.get("id")),$(".kb-file-editLink",this.container).attr("href",attachment.get("editLink")),$(this.remove,activeField).show(),this.container.show(750)},resetFields:function(){$(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),$(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery)),KB.Fields.register("FlexibleFields",function($){return{init:function(modalView){$(".flexible-fields--stage",$("body")).each(function(index,el){var view=modalView||KB.Views.Modules.get($(el).data("module")),key=$(el).data("fieldkey"),arrayKey=$(el).data("arraykey"),fid=$(el).closest(".kb-js-field-identifier").attr("id");if(view.hasField(key,arrayKey))view.getField(key,arrayKey).bootstrap.call(view.getField(key,arrayKey));else{var obj=new KB.FlexibleFields.Controller({moduleView:view,fid:fid,key:key,arrayKey:arrayKey,el:el});view.addField(key,obj,arrayKey)}})},update:function(){this.init()},frontUpdate:function(modalView){this.init(modalView)}}}(jQuery)),KB.FlexibleFields={},KB.FlexibleFields.Controller=Backbone.View.extend({initialize:function(params){this.params=params,this.fieldArgs=KB.Payload.getFieldArgs(params.fid),this.parentModuleId=params.moduleView.model.get("instance_id"),this._frame=null,this.subviews=[],this._initialized=!1,this.bootstrap()},bootstrap:function(){this._initialized?_K.log("Fields: FlexibleFields instance was already initialized. Doing nothing."):(this.setupConfig(),this.setupElements(),this.initialSetup(),this._initialized=!0,_K.log("Fields: FlexibleFields instance created and initialized"))},events:{"click .kb-flexible-fields--js-add-item":"addItem"},setupConfig:function(){var that=this;_.each(this.fieldArgs.config,function(tab){tab.fields&&(tab.fields=that.setupFields(tab.fields))})},setupFields:function(fields){var that=this;return _.each(fields,function(field,key){field.moduleId=that.params.moduleView.model.get("instance_id"),field.fieldId=that.params.fid,field.fieldKey=that.params.key,field.arrayKey=that.params.arrayKey,field.key=key,field.$parent=that.$el,fields[key]=field}),fields},setupElements:function(){this.$list=jQuery('<ul class="flexible-fields--item-list"></ul>').appendTo(this.$el),this.$addButton=jQuery('<a class="button button-primary kb-flexible-fields--js-add-item">Add Item</a>').appendTo(this.$el)},addItem:function(){var model=new Backbone.Model({}),Item=new KB.FlexibleFields.Item({model:model,parent:this});this.subviews.push(Item),this.$list.append(Item.render()),KB.Ui.initTabs(),KB.trigger("frontend::recalibrate")},initialSetup:function(){var that=this,payload=KB.Payload.getFieldData("flexfields",this.params.moduleView.model.get("instance_id"),this.params.key,this.params.arrayKey)||[];_.each(payload,function(item){var model=new Backbone.Model(item),Item=new KB.FlexibleFields.Item({model:model,parent:that});that.subviews.push(Item),that.$list.append(Item.render())}),KB.Ui.initTabs(),this.$list.sortable({handle:".flexible-fields--js-drag-handle",start:function(){KB.TinyMCE.removeEditors()},stop:function(){KB.TinyMCE.restoreEditors()}})}}),KB.FlexibleFields.Item=Backbone.View.extend({tagName:"li",className:"kb-flexible-fields--item-wrapper",initialize:function(params){if(this.parentView=params.parent,this.config=params.parent.fieldArgs.config,this.uid=this.model.get("_uid")||_.uniqueId("ff"),!this.model.get("_tab")){var tabDef={title:this.uid};this.model.set("_tab",tabDef)}},events:{"click .flexible-fields--js-toggle":"toggleItem","click .flexible-fields--js-trash":"deleteItem"},toggleItem:function(){jQuery(".flexible-fields--toggle-title",this.$el).next().slideToggle(250,function(){KB.trigger("frontend::recalibrate")})},deleteItem:function(){this.$el.hide(250);var inputName=this.createInputName(this.uid);this.$el.append('<input type="hidden" name="'+inputName+'[delete]" value="'+this.uid+'" >'),KB.Notice.notice("Please click update to save the changes","success")},render:function(){var inputName=this.createInputName(this.uid),item=this.model.toJSON(),$skeleton=this.$el.append(KB.Templates.render("fields/FlexibleFields/single-item",{item:item,inputName:inputName,uid:this.uid}));return this.renderTabs($skeleton),$skeleton},renderTabs:function($skeleton){var that=this,tabNavEl=HandlebarsKB.compile("<li><a href='#tab-{{ uid }}-{{ index }}'>{{ tab.label }}</a></li>"),tabCon=HandlebarsKB.compile("<div id='tab-{{ uid }}-{{ index }}'></div>");_.each(this.config,function(tab,index){jQuery(".flexible-field--tab-nav",$skeleton).append(tabNavEl({uid:that.uid,tab:tab,index:index}));var $tabsContainment=jQuery(".kb-field--tabs",$skeleton),$con=jQuery(tabCon({uid:that.uid,index:index})).appendTo($tabsContainment);that.renderFields(tab,$con)})},renderFields:function(tab,$con){var fieldInstance,data,that=this;_.each(tab.fields,function(field){fieldInstance=KB.FieldsAPI.get(field),data=that.model.get(field.key),_.isUndefined(data)||fieldInstance.setValue(data),$con.append(fieldInstance.render(that.uid)),$con.append('<input type="hidden" name="'+fieldInstance.baseId+"["+that.uid+"][_mapping]["+fieldInstance.get("key")+']" value="'+fieldInstance.get("type")+'" >'),fieldInstance.$container=$con,fieldInstance.postRender&&fieldInstance.postRender.call(fieldInstance)})},createInputName:function(uid){return this.createBaseId()+"["+this.parentView.params.key+"]"+"["+uid+"]"},createBaseId:function(){return _.isEmpty(this.parentView.params.arrayKey)?this.parentView.parentModuleId:this.parentView.parentModuleId+"["+this.parentView.params.arrayKey+"]"}}),KB.Fields.register("Fonticonpicker",function($){return{init:function(){$(".kb-fonticonpicker").fontIconPicker({source:["icon-heart","icon-search","icon-user","icon-tag","icon-help"],emptyIcon:!1,hasSearch:!1})},update:function(){this.init()},frontUpdate:function(){this.init()}}}(jQuery)),KB.Fields.register("Gallery",function($){return{init:function(modalView){$(".kb-gallery--stage",$("body")).each(function(index,el){var view=modalView||KB.Views.Modules.get($(el).data("module")),key=$(el).data("fieldkey"),arrayKey=$(el).data("arraykey"),fid=$(el).closest(".kb-js-field-identifier").attr("id");if(view.hasField(key,arrayKey))view.getField(key,arrayKey).bootstrap.call(view.getField(key,arrayKey));else{var obj=new KB.Gallery.Controller({moduleView:view,fid:fid,key:key,arrayKey:arrayKey,el:el});view.addField(key,obj,arrayKey)}})},update:function(){this.init()},frontUpdate:function(modalView){this.init(modalView)}}}(jQuery)),KB.Gallery={},KB.Gallery.ImageView=Backbone.View.extend({tagName:"div",className:"kb-gallery--image-wrapper",initialize:function(args){this.parentView=args.parentView,this.uid=this.model.get("uid")||_.uniqueId("kbg"),this.editorAdded=!1,this._remove=!1},events:{"click .kb-gallery--js-edit":"edit","click .kb-gallery--js-delete":"delete","click .kb-gallery--js-meta-close":"close"},edit:function(){this.$el.wrap('<div class="kb-gallery--item-placeholder kb-gallery--image-wrapper"></div>'),this._placeholder=this.$el.parent(),this.$el.addClass("kb-gallery--active-item kb_field").appendTo("body"),jQuery("#wpwrap").addClass("module-browser-open"),this.handleEditor(),KB.Ui.initTabs()},handleEditor:function(){var that=this;$re=jQuery(".kb-js--remote-editor",this.$el);var name=this.createInputName(this.uid)+"[details][description]";if(this.editorAdded)KB.TinyMCE.addEditor($re,null,150);else{var req=KB.TinyMCE.remoteGetEditor($re,name,this.uid,this.model.get("details").description,null,!1,!1);req.done(function(res){that.editorAdded=res,KB.Ui.initTabs()})}},"delete":function(){this._remove?(this.$el.fadeTo(450,1).css("borderColor","#ccc"),jQuery(".kb-gallery--image-remove",this.$el).val(""),this._remove=!1):(this.$el.fadeTo(450,.5).css("borderColor","red"),this._remove=!0,jQuery(".kb-gallery--image-remove",this.$el).val("true"))},remove:function(){this.$el.remove(),delete this.$el},close:function(){var ed=tinymce.get(this.uid+"_ededitor"),details=this.model.get("details");details.description=this.getEditorContent(ed),tinymce.remove(ed),this.$el.appendTo(this._placeholder).unwrap(),this.$el.removeClass("kb-gallery--active-item").removeClass("kb_field"),jQuery("#wpwrap").removeClass("module-browser-open")},getEditorContent:function(ed){var $wrap=jQuery("#wp-"+this.uid+"_ededitor-wrap"),isTinyMCE=$wrap.hasClass("tmce-active");if(isTinyMCE)return ed.getContent();var value=document.getElementById(this.uid+"_ededitor").value;return value=value.replace(/<br\s*\/?>/gm,"\n"),ed.setContent(value),value},render:function(){var inputName=this.createInputName(this.uid),item=this.model.toJSON();return this.$el.append(KB.Templates.render("fields/Gallery/single-image",{image:item,id:item.id,inputName:inputName,uid:this.uid}))},createInputName:function(uid){return this.createBaseId()+"["+this.parentView.params.key+"]"+"[images]"+"["+uid+"]"},createBaseId:function(){return _.isEmpty(this.parentView.params.arrayKey)?this.parentView.parentModuleId:this.parentView.parentModuleId+"["+this.parentView.params.arrayKey+"]"}}),KB.Gallery.Controller=Backbone.View.extend({initialize:function(params){this.params=params,this.fieldArgs=KB.Payload.getFieldArgs(params.fid),this.parentModuleId=params.moduleView.model.get("instance_id"),this._frame=null,this.subviews=[],this._initialized=!1,this.bootstrap(),KB.FrontendEditModal&&this.listenTo(KB.FrontendEditModal,"kb:frontend-save",this.frontendSave)},events:{"click .kb-gallery--js-add-images":"addImages"},bootstrap:function(){this._initialized?_K.log("Fields: Gallery instance was already initialized. Doing nothing."):(this.setupElements(),this.initialSetup(),this._initialized=!0,_K.log("Fields: Gallery instance created and initialized"))},setupElements:function(){this.$list=jQuery('<div class="kb-gallery--item-list"></div>').appendTo(this.$el),this.$list.sortable({revert:!0,delay:300}),this.$addButton=jQuery('<a class="button button-primary kb-gallery--js-add-images">Add Images</a>').appendTo(this.$el)},addImages:function(){this.openModal()},frame:function(){return this._frame?this._frame:void 0},openModal:function(){var that=this;return this._frame?(this._frame.open(),void 0):(this._frame=wp.media({title:KB.i18n.Refields.image.modalTitle,button:{text:KB.i18n.Refields.common.select},multiple:!0,library:{type:"image"}}),this._frame.state("library").on("select",function(){that.select(this)}),this._frame.open(),this._frame)},select:function(modal){var selection=modal.get("selection");selection.length>0&&this.handleModalSelection(selection.models)},handleModalSelection:function(selection){var that=this;_.each(selection,function(image){var attr={file:image.toJSON(),details:{title:"",alt:"",description:""},id:image.get("id")},model=new Backbone.Model(attr),imageView=new KB.Gallery.ImageView({model:model,parentView:that});that.subviews.push=imageView,that.$list.append(imageView.render()),KB.FrontendEditModal&&KB.FrontendEditModal.trigger("recalibrate")})},initialSetup:function(){var that=this,data=KB.Payload.getFieldData("gallery",this.parentModuleId,this.params.key,this.params.arrayKey);data.length>0&&_.each(data,function(image){var model=new Backbone.Model(image),imageView=new KB.Gallery.ImageView({model:model,parentView:that});that.subviews.push(imageView),that.$list.append(imageView.render())})},frontendSave:function(){var that=this;this.subviews.length>0&&_.each(this.subviews,function(m,i){m._remove&&(delete that.subviews[i],m.remove())})}}),KB.Fields.register("Image",function($){"use strict";var self;return self={selector:".kb-js-add-image",reset:".kb-js-reset-image",_frame:null,$container:null,$wrapper:null,$id:null,$title:null,$caption:null,init:function(){var that=this,$body=$("body");$body.on("click",this.selector,function(e){e.preventDefault(),that.setupInputs(this),that.settings=that.getSettings(this),that.openModal()}),$body.on("click",this.reset,function(){that.setupInputs(this),that.resetInputs()})},setupInputs:function(anchor){this.$wrapper=$(anchor).closest(".kb-field-image-wrapper"),this.$container=$(".kb-field-image-container",this.$wrapper),this.$id=$(".kb-js-image-id",this.$wrapper),this.$title=$(".kb-js-image-title",this.$wrapper),this.$description=$(".kb-js-image-description",this.$wrapper)},getSettings:function(el){var parent=$(el).closest(".kb-field-wrapper"),id=parent.attr("id");return KB.payload.Fields&&KB.payload.Fields[id]?KB.payload.Fields[id]:void 0},frame:function(){return this._frame?this._frame:void 0},openModal:function(){return this._frame?(this._frame.open(),void 0):(this._frame=wp.media({title:KB.i18n.Refields.image.modalTitle,button:{text:KB.i18n.Refields.common.select},multiple:!1,library:{type:"image"}}),this._frame.state("library").on("select",this.select),this._frame.open(),this._frame)},select:function(){var attachment=this.get("selection").first();self.handleAttachment(attachment)},handleAttachment:function(attachment){var args,src,that=this;this.settings&&this.settings.previewSize?(args={width:this.settings.previewSize[0],height:this.settings.previewSize[1],crop:!0,upscale:!1},jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:args,id:attachment.get("id"),_ajax_nonce:KB.Config.getNonce("read")},type:"GET",dataType:"json",success:function(res){that.$container.html('<img src="'+res+'" >')},error:function(){}})):(src=attachment.get("sizes").thumbnail?attachment.get("sizes").thumbnail.url:attachment.get("sizes").full.url,this.$container.html('<img src="'+src+'" >')),this.$id.val(attachment.get("id")),this.$title.val(attachment.get("title")),this.$description.val(attachment.get("caption")),$(document).trigger("KB:osUpdate")},resetInputs:function(){this.$container.empty(),this.$id.val(""),this.$title.val(""),this.$description("")},update:function(){this.init()},updateFront:function(){this.init()}}}(jQuery)),KB.Fields.register("Link",function($){var restore_htmlUpdate,restore_isMce,title,href;return{$input:null,init:function(){var that=this;$("body").on("click",".kb-js-add-link",function(e){e.preventDefault(),that.$input=$(this).prev().attr("id"),that.open()})},open:function(){var that=this;wpActiveEditor=this.$input,wpLink.open(),restore_htmlUpdate=wpLink.htmlUpdate,restore_isMce=wpLink.isMCE,wpLink.isMCE=function(){return!1},wpLink.htmlUpdate=function(){var attrs,textarea=wpLink.textarea;textarea&&(attrs=wpLink.getAttrs(),attrs.href&&"http://"!=attrs.href&&(href=attrs.href,title=attrs.title,jQuery(textarea).empty(),textarea.value=href,wpLink.close(),that.close(),textarea.focus()))}},close:function(){wpLink.isMCE=restore_isMce,wpLink.htmlUpdate=restore_htmlUpdate},update:function(){this.init()},updateFront:function(){this.init()}}}(jQuery)),KB.Fields.register("OpeningTimes",function($){return{init:function(){$(".otimes-field--stage",$("body")).each(function(index,el){var $el=$(el);$(".kb-ot-timepicker",$el).datetimepicker({datepicker:!1,format:"H:i",validateOnBlur:!1})}),$(".js-oday-activate-split").on("click",function(){$(this).parent().find("table").toggleClass("split")})},update:function(){this.init()},frontUpdate:function(modalView){this.init(modalView)}}}(jQuery)),KB.Fields.register("TemplateSelect",function($){return{init:function(){$("body").on("change",".kb-template-select",function(){KB.focusedModule&&(KB.focusedModule.set("viewfile",$(this).val()),KB.focusedModule.view.trigger("template::changed"))})},update:function(){}}}(jQuery));