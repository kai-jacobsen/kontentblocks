/*! Kontentblocks ProdVersion 2015-03-23 10:03 */
KB.FieldsAPI=function(){return{fields:{},register:function(a,b){this.fields[a]=b},get:function(a){return new(this.fields[a.model.get("type")])({model:new Backbone.Model(a.model.toJSON())})}}}(),KB.FieldsAPI.FieldStdModel=Backbone.Model.extend({}),KB.FieldsAPI.Field=Backbone.View.extend({initialize:function(){this.defaults=this.defaults||{},this.extendModel()},setValue:function(a){this.model.set("value",a)},prepareBaseId:function(){return _.isEmpty(this.model.get("arrayKey"))?this.model.get("fieldId")+"["+this.model.get("fieldKey")+"]":this.model.get("fieldId")+"["+this.model.get("arrayKey")+"]["+this.model.get("fieldKey")+"]"},prepareKpath:function(){var a=[];return this.model.get("arrayKey")&&a.push(this.model.get("arrayKey")),this.model.get("index")&&a.push(this.model.get("index")),this.model.get("fieldKey")&&a.push(this.model.get("fieldKey")),a.join(".")},extendModel:function(){this.model.set(this.defaults),this.model.set("baseId",this.prepareBaseId()),this.model.set("uid",this.kbfuid()),this.model.set("kpath",this.prepareKpath())},kbfuid:function(){return this.model.get("fieldId")+this.model.get("index")+this.model.get("type")}}),KB.FieldsAPI.Editor=KB.FieldsAPI.Field.extend({$editorWrap:null,templatePath:"fields/Editor",defaults:{std:"some textvalue",label:"Field label",description:"A description",value:"",key:null},initialize:function(a){KB.FieldsAPI.Field.prototype.initialize.call(this,a)},setValue:function(a){this.model.set("value",a)},render:function(a){return this.index=a,KB.Templates.render(this.templatePath,{config:this.config,baseId:this.baseId,index:a,model:this.model.toJSON()})},postRender:function(){var a=this.model.get("baseId")+"["+this.model.get("index")+"]["+this.model.get("primeKey")+"]",b=this.model.get("fieldId")+"_"+this.model.get("fieldKey")+"_editor_"+this.model.get("index");this.$editorWrap=jQuery(".kb-ff-editor-wrapper",this.$container),KB.TinyMCE.remoteGetEditor(this.$editorWrap,a,b,this.model.get("value"),5,!1)}}),KB.FieldsAPI.register("editor",KB.FieldsAPI.Editor),KB.FieldsAPI.Image=KB.FieldsAPI.Field.extend({$currentWrapper:null,$currentFrame:null,templatePath:"fields/Image",initialize:function(a){var b=this;KB.FieldsAPI.Field.prototype.initialize.call(this,a),this.config.$parent.on("click",".flexible-fields--js-add-image",function(){b.$currentWrapper=jQuery(this).closest(".field-api-image"),b.$currentFrame=jQuery(".field-api-image--frame",b.$currentWrapper),b.$IdInput=jQuery(".field-api-image--image-id",b.$currentWrapper),new KB.Utils.MediaWorkflow({title:"Hello",select:_.bind(b.handleAttachment,b)})})},defaults:{std:"",label:"Image",description:"Awesome image",value:{url:"",id:"",caption:"",title:""},key:null},render:function(a){return KB.Templates.render(this.templatePath,{config:this.config,baseId:this.baseId,index:a,model:this.model.toJSON(),i18n:_.extend(KB.i18n.Refields.image,KB.i18n.Refields.common)})},setValue:function(a){var b,c=this,d={width:150,height:150,upscale:!1,crop:!0};a.id&&(this.model.set("value",a),KB.Util.stex.get("img"+a.id+"x"+d.width+"x"+d.height)?(b=c.model.get("value"),b.url=KB.Util.stex.get("img"+a.id+"x"+d.width+"x"+d.height)):jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:d,id:a.id,_ajax_nonce:KB.Config.getNonce("read")},type:"POST",dataType:"json",async:!1,success:function(b){KB.Util.stex.set("img"+a.id+"x"+d.width+"x"+d.height,b.data.src,36e5);var e=c.model.get("value");e.url=b.data.src},error:function(){_K.error("Unable to get image")}}))},handleAttachment:function(a){var b=a.get("selection").first();b.get("sizes").thumbnail&&(this.$currentFrame.empty().append('<img src="'+b.get("sizes").thumbnail.url+'" >'),this.$IdInput.val(b.get("id")))}}),KB.FieldsAPI.register("image",KB.FieldsAPI.Image),KB.FieldsAPI.Link=KB.FieldsAPI.Field.extend({templatePath:"fields/Link",defaults:{std:{link:"",linktext:"",linktitle:""},label:"Link",description:"",key:null},render:function(){return KB.Templates.render(this.templatePath,{i18n:_.extend(KB.i18n.Refields.link,KB.i18n.Refields.common),model:this.model.toJSON()})}}),KB.FieldsAPI.register("link",KB.FieldsAPI.Link),KB.FieldsAPI.Text=KB.FieldsAPI.Field.extend({templatePath:"fields/Text",defaults:{std:"",label:"Field label",description:"A description",value:"",key:null},render:function(a){return KB.Templates.render(this.templatePath,{config:this.config,baseId:this.baseId,index:a,model:this.model.toJSON()})}}),KB.FieldsAPI.register("text",KB.FieldsAPI.Text),KB.FieldsAPI.Textarea=KB.FieldsAPI.Field.extend({defaults:{std:"some textvalue",label:"Field label",description:"A description",key:null},templatePath:"fields/Textarea",render:function(a){return KB.Templates.render(this.templatePath,{config:this.config,baseId:this.baseId,index:a,model:this.model.toJSON()})}}),KB.FieldsAPI.register("textarea",KB.FieldsAPI.Textarea);