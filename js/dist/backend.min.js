/*! kontentblocks 2013-11-02 */
"use strict";var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.AreasCollection=Backbone.Collection.extend({});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModulesCollection=Backbone.Collection.extend({});var KB=KB||{};KB.Ajax=function(a){return{send:function(b,c,d){b.supplemental=b.supplemental||{},b.count=parseInt(a("#kb_all_blocks").val()),b.nonce=a("#_kontentblocks_ajax_nonce").val(),b.post_id=parseInt(a("#post_ID").val())||-1,b.kbajax=!0,a(kbMetaBox).addClass("kb_loading"),a("#publish").attr("disabled","disabled"),a.ajax({url:ajaxurl,data:b,type:"POST",dataType:"json",success:function(b){if(b){var e=parseInt(a("#kb_all_blocks").val())+1;a("#kb_all_blocks").val(e),d?c.call(d,b):c(b)}},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){a(kbMetaBox).removeClass("kb_loading"),a("#publish").removeAttr("disabled")}})}}}(jQuery);var KB=KB||{};KB.Checks=function(a){return{blockLimit:function(a){var b=a.get("limit"),c=a.get("assignedModules").length;return 0===b?!1:c===b?!1:!0},userCan:function(b){var c=a.inArray(b,kontentblocks.caps);return-1!==c?!0:!1}}}(jQuery);var KB=KB||{};KB.Notice=function(){return{notice:function(a,b){alertify.log(a,b,3500)},confirm:function(a,b,c){alertify.confirm(a,function(a){a?b():c()})}}}(jQuery);var KB=KB||{};KB.Templates=function(a){function b(b,d){if(!c[b]){var e,f=kontentblocks.config.url+"js/templates",g=f+"/"+b+".html";a.ajax({url:g,method:"GET",async:!1,success:function(a){e=a}}),c[b]=_.template(e)}return c[b](d)}var c={};return{render:b}}(jQuery);var KB=KB||{};KB.ViewsCollection=function(){this.views={},this.add=function(a,b){this.views[a]=b},this.remove=function(a){var b=this.get(a);b.$el.fadeOut(500,function(){b.remove()}),delete this.views[a]},this.get=function(a){return this.views[a]?this.views[a]:void 0}};var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"});var KB=KB||{};KB.Backbone.ModuleMenuTileModel=Backbone.Model.extend({defaults:{template:!1,master:!1,duplicate:!1}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var a=this;KB.Ajax.send({action:"removeModules",instance_id:a.get("instance_id")},a.destroyed)},destroyed:function(){console.log(this)}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.AreaModuleMenuView=Backbone.View.extend({tilesViews:[],initialize:function(){var a=this,b=jQuery(".block-nav-item",this.$el);b.length>0&&_.each(b,function(b){a.tilesViews.push(new KB.Backbone.ModuleMenuTileView({model:new KB.Backbone.ModuleMenuTileModel(jQuery(b).data()),el:b,area:a.options.area,parentView:a.options.parentView}))})}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.AreaView=Backbone.View.extend({initialize:function(){this.controlsContainer=jQuery(".add-modules",this.$el),this.modulesList=jQuery("#"+this.model.get("id")+"-list",this.$el),this.render()},events:{"click .modules-link":"openModulesMenu"},render:function(){this.addControls()},addControls:function(){this.controlsContainer.append(KB.Templates.render("be_areaAddModule",{}))},openModulesMenu:function(){var a=this;KB.openedModal=vex.open({content:jQuery("#"+a.model.get("id")+"-nav").html(),afterOpen:function(){KB.menutabs(),a.menuView=new KB.Backbone.AreaModuleMenuView({el:this.$vexContent,area:a.model.get("id"),parentView:a})},afterClose:function(){a.menuView.remove()},contentClassName:"modules-menu"})||null}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleMenuItemView=Backbone.View.extend({tagName:"div",className:"",isValid:function(){return!0}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleDelete=KB.Backbone.ModuleMenuItemView.extend({className:"kb-delete block-menu-icon",initialize:function(){_.bindAll(this,"yes","no")},events:{click:"deleteModule"},deleteModule:function(){KB.Notice.confirm("Really?",this.yes,this.no)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("delete_kontentblocks")?!1:!0},yes:function(){KB.Ajax.send({action:"removeModules",module:this.model.get("instance_id")},this.success.call(this))},no:function(){return!1},success:function(){KB.Modules.remove(this.model),KB.Notice.notice("Good bye","success")}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleDuplicate=KB.Backbone.ModuleMenuItemView.extend({className:"kb-duplicate block-menu-icon",events:{click:"duplicateModule"},duplicateModule:function(){console.log(KB)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("edit_kontentblocks")?!1:!0}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleStatus=KB.Backbone.ModuleMenuItemView.extend({initialize:function(){var a=this;this.options.parent.$el.on("click",".js-module-status",function(){a.changeStatus()})},className:"module-status block-menu-icon",events:{click:"changeStatus"},changeStatus:function(){this.options.parent.$head.toggleClass("module-inactive"),this.options.parent.$el.toggleClass("kb_inactive"),KB.Ajax.send({action:"changeModuleStatus",module:this.model.get("instance_id")},this.success.call(this))},isValid:function(){return!this.model.get("disabled")&&KB.Checks.userCan("deactivate_kontentblocks")?!0:!1},success:function(){console.log(this.model),KB.Notice.notice("Status changed","success")}});var KB=KB||{};KB.Backbone.ModuleMenuTileView=Backbone.View.extend({events:{click:"createModule"},createModule:function(){KB.Checks.userCan("create_kontentblocks")?KB.Notice.notice("Yeah","success"):KB.Notice.notice("Oh well","error");var a=KB.Areas.get(this.options.area);if(KB.Checks.blockLimit(a))return KB.Notice.notice("Limit for this area reached","error"),!1;vex.close(KB.openedModal.data().vex.id);var b={action:"createNewModule",type:this.model.get("type"),master:this.model.get("master"),template:this.model.get("template"),duplicate:this.model.get("duplicate"),page_template:KB.Screen.page_template,post_type:KB.Screen.post_type,area_context:this.model.get("context"),area:this.options.area};KB.Ajax.send(b,this.success,this)},success:function(a){this.options.parentView.modulesList.append(a.html),KB.Modules.add(a.module)}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleMenuView=Backbone.View.extend({$menuWrap:null,$menuList:null,events:{},initialize:function(){this.$menuWrap=jQuery(".menu-wrap",this.$el),this.$menuWrap.append(KB.Templates.render("be_moduleMenu",{})),this.$menuList=jQuery(".kb_the_menu",this.$menuWrap)},addItem:function(a){if(a.isValid&&a.isValid()===!0){var b=jQuery("<li></li>").appendTo(this.$menuList),c=b.append(a.el);this.$menuList.append(c)}}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleView=Backbone.View.extend({$head:null,$body:null,ModuleMenu:null,initialize:function(){this.$head=jQuery(".block-head",this.$el),this.$body=jQuery(".kb_inner",this.$el),this.ModuleMenu=new KB.Backbone.ModuleMenuView({el:this.$head,parent:this}),this.setupDefaultMenuItems()},setupDefaultMenuItems:function(){this.ModuleMenu.addItem(new KB.Backbone.ModuleStatus({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDelete({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDuplicate({model:this.model,parent:this}))}});var KB=KB||{};KB.Views={Modules:new KB.ViewsCollection,Areas:{}},KB.Modules=new KB.Backbone.ModulesCollection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new KB.Backbone.AreasCollection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function a(){KB.Modules.on("add",c),KB.Areas.on("add",d),KB.Modules.on("remove",e),b()}function b(){_.each(KB.RawAreas,function(a){KB.Areas.add(new KB.Backbone.AreaModel(a)),a.modules&&_.each(a.modules,function(a){KB.Modules.add(a)})})}function c(a){KB.Views.Modules.add(a.get("instance_id"),new KB.Backbone.ModuleView({model:a,el:"#"+a.get("instance_id")}))}function d(a){KB.Views.Areas[a.get("id")]=new KB.Backbone.AreaView({model:a,el:"#"+a.get("id")})}function e(a){KB.Views.Modules.remove(a.get("instance_id"))}return{init:a}}(jQuery),KB.App.init();