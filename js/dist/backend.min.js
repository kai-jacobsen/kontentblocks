/*! kontentblocks 2013-10-28 */
"use strict";var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.AreasCollection=Backbone.Collection.extend({});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModulesCollection=Backbone.Collection.extend({});var KB=KB||{};KB.Ajax=function(a){return{send:function(b,c){var d=a("#_kontentblocks_ajax_nonce").val(),e=a("#post_ID").val();b._kb_nonce=d,b.post_id=e,b.kbajax="true",a(kbMetaBox).addClass("kb_loading"),a("#publish").attr("disabled","disabled"),a.ajax({url:ajaxurl,data:b,type:"POST",dataType:"json",success:function(a){},error:function(){KB.notice("<p>Generic Ajax Error</p>","error")},complete:function(){a(kbMetaBox).removeClass("kb_loading"),a("#publish").removeAttr("disabled")}})}}}(jQuery);var KB=KB||{};KB.Caps=function(a){return{userCan:function(b){var c=a.inArray(b,kontentblocks.caps);return-1!==c?!0:!1}}}(jQuery);var KB=KB||{};KB.Notice=function(){return{notice:function(a,b){alertify.log(a,b,3500)},confirm:function(a,b,c){alertify.confirm(a,function(a){a?b():c()})}}}(jQuery);var KB=KB||{};KB.Templates=function(a){function b(b,d){if(!c[b]){var e,f=kontentblocks.config.url+"js/templates",g=f+"/"+b+".html";a.ajax({url:g,method:"GET",async:!1,success:function(a){e=a}}),c[b]=_.template(e)}return c[b](d)}var c={};return{render:b}}(jQuery);var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var a=this;KB.Ajax.send({action:"removeModules",instance_id:a.get("instance_id")},a.destroyed)},destroyed:function(){console.log(this)}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleMenuItemView=Backbone.View.extend({tagName:"div",className:"",isValid:function(){return!0}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleDelete=KB.Backbone.ModuleMenuItemView.extend({className:"kb-delete block-menu-icon",initialize:function(){_.bindAll(this,"yes","no")},events:{click:"deleteModule"},deleteModule:function(){KB.Notice.confirm("Really?",this.yes,this.no)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Caps.userCan("delete_kontentblocks")?!1:!0},yes:function(){KB.Ajax.send({action:"removeModules",module:this.model.get("instance_id")},this.success.call(this))},no:function(){return!1},success:function(){KB.Notice.notice("Good bye","success"),this.options.parent.$el.hide(500)}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleDuplicate=KB.Backbone.ModuleMenuItemView.extend({className:"kb-duplicate block-menu-icon",events:{click:"duplicateModule"},duplicateModule:function(){KB.Notice.notice("Duplicate Module","success",4500)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Caps.userCan("edit_kontentblocks")?!1:!0}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleStatus=KB.Backbone.ModuleMenuItemView.extend({initialize:function(){var a=this;this.options.parent.$el.on("click",".js-module-status",function(){a.changeStatus()})},className:"module-status block-menu-icon",events:{click:"changeStatus"},changeStatus:function(){this.options.parent.$head.toggleClass("module-inactive"),this.options.parent.$el.toggleClass("kb_inactive"),KB.Ajax.send({action:"changeModuleStatus",module:this.model.get("instance_id")},this.success.call(this))},isValid:function(){return!this.model.get("disabled")&&KB.Caps.userCan("deactivate_kontentblocks")?!0:!1},success:function(){console.log(this.model),KB.Notice.notice("Status changed","success")}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleMenuView=Backbone.View.extend({$menuWrap:null,$menuList:null,events:{},initialize:function(){this.$menuWrap=jQuery(".menu-wrap",this.$el),this.$menuWrap.append(KB.Templates.render("be_moduleMenu",{})),this.$menuList=jQuery(".kb_the_menu",this.$menuWrap)},addItem:function(a){if(a.isValid&&a.isValid()===!0){var b=jQuery("<li></li>").appendTo(this.$menuList),c=b.append(a.el);this.$menuList.append(c)}}});var KB=KB||{};KB.Backbone=KB.Backbone||{},KB.Backbone.ModuleView=Backbone.View.extend({$head:null,$body:null,ModuleMenu:null,initialize:function(){this.$head=jQuery(".block-head",this.$el),this.$body=jQuery(".kb_inner",this.$el),this.ModuleMenu=new KB.Backbone.ModuleMenuView({el:this.$head,parent:this}),this.setupDefaultMenuItems()},setupDefaultMenuItems:function(){this.ModuleMenu.addItem(new KB.Backbone.ModuleStatus({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDelete({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDuplicate({model:this.model,parent:this}))}});var KB=KB||{};KB.Views={},KB.Modules=new KB.Backbone.ModulesCollection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new KB.Backbone.AreasCollection(_.toArray(KB.RawAreas),{model:KB.Backbone.AreaModel}),KB.App=function(){function a(){KB.Modules.on("add",c),b()}function b(){_.each(KB.RawAreas,function(a){a.modules&&_.each(a.modules,function(a){KB.Modules.add(new KB.Backbone.ModuleModel(a))})})}function c(a){KB.Views[a.get("instance_id")]=new KB.Backbone.ModuleView({model:a,el:"#"+a.get("instance_id")})}return{init:a}}(jQuery),KB.App.init();