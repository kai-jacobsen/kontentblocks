/*! Kontentblocks ProdVersion 2014-03-23 08:03 */
KB.Backbone.ModulesDefinitionsCollection=Backbone.Collection.extend({setup:function(){return this.categories=this.prepareCategories(),this.sortToCategories(),this},getModules:function(a){return this.categories[a].modules},sortToCategories:function(){var a=this;_.each(this.models,function(b){if(b.get("settings").hidden!==!0){var c=_.isUndefined(b.get("settings").category)?"standard":b.get("settings").category;a.categories[c].modules.push(b)}})},prepareCategories:function(){var a={};return _.each(KB.payload.ModuleCategories,function(b,c){a[c]={id:c,name:b,modules:[]}}),a}}),KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var a=this;KB.Ajax.send({action:"removeModules",instance_id:a.get("instance_id")},a.destroyed)},destroyed:function(){},setArea:function(a){this.area=a},areaChanged:function(){var a=this.get("envVars");a.areaContext=this.get("areaContext"),this.view.updateModuleForm()}}),KB.Backbone.ModuleDefinition=Backbone.Model.extend({initialize:function(){var a=this;this.id=function(){return"template"===a.get("settings").category?a.get("instance_id"):a.get("settings").class}()}}),KB.Backbone.ModuleBrowserModuleDescription=Backbone.View.extend({initialize:function(a){this.options=a||{},this.options.browser.on("browser:close",this.close,this)},update:function(){this.$el.empty(),this.$el.html(KB.Templates.render("backend/modulebrowser/module-description",{module:this.model.toJSON()})),this.model.get("settings").helpfile!==!1&&this.$el.append(KB.Templates.render(this.model.get("settings").helpfile,{module:this.model.toJSON()}))},close:function(){}}),KB.Backbone.ModuleBrowserListItem=Backbone.View.extend({tagName:"li",className:"modules-list-item",initialize:function(a){this.options=a||{}},render:function(a){this.model.get("tpldef")?this.$el.html(KB.Templates.render("backend/modulebrowser/module-template-list-item",{module:this.model.toJSON()})):this.$el.html(KB.Templates.render("backend/modulebrowser/module-list-item",{module:this.model.toJSON()})),a.append(this.$el)},events:{click:"loadDetails","click .kb-js-create-module":"createModule"},loadDetails:function(){console.log(this),this.options.browser.loadDetails(this.model)},createModule:function(){this.options.browser.createModule(this.model)},close:function(){this.remove()}}),KB.Backbone.ModuleBrowserModulesList=Backbone.View.extend({initialize:function(a){this.options=a||{}},modules:{},subviews:{},setModules:function(a){return this.modules=a,this},update:function(){var a=this,b=!1;this.$el.empty(),_.each(this.modules,function(c){a.subviews[c.cid]=new KB.Backbone.ModuleBrowserListItem({model:c,parent:a,browser:a.options.browser}),b===!1&&(a.options.browser.loadDetails(c),b=!b),a.$el.append(a.subviews[c.cid].render(a.$el))})}}),KB.Backbone.ModuleBrowser=Backbone.View.extend({initialize:function(a){this.options=a||{}},tagName:"div",id:"module-browser",className:"kb-overlay",events:{"click .close-browser":"close"},subviews:{},render:function(){this.area=this.options.area,this.modulesDefinitions=new KB.Backbone.ModulesDefinitionsCollection(this.prepareAssignedModules(),{model:KB.Backbone.ModuleDefinition}).setup(),this.open()},open:function(){this.$el.appendTo("body"),jQuery("#wpwrap").addClass("module-browser-open"),this.$el.append(KB.Templates.render("backend/modulebrowser/module-browser",{})),this.subviews.ModulesList=new KB.Backbone.ModuleBrowserModulesList({el:jQuery(".modules-list",this.$el),browser:this}),this.subviews.ModuleDescription=new KB.Backbone.ModuleBrowserModuleDescription({el:jQuery(".module-description",this.$el),browser:this}),this.subviews.Navigation=new KB.Backbone.ModuleBrowserNavigation({el:jQuery(".module-categories",this.$el),cats:this.modulesDefinitions.categories}),this.listenTo(this.subviews.Navigation,"browser:change",this.update),this.listenTo(this.subviews.ModulesList,"createModule",this.createModule)},close:function(){jQuery("#wpwrap").removeClass("module-browser-open"),this.trigger("browser:close"),this.unbind(),this.remove(),delete this.$el},update:function(a){var b=a.get("id"),c=this.modulesDefinitions.getModules(b);this.subviews.ModulesList.setModules(c).update()},loadDetails:function(a){this.subviews.ModuleDescription.model=a,this.subviews.ModuleDescription.update()},createModule:function(a){KB.Checks.userCan("create_kontentblocks")||KB.Notice.notice("You're not allowed to do this","error");var b=KB.Areas.get(this.options.area.model.get("id"));if(!KB.Checks.blockLimit(b))return console.log("block limit reached"),KB.Notice.notice("Limit for this area reached","error"),!1;var c={action:"createNewModule","class":a.get("settings").class,master:a.get("master"),master_id:a.get("master_id"),template:a.get("template"),templateObj:a.get("templateObj"),duplicate:a.get("duplicate"),areaContext:this.options.area.model.get("context"),area:this.options.area.model.get("id"),_ajax_nonce:kontentblocks.nonces.create};this.close(),KB.Ajax.send(c,this.success,this)},success:function(a){this.options.area.modulesList.append(a.html),KB.lastAddedModule=new KB.Backbone.ModuleModel(a.module),KB.Modules.add(KB.lastAddedModule),KB.TinyMCE.addEditor(),setTimeout(function(){KB.Fields.trigger("update")},500);var b=parseInt(jQuery("#kb_all_blocks").val(),10)+1;jQuery("#kb_all_blocks").val(b)},prepareAssignedModules:function(){var a=this.area.model.get("assignedModules"),b=[];return _.each(KB.payload.ModuleDefinitions,function(c){-1!==_.indexOf(a,c.settings.class)&&b.push(c)}),b}}),KB.Backbone.ModuleBrowserNavigation=Backbone.View.extend({item:Backbone.View.extend({initialize:function(a){this.options=a||{}},tagName:"li",className:"cat-item",events:{click:"change"},change:function(){this.options.parent.trigger("browser:change",this.model),this.$el.addClass("active"),jQuery("li").not(this.$el).removeClass("active")},render:function(){var a=_.keys(this.model.get("modules")).length,b="("+a+")";return 0===a?!1:(this.options.parent.catSet===!1&&(this.options.parent.catSet=!0,KB.ModuleBrowser.update(this.model),this.$el.addClass("active")),this.options.parent.$list.append(this.$el.html(this.model.get("name")+'<span class="module-count">'+b+"</span>")),void 0)}}),catSet:!1,initialize:function(a){var b=this;this.options=a||{},this.$list=jQuery("<ul></ul>").appendTo(this.$el),_.each(this.options.cats,function(a){var c=new Backbone.Model(a);new b.item({parent:b,model:c}).render()})}}),KB.Backbone.ModuleMenuItemView=Backbone.View.extend({tagName:"div",className:"",isValid:function(){return!0}}),KB.Backbone.ModuleDelete=KB.Backbone.ModuleMenuItemView.extend({className:"kb-delete block-menu-icon",initialize:function(){_.bindAll(this,"yes","no")},events:{click:"deleteModule"},deleteModule:function(){KB.Notice.confirm("Really?",this.yes,this.no)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("delete_kontentblocks")?!1:!0},yes:function(){KB.Ajax.send({action:"removeModules",_ajax_nonce:kontentblocks.nonces.delete,module:this.model.get("instance_id")},this.success,this)},no:function(){return!1},success:function(){KB.Modules.remove(this.model),wp.heartbeat.interval("fast",2)}}),KB.Backbone.ModuleDuplicate=KB.Backbone.ModuleMenuItemView.extend({className:"kb-duplicate block-menu-icon",events:{click:"duplicateModule"},duplicateModule:function(){KB.Ajax.send({action:"duplicateModule",module:this.model.get("instance_id"),areaContext:this.model.area.get("context"),_ajax_nonce:kontentblocks.nonces.create,"class":this.model.get("class")},this.success,this)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("edit_kontentblocks")?!1:!0},success:function(a){if(-1===a)return KB.Notice.notice("Request Error","error"),!1;this.model.area.view.modulesList.append(a.html),KB.Modules.add(a.module);var b=parseInt(jQuery("#kb_all_blocks").val(),10)+1;jQuery("#kb_all_blocks").val(b),KB.Notice.notice("Module Duplicated","success"),KB.Ui.repaint("#"+a.module.instance_id)}}),KB.Backbone.ModuleStatus=KB.Backbone.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{}},className:"module-status block-menu-icon",events:{click:"changeStatus"},changeStatus:function(){KB.Ajax.send({action:"changeModuleStatus",module:this.model.get("instance_id"),_ajax_nonce:kontentblocks.nonces.update},this.success,this)},isValid:function(){return!this.model.get("disabled")&&KB.Checks.userCan("deactivate_kontentblocks")?!0:!1},success:function(){this.options.parent.$head.toggleClass("module-inactive"),this.options.parent.$el.toggleClass("activated deactivated"),KB.Notice.notice("Status changed","success")}}),KB.Backbone.ModuleMenuView=Backbone.View.extend({$menuWrap:null,$menuList:null,initialize:function(){this.$menuWrap=jQuery(".menu-wrap",this.$el),this.$menuWrap.append(KB.Templates.render("backend/module-menu",{})),this.$menuList=jQuery(".module-actions",this.$menuWrap)},addItem:function(a){if(a.isValid&&a.isValid()===!0){var b=jQuery("<li></li>").appendTo(this.$menuList),c=b.append(a.el);this.$menuList.append(c)}}}),KB.Backbone.AreaView=Backbone.View.extend({initialize:function(){this.controlsContainer=jQuery(".add-modules",this.$el),this.settingsContainer=jQuery(".kb-area-settings-wrapper",this.$el),this.modulesList=jQuery("#"+this.model.get("id"),this.$el),this.model.view=this,this.render()},events:{"click .modules-link":"openModuleBrowser","click .js-area-settings-opener":"toggleSettings",mouseenter:"setActive"},render:function(){this.addControls()},addControls:function(){this.controlsContainer.append(KB.Templates.render("backend/area-add-module",{}))},openModuleBrowser:function(a){a.preventDefault(),KB.ModuleBrowser=null,KB.ModuleBrowser||(KB.ModuleBrowser=new KB.Backbone.ModuleBrowser({area:this})),KB.ModuleBrowser.render()},toggleSettings:function(a){a.preventDefault(),this.settingsContainer.slideToggle().toggleClass("open"),KB.currentArea=this.model},setActive:function(){KB.currentArea=this.model}}),KB.Backbone.ModuleView=Backbone.View.extend({$head:null,$body:null,ModuleMenu:null,instanceId:null,events:{"click.kb1 .kb-toggle":"toggleBody","click.kb2 .kb-toggle":"setOpenStatus",mouseenter:"setFocusedModule",dblclick:"fullscreen","click .kb-fullscreen":"fullscreen"},setFocusedModule:function(){KB.focusedModule=this.model},initialize:function(){this.$head=jQuery(".block-head",this.$el),this.$body=jQuery(".kb_inner",this.$el),this.instanceId=this.model.get("instance_id"),this.ModuleMenu=new KB.Backbone.ModuleMenuView({el:this.$el,parent:this}),store.get(this.instanceId+"_open")&&(this.toggleBody(),this.model.set("open",!0)),this.model.view=this,this.setupDefaultMenuItems(),KB.Views.Modules.on("kb:backend::viewDeleted",function(a){a.$el.fadeOut(500,function(){a.$el.remove()})})},setupDefaultMenuItems:function(){this.ModuleMenu.addItem(new KB.Backbone.ModuleDuplicate({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDelete({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleStatus({model:this.model,parent:this}))},toggleBody:function(a){var b=a||400;KB.Checks.userCan("edit_kontentblocks")&&(this.$body.slideToggle(b),this.$el.toggleClass("kb-open"),KB.currentModule=this.model)},setOpenStatus:function(){this.model.set("open",!this.model.get("open")),store.set(this.model.get("instance_id")+"_open",this.model.get("open"))},updateModuleForm:function(){KB.Ajax.send({action:"afterAreaChange",module:this.model.toJSON()},this.insertNewUpdateForm,this)},insertNewUpdateForm:function(a){""!==a?this.$body.html(a):this.$body.html("empty"),KB.Ui.repaint(this.$el),this.trigger("kb:backend::viewUpdated")},fullscreen:function(){var a=this;this.sizeTimer=null;var b=jQuery("#kontentblocks_stage");b.addClass("fullscreen");var c=jQuery(".fullscreen--title-wrapper",b);c.empty().append("<span class='dashicon fullscreen--close'></span><h2>"+this.model.get("settings").name+"</h2>").show(),jQuery(".fullscreen--close").on("click",_.bind(this.closeFullscreen,this)),this.$el.addClass("fullscreen-module"),jQuery("#post-body").removeClass("columns-2").addClass("columns-1"),this.model.get("open")||(this.setOpenStatus(),this.toggleBody()),this.sizeTimer=setInterval(function(){var c=jQuery(".kb_inner",a.$el).height()+150;b.height(c)},750)},closeFullscreen:function(){var a=jQuery("#kontentblocks_stage");a.removeClass("fullscreen"),clearInterval(this.sizeTimer),this.$el.removeClass("fullscreen-module"),jQuery("#post-body").removeClass("columns-1").addClass("columns-2"),jQuery(".fullscreen--title-wrapper",a).hide(),a.css("height","100%")}}),_.extend(KB,Backbone.Events),KB.currentModule={},KB.currentArea={},KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function a(){KB.Modules.on("add",c),KB.Areas.on("add",d),KB.Modules.on("remove",e),b(),KB.Ui.init()}function b(){_.each(KB.payload.Areas,function(a){KB.Areas.add(new KB.Backbone.AreaModel(a))}),_.each(KB.payload.Modules,function(a){KB.Modules.add(a)})}function c(a){a.setArea(KB.Areas.get(a.get("area"))),a.bind("change:area",a.areaChanged),KB.Views.Modules.add(a.get("instance_id"),new KB.Backbone.ModuleView({model:a,el:"#"+a.get("instance_id")})),KB.Ui.initTabs()}function d(a){KB.Views.Areas.add(a.get("id"),new KB.Backbone.AreaView({model:a,el:"#"+a.get("id")+"-container"}))}function e(a){KB.Views.Modules.remove(a.get("instance_id"))}return{init:a}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&!KB.appData.config.frontend&&(_K.info("Backend Modules Ready Event fired"),KB.Views.Modules.ready())});