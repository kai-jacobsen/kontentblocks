/*! Kontentblocks ProdVersion 2015-03-02 11:03 */
KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ContextModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ModuleDefinition=Backbone.Model.extend({initialize:function(){var a=this;this.id=function(){return"template"===a.get("settings").category?a.get("instance_id"):a.get("settings")["class"]}()}}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"mid",initialize:function(){this.listenTo(this,"change:envVars",this.areaChanged),this.subscribeToArea()},destroy:function(){this.unsubscribeFromArea(),this.stopListening()},setArea:function(a){this.setEnvVar("area",a.get("id")),this.set("area",a.get("id")),this.setEnvVar("areaContext",a.get("areaContext")),this.set("areaContext",a.get("areaContext")),this.Area=a,this.subscribeToArea(a),this.areaChanged()},areaChanged:function(){this.View.updateModuleForm()},subscribeToArea:function(a){a||(a=KB.Areas.get(this.get("area"))),a&&(a.View.attachModuleView(this),this.Area=a)},unsubscribeFromArea:function(){this.Area.View.removeModule(this)},setEnvVar:function(a,b){var c=_.clone(this.get("envVars"));c[a]=b,this.set("envVars",c)}}),KB.Backbone.PanelModel=Backbone.Model.extend({idAttribute:"baseId"}),KB.Backbone.Backend.AreaView=Backbone.View.extend({initialize:function(){this.attachedModuleViews={},this.controlsContainer=jQuery(".add-modules",this.$el),this.settingsContainer=jQuery(".kb-area-settings-wrapper",this.$el),this.modulesList=jQuery("#"+this.model.get("id"),this.$el),this.$placeholder=jQuery(KB.Templates.render("backend/area-item-placeholder",{i18n:KB.i18n})),this.model.View=this,this.listenTo(this,"module:attached",this.ui),this.listenTo(this,"module:dettached",this.ui),this.render()},events:{"click .modules-link":"openModuleBrowser","click .js-area-settings-opener":"toggleSettings",mouseenter:"setActive"},render:function(){this.addControls(),this.ui()},addControls:function(){this.controlsContainer.append(KB.Templates.render("backend/area-add-module",{i18n:KB.i18n}))},openModuleBrowser:function(a){a.preventDefault(),this.ModuleBrowser||(this.ModuleBrowser=new KB.Backbone.ModuleBrowser({area:this})),this.ModuleBrowser.render()},toggleSettings:function(a){a.preventDefault(),this.settingsContainer.slideToggle().toggleClass("open"),KB.currentArea=this.model},setActive:function(){KB.currentArea=this.model},attachModuleView:function(a){this.attachedModuleViews[a.id]=a.View,this.listenTo(a,"change:area",this.removeModule),this.trigger("module:attached",a)},removeModule:function(a){var b;b=a.id,this.attachedModuleViews[b]&&(delete this.attachedModuleViews[b],this.stopListening(a,"change:area",this.removeModule)),this.trigger("module:dettached",a)},ui:function(){var a;a=_.size(this.attachedModuleViews),0===a?this.renderPlaceholder():this.$placeholder.remove()},renderPlaceholder:function(){this.modulesList.before(this.$placeholder)}}),KB.Backbone.Backend.ModuleControlsView=Backbone.View.extend({$menuWrap:{},$menuList:{},initialize:function(){this.$menuWrap=jQuery(".menu-wrap",this.$el),this.$menuWrap.append(KB.Templates.render("backend/module-menu",{})),this.$menuList=jQuery(".module-actions",this.$menuWrap)},addItem:function(a){if(a.isValid&&a.isValid()===!0){var b=jQuery("<li></li>").appendTo(this.$menuList),c=b.append(a.el);this.$menuList.append(c)}}}),KB.Backbone.Backend.ModuleMenuItemView=Backbone.View.extend({tagName:"div",className:"",isValid:function(){return!0}}),KB.Backbone.Backend.ModuleDelete=KB.Backbone.Backend.ModuleMenuItemView.extend({className:"kb-delete block-menu-icon",initialize:function(){_.bindAll(this,"yes","no")},events:{click:"deleteModule"},deleteModule:function(){KB.Notice.confirm(KB.i18n.EditScreen.notices.confirmDeleteMsg,this.yes,this.no,this)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("delete_kontentblocks")?!1:!0},yes:function(){KB.Ajax.send({action:"removeModules",_ajax_nonce:KB.Config.getNonce("delete"),module:this.model.get("instance_id")},this.success,this)},no:function(){return!1},success:function(a){a.success?(KB.Modules.remove(this.model),wp.heartbeat.interval("fast",2),this.model.destroy()):KB.Notice.notice("Error while removing a module","error")}}),KB.Backbone.Backend.ModuleDuplicate=KB.Backbone.Backend.ModuleMenuItemView.extend({className:"kb-duplicate block-menu-icon",events:{click:"duplicateModule"},duplicateModule:function(){KB.Ajax.send({action:"duplicateModule",module:this.model.get("mid"),areaContext:this.model.Area.get("context"),_ajax_nonce:KB.Config.getNonce("create"),"class":this.model.get("class")},this.success,this)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("edit_kontentblocks")?!1:!0},success:function(a){if(!a.success)return KB.Notice.notice("Request Error","error"),!1;this.parseAdditionalJSON(a.data.json),this.model.Area.View.modulesList.append(a.data.html);var b=KB.Modules.add(a.data.module);this.model.Area.View.attachModuleView(b),KB.Notice.notice("Module Duplicated","success"),KB.Ui.repaint("#"+a.data.module.mid),KB.Fields.trigger("update")},parseAdditionalJSON:function(a){KB.payload.Fields||(KB.payload.Fields={}),_.extend(KB.payload.Fields,a.Fields),KB.payload.fieldData||(KB.payload.fieldData={}),_.extend(KB.payload.fieldData,a.fieldData),KB.Payload.parseAdditionalJSON(a)}}),KB.Backbone.Backend.ModuleSave=KB.Backbone.Backend.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{},this.parentView=a.parent,this.listenTo(this.parentView,"kb::module.input.changed",this.getDirty),this.listenTo(this.parentView,"kb::module.data.updated",this.getClean)},className:"kb-save block-menu-icon",events:{click:"saveData"},saveData:function(){tinyMCE.triggerSave(),KB.Ajax.send({action:"updateModuleData",module:this.model.toJSON(),data:this.parentView.serialize(),_ajax_nonce:KB.Config.getNonce("update")},this.success,this)},getDirty:function(){this.$el.addClass("is-dirty")},getClean:function(){this.$el.removeClass("is-dirty")},isValid:function(){return this.model.get("master")?!1:!this.model.get("disabled")&&KB.Checks.userCan("edit_kontentblocks")},success:function(a){a&&a.data.newModuleData||_K.error("Failed to save module data."),this.parentView.model.set("moduleData",a.data.newModuleData),KB.Notice.notice("Data saved","success")}}),KB.Backbone.Backend.ModuleStatus=KB.Backbone.Backend.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{}},className:"module-status block-menu-icon",events:{click:"changeStatus"},changeStatus:function(){KB.Ajax.send({action:"changeModuleStatus",module:this.model.get("instance_id"),_ajax_nonce:KB.Config.getNonce("update")},this.success,this)},isValid:function(){return!this.model.get("disabled")&&KB.Checks.userCan("deactivate_kontentblocks")?!0:!1},success:function(){this.options.parent.$head.toggleClass("module-inactive"),this.options.parent.$el.toggleClass("activated deactivated"),KB.Notice.notice("Status changed","success")}}),KB.Backbone.Backend.ModuleView=Backbone.View.extend({$head:{},$body:{},ModuleMenu:{},instanceId:"",events:{"click.kb1 .kb-toggle":"toggleBody","click.kb2 .kb-toggle":"setOpenStatus",mouseenter:"setFocusedModule",dblclick:"fullscreen","click .kb-fullscreen":"fullscreen","change .kb-template-select":"viewfileChange","change input,textarea,select":"handleChange","tinymce.change":"handleChange"},setFocusedModule:function(){KB.focusedModule=this.model},handleChange:function(){this.trigger("kb::module.input.changed",this)},viewfileChange:function(a){this.model.set("viewfile",a.currentTarget.value),this.clearFields(),this.updateModuleForm(),this.trigger("KB::backend.module.viewfile.changed")},initialize:function(){console.log(this),this.$head=jQuery(".kb-module__header",this.$el),this.$body=jQuery(".kb-module__body",this.$el),this.$inner=jQuery(".kb-module__controls-inner",this.$el),this.attachedFields={},this.instanceId=this.model.get("instance_id"),this.ModuleMenu=new KB.Backbone.Backend.ModuleControlsView({el:this.$el,parent:this}),store.get(this.instanceId+"_open")&&(this.toggleBody(),this.model.set("open",!0)),this.model.View=this,this.setupDefaultMenuItems(),KB.Views.Modules.on("kb.modules.view.deleted",function(a){a.$el.fadeOut(500,function(){a.$el.remove()})})},setupDefaultMenuItems:function(){this.ModuleMenu.addItem(new KB.Backbone.Backend.ModuleSave({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.Backend.ModuleDuplicate({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.Backend.ModuleDelete({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.Backend.ModuleStatus({model:this.model,parent:this}))},toggleBody:function(a){var b=a||400;KB.Checks.userCan("edit_kontentblocks")&&(this.$body.slideToggle(b),this.$el.toggleClass("kb-open"),KB.currentModule=this.model)},setOpenStatus:function(){this.model.set("open",!this.model.get("open")),store.set(this.model.get("instance_id")+"_open",this.model.get("open"))},updateModuleForm:function(){KB.Ajax.send({action:"afterAreaChange",module:this.model.toJSON(),_ajax_nonce:KB.Config.getNonce("read")},this.insertNewUpdateForm,this)},insertNewUpdateForm:function(a){this.$inner.html(a.success?a.data.html:"empty"),a.data.json.Fields&&(KB.payload.Fields=_.extend(KB.payload.Fields,a.data.json.Fields)),KB.Ui.repaint(this.$el),KB.Fields.trigger("update"),this.trigger("kb:backend::viewUpdated"),this.model.trigger("after.change.area")},fullscreen:function(){var a=this;this.sizeTimer=null;var b=jQuery("#kontentblocks-core-ui");b.addClass("fullscreen");var c=jQuery(".fullscreen--title-wrapper",b),d=jQuery(".fullscreen--description-wrapper",b),e=this.$el.find(".block-title").val();c.empty().append("<span class='dashicon fullscreen--close'></span><h2>"+e+"</h2>").show(),d.empty().append("<p class='description'>"+this.model.get("settings").description+"</p>").show(),jQuery(".fullscreen--close").on("click",_.bind(this.closeFullscreen,this)),this.$el.addClass("fullscreen-module"),jQuery("#post-body").removeClass("columns-2").addClass("columns-1"),this.model.get("open")||(this.setOpenStatus(),this.toggleBody()),this.sizeTimer=setInterval(function(){var c=jQuery(".kb-module__controls-inner",a.$el).height()+150;b.height(c)},750)},closeFullscreen:function(){var a=jQuery("#kontentblocks-core-ui");a.removeClass("fullscreen"),clearInterval(this.sizeTimer),this.$el.removeClass("fullscreen-module"),jQuery("#post-body").removeClass("columns-1").addClass("columns-2"),jQuery(".fullscreen--title-wrapper",a).hide(),a.css("height","100%")},serialize:function(){var a,b;return a=jQuery("#post").serializeJSON(),b=a[this.model.get("instance_id")],delete b.areaContext,delete b.moduleName,this.trigger("kb::module.data.updated"),b},addField:function(a,b,c){_.isEmpty(c)?this.attachedFields[a]=b:this.attachedFields[c][a]=b},hasField:function(a,b){return _.isEmpty(b)?a in this.attachedFields:(this.attachedFields[b]||(this.attachedFields[b]={}),a in this.attachedFields[b])},getField:function(a,b){return _.isEmpty(b)?this.attachedFields[a]:this.attachedFields[b][a]},clearFields:function(){this.attachedFields={}},dispose:function(){}}),KB.Backbone.Backend.PanelView=Backbone.View.extend({initialize:function(){this.model.View=this}}),KB.currentModule={},KB.currentArea={},KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection,Panels:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.Panels=new Backbone.Collection([],{model:KB.Backbone.PanelModel}),KB.ObjectProxy=new Backbone.Collection,KB.App=function(){function a(){KB.Modules.on("add",c),KB.Areas.on("add",d),KB.Modules.on("remove",e),b(),KB.FieldConfigs=new KB.Backbone.Common.FieldConfigsCollection(_.toArray(KB.payload.Fields)),KB.Ui.init()}function b(){_.each(KB.payload.Areas,function(a){KB.ObjectProxy.add(KB.Areas.add(a))}),_.each(KB.payload.Modules,function(a){KB.ObjectProxy.add(KB.Modules.add(a))}),_.each(KB.payload.Panels,function(a){KB.ObjectProxy.add(KB.Panels.add(a))})}function c(a){KB.Views.Modules.add(a.get("mid"),new KB.Backbone.Backend.ModuleView({model:a,el:"#"+a.get("mid")})),KB.Ui.initTabs()}function d(a){KB.Views.Areas.add(a.get("id"),new KB.Backbone.Backend.AreaView({model:a,el:"#"+a.get("id")+"-container"}))}function e(a){KB.Views.Modules.remove(a.get("instance_id"))}return{init:a}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&!KB.appData.config.frontend&&KB.Views.Modules.ready()});