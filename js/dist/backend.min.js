/*! Kontentblocks ProdVersion 2014-10-11 08:10 */
KB.Backbone.ModulesDefinitionsCollection=Backbone.Collection.extend({initialize:function(models,options){this.area=options.area},setup:function(){return this.categories=this.prepareCategories(),this.sortToCategories(),this},getModules:function(id){return this.categories[id].modules},sortToCategories:function(){var that=this;_.each(this.models,function(model){if(that.validateVisibility(model)){var cat=_.isUndefined(model.get("settings").category)?"standard":model.get("settings").category;that.categories[cat].modules.push(model)}})},validateVisibility:function(m){return m.get("settings").hidden?!1:m.get("settings").disabled?!1:!(!m.get("settings").globallyAvailable&&this.area.model.get("dynamic"))},prepareCategories:function(){var cats={};return _.each(KB.payload.ModuleCategories,function(item,key){cats[key]={id:key,name:item,modules:[]}}),cats}}),KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ContextModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",initialize:function(){this.listenTo(this,"change:area",this.subscribeToArea),this.listenTo(this,"change:area",this.areaChanged)},destroy:function(){this.unsubscribeFromArea(),this.stopListening()},setArea:function(area){this.set("area",area)},areaChanged:function(){var envVars=this.get("envVars");envVars.areaContext=this.get("areaContext"),this.view.updateModuleForm()},subscribeToArea:function(model,value){var area;area=KB.Areas.get(value),area.view.addModuleView(model.view)},unsubscribeFromArea:function(){var area;area=KB.Areas.get(this.get("area")),area.view.removeModule(this)}}),KB.Backbone.ModuleDefinition=Backbone.Model.extend({initialize:function(){var that=this;this.id=function(){return"template"===that.get("settings").category?that.get("instance_id"):that.get("settings").class}()}}),KB.Backbone.ModuleBrowserModuleDescription=Backbone.View.extend({initialize:function(options){this.options=options||{},this.options.browser.on("browser:close",this.close,this)},update:function(){this.$el.empty(),this.model.get("template")?this.$el.html(KB.Templates.render("backend/modulebrowser/module-template-description",{module:this.model.toJSON()})):this.$el.html(KB.Templates.render("backend/modulebrowser/module-description",{module:this.model.toJSON()})),this.model.get("settings").poster!==!1&&this.$el.append(KB.Templates.render("backend/modulebrowser/poster",{module:this.model.toJSON()})),this.model.get("settings").helpfile!==!1&&this.$el.append(KB.Templates.render(this.model.get("settings").helpfile,{module:this.model.toJSON()}))},close:function(){}}),KB.Backbone.ModuleBrowserListItem=Backbone.View.extend({tagName:"li",className:"modules-list-item",initialize:function(options){this.options=options||{},this.area=options.browser.area},render:function(el){this.model.get("template")?this.$el.html(KB.Templates.render("backend/modulebrowser/module-template-list-item",{module:this.model.toJSON()})):this.$el.html(KB.Templates.render("backend/modulebrowser/module-list-item",{module:this.model.toJSON()})),el.append(this.$el)},events:{click:"loadDetails","click .kb-js-create-module":"createModule"},loadDetails:function(){this.options.browser.loadDetails(this.model)},createModule:function(){this.options.browser.createModule(this.model)},close:function(){this.remove()}}),KB.Backbone.ModuleBrowserModulesList=Backbone.View.extend({initialize:function(options){this.options=options||{}},modules:{},subviews:{},setModules:function(modules){return this.modules=modules,this},update:function(){var that=this,first=!1;this.$el.empty(),_.each(this.modules,function(module){that.subviews[module.cid]=new KB.Backbone.ModuleBrowserListItem({model:module,parent:that,browser:that.options.browser}),first===!1&&(that.options.browser.loadDetails(module),first=!first),that.$el.append(that.subviews[module.cid].render(that.$el))})}}),KB.Backbone.ModuleBrowser=Backbone.View.extend({initialize:function(options){this.options=options||{},_K.info("module browser initialized"),this.area=this.options.area,this.modulesDefinitions=new KB.Backbone.ModulesDefinitionsCollection(this.prepareAssignedModules(),{model:KB.Backbone.ModuleDefinition,area:this.options.area}).setup();var viewMode=this.getViewMode();this.$el.append(KB.Templates.render("backend/modulebrowser/module-browser",{viewMode:viewMode})),this.subviews.ModulesList=new KB.Backbone.ModuleBrowserModulesList({el:jQuery(".modules-list",this.$el),browser:this}),this.subviews.ModuleDescription=new KB.Backbone.ModuleBrowserModuleDescription({el:jQuery(".module-description",this.$el),browser:this}),this.subviews.Navigation=new KB.Backbone.ModuleBrowserNavigation({el:jQuery(".module-categories",this.$el),cats:this.modulesDefinitions.categories,browser:this}),this.listenTo(this.subviews.Navigation,"browser:change",this.update),this.listenTo(this.subviews.ModulesList,"createModule",this.createModule)},tagName:"div",id:"module-browser",className:"kb-overlay",events:{"click .close-browser":"close","click .module-browser--switch__list-view":"toggleViewMode","click .module-browser--switch__excerpt-view":"toggleViewMode"},subviews:{},toggleViewMode:function(){jQuery(".module-browser-wrapper",this.$el).toggleClass("module-browser--list-view module-browser--excerpt-view");var abbr="mdb_"+this.area.model.get("id")+"_state",curr=store.get(abbr);"module-browser--list-view"==curr?store.set(abbr,"module-browser--excerpt-view"):store.set(abbr,"module-browser--list-view")},render:function(){this.open()},getViewMode:function(){var abbr="mdb_"+this.area.model.get("id")+"_state";return store.get(abbr)?store.get(abbr):(store.set(abbr,"module-browser--list-view"),"module-browser--list-view")},open:function(){this.$el.appendTo("body"),jQuery("#wpwrap").addClass("module-browser-open"),jQuery(".nano").nanoScroller({flash:!0})},close:function(){jQuery("#wpwrap").removeClass("module-browser-open"),this.trigger("browser:close"),this.$el.detach()},update:function(model){var id=model.get("id"),modules=this.modulesDefinitions.getModules(id);this.subviews.ModulesList.setModules(modules).update()},loadDetails:function(model){this.subviews.ModuleDescription.model=model,this.subviews.ModuleDescription.update()},createModule:function(module){var Area,data;return KB.Checks.userCan("create_kontentblocks")||KB.Notice.notice("You're not allowed to do this","error"),Area=KB.Areas.get(this.options.area.model.get("id")),KB.Checks.blockLimit(Area)?(data={action:"createNewModule","class":module.get("settings").class,master:module.get("master"),master_id:module.get("master_id"),parentId:module.get("master_id"),template:module.get("template"),templateObj:module.get("templateObj"),viewfile:module.get("viewfile"),duplicate:module.get("duplicate"),areaContext:this.options.area.model.get("context"),area:this.options.area.model.get("id"),_ajax_nonce:KB.Config.getNonce("create")},this.close(),KB.Ajax.send(data,this.success,this),void 0):(KB.Notice.notice("Limit for this area reached","error"),!1)},success:function(data){var model;this.options.area.modulesList.append(data.html),KB.lastAddedModule=new KB.Backbone.ModuleModel(data.module),model=KB.Modules.add(KB.lastAddedModule),this.options.area.addModuleView(model.view),_K.info("new module created",{view:model.view}),this.parseAdditionalJSON(data.json),KB.TinyMCE.addEditor(),KB.Fields.trigger("newModule",KB.Views.Modules.lastViewAdded),KB.Views.Modules.lastViewAdded.$el.addClass("kb-open");var count=parseInt(jQuery("#kb_all_blocks").val(),10)+1;jQuery("#kb_all_blocks").val(count)},parseAdditionalJSON:function(json){KB.payload.Fields||(KB.payload.Fields={}),_.extend(KB.payload.Fields,json.Fields)},prepareAssignedModules:function(){var assignedModules=this.area.model.get("assignedModules"),fullDefs=[];return _.each(KB.payload.ModuleDefinitions,function(module){-1!==_.indexOf(assignedModules,module.settings.class)&&fullDefs.push(module)}),fullDefs}}),KB.Backbone.ModuleBrowserNavigation=Backbone.View.extend({item:Backbone.View.extend({initialize:function(options){this.options=options||{}},tagName:"li",className:"cat-item",events:{click:"change"},change:function(){this.options.parent.trigger("browser:change",this.model),this.$el.addClass("active"),jQuery("li").not(this.$el).removeClass("active")},render:function(){var count=_.keys(this.model.get("modules")).length,countstr="("+count+")";return 0===count?!1:(this.options.parent.catSet===!1&&(this.options.parent.catSet=!0,this.options.browser.update(this.model),this.$el.addClass("active")),this.options.parent.$list.append(this.$el.html(this.model.get("name")+'<span class="module-count">'+countstr+"</span>")),void 0)}}),catSet:!1,initialize:function(options){var that=this;this.options=options||{},this.$list=jQuery("<ul></ul>").appendTo(this.$el),_.each(this.options.cats,function(cat){var model=new Backbone.Model(cat);new that.item({parent:that,model:model,browser:that.options.browser}).render()})}}),KB.Backbone.ModuleMenuItemView=Backbone.View.extend({tagName:"div",className:"",isValid:function(){return!0}}),KB.Backbone.ModuleDelete=KB.Backbone.ModuleMenuItemView.extend({className:"kb-delete block-menu-icon",initialize:function(){_.bindAll(this,"yes","no")},events:{click:"deleteModule"},deleteModule:function(){KB.Notice.confirm(KB.i18n.EditScreen.notices.confirmDeleteMsg,this.yes,this.no)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("delete_kontentblocks")?!1:!0},yes:function(){KB.Ajax.send({action:"removeModules",_ajax_nonce:KB.Config.getNonce("delete"),module:this.model.get("instance_id")},this.success,this)},no:function(){return!1},success:function(){KB.Modules.remove(this.model),wp.heartbeat.interval("fast",2),this.model.destroy()}}),KB.Backbone.ModuleDuplicate=KB.Backbone.ModuleMenuItemView.extend({className:"kb-duplicate block-menu-icon",events:{click:"duplicateModule"},duplicateModule:function(){KB.Ajax.send({action:"duplicateModule",module:this.model.get("instance_id"),areaContext:this.model.area.get("context"),_ajax_nonce:KB.Config.getNonce("create"),"class":this.model.get("class")},this.success,this)},isValid:function(){return this.model.get("predefined")||this.model.get("disabled")||!KB.Checks.userCan("edit_kontentblocks")?!1:!0},success:function(data){if(-1===data)return KB.Notice.notice("Request Error","error"),!1;this.parseAdditionalJSON(data.json),this.model.area.view.modulesList.append(data.html),KB.Modules.add(data.module);var count=parseInt(jQuery("#kb_all_blocks").val(),10)+1;jQuery("#kb_all_blocks").val(count),KB.Notice.notice("Module Duplicated","success"),KB.Ui.repaint("#"+data.module.instance_id),KB.Fields.trigger("update")},parseAdditionalJSON:function(json){KB.payload.Fields||(KB.payload.Fields={}),_.extend(KB.payload.Fields,json.Fields),KB.payload.fieldData||(KB.payload.fieldData={}),_.extend(KB.payload.fieldData,json.fieldData)}}),KB.Backbone.ModuleSave=KB.Backbone.ModuleMenuItemView.extend({initialize:function(options){this.options=options||{},this.parentView=options.parent,this.listenTo(this.parentView,"kb::module.input.changed",this.getDirty),this.listenTo(this.parentView,"kb::module.data.updated",this.getClean)},className:"kb-save block-menu-icon",events:{click:"saveData"},saveData:function(){tinyMCE.triggerSave(),KB.Ajax.send({action:"updateModuleData",module:this.model.toJSON(),data:this.parentView.serialize(),_ajax_nonce:KB.Config.getNonce("update")},this.success,this)},getDirty:function(){this.$el.addClass("is-dirty")},getClean:function(){this.$el.removeClass("is-dirty")},isValid:function(){return this.model.get("master")?!1:!this.model.get("disabled")&&KB.Checks.userCan("edit_kontentblocks")},success:function(res){res&&res.newModuleData||_K.error("Failed to save module data."),this.parentView.model.set("moduleData",res.newModuleData),KB.Notice.notice("Data saved","success")}}),KB.Backbone.ModuleStatus=KB.Backbone.ModuleMenuItemView.extend({initialize:function(options){this.options=options||{}},className:"module-status block-menu-icon",events:{click:"changeStatus"},changeStatus:function(){KB.Ajax.send({action:"changeModuleStatus",module:this.model.get("instance_id"),_ajax_nonce:KB.Config.getNonce("update")},this.success,this)},isValid:function(){return!this.model.get("disabled")&&KB.Checks.userCan("deactivate_kontentblocks")?!0:!1},success:function(){this.options.parent.$head.toggleClass("module-inactive"),this.options.parent.$el.toggleClass("activated deactivated"),KB.Notice.notice("Status changed","success")}}),KB.Backbone.ModuleMenuView=Backbone.View.extend({$menuWrap:null,$menuList:null,initialize:function(){this.$menuWrap=jQuery(".menu-wrap",this.$el),this.$menuWrap.append(KB.Templates.render("backend/module-menu",{})),this.$menuList=jQuery(".module-actions",this.$menuWrap)},addItem:function(view){if(view.isValid&&view.isValid()===!0){var $liItem=jQuery("<li></li>").appendTo(this.$menuList),$menuItem=$liItem.append(view.el);this.$menuList.append($menuItem)}}}),KB.Backbone.AreaView=Backbone.View.extend({initialize:function(){this.attachedModuleViews={},this.controlsContainer=jQuery(".add-modules",this.$el),this.settingsContainer=jQuery(".kb-area-settings-wrapper",this.$el),this.modulesList=jQuery("#"+this.model.get("id"),this.$el),this.$placeholder=jQuery(KB.Templates.render("backend/area-item-placeholder",{i18n:KB.i18n})),this.model.view=this,this.render()},events:{"click .modules-link":"openModuleBrowser","click .js-area-settings-opener":"toggleSettings",mouseenter:"setActive"},render:function(){this.addControls(),this.ui()},addControls:function(){this.controlsContainer.append(KB.Templates.render("backend/area-add-module",{i18n:KB.i18n}))},openModuleBrowser:function(e){e.preventDefault(),this.ModuleBrowser||(this.ModuleBrowser=new KB.Backbone.ModuleBrowser({area:this})),this.ModuleBrowser.render()},toggleSettings:function(e){e.preventDefault(),this.settingsContainer.slideToggle().toggleClass("open"),KB.currentArea=this.model},setActive:function(){KB.currentArea=this.model},addModuleView:function(moduleView){this.attachedModuleViews[moduleView.model.get("instance_id")]=moduleView,this.listenTo(moduleView.model,"change:area",this.removeModule),_K.info("Module:"+moduleView.model.id+" was added to area:"+this.model.id),this.ui()},removeModule:function(model){var id;id=model.id,this.attachedModuleViews[id]&&(delete this.attachedModuleViews[id],_K.info("Module:"+id+" was removed from area:"+this.model.id),this.stopListening(model,"change:area",this.removeModule)),this.ui()},ui:function(){var size;size=_.size(this.attachedModuleViews),0===size?this.renderPlaceholder():this.$placeholder.remove()},renderPlaceholder:function(){this.modulesList.before(this.$placeholder)}}),KB.Backbone.ModuleView=Backbone.View.extend({$head:null,$body:null,ModuleMenu:null,instanceId:null,events:{"click.kb1 .kb-toggle":"toggleBody","click.kb2 .kb-toggle":"setOpenStatus",mouseenter:"setFocusedModule",dblclick:"fullscreen","click .kb-fullscreen":"fullscreen","change .kb-template-select":"viewfileChange","change input,textarea,select":"handleChange","tinymce.change":"handleChange"},setFocusedModule:function(){KB.focusedModule=this.model},handleChange:function(){this.trigger("kb::module.input.changed",this)},viewfileChange:function(e){this.model.set("viewfile",e.currentTarget.value),this.clearFields(),this.updateModuleForm(),this.trigger("KB::backend.module.viewfile.changed")},initialize:function(){this.$head=jQuery(".kb-module__header",this.$el),this.$body=jQuery(".kb-module__body",this.$el),this.$inner=jQuery(".kb-module__controls-inner",this.$el),this.attachedFields={},this.instanceId=this.model.get("instance_id"),this.ModuleMenu=new KB.Backbone.ModuleMenuView({el:this.$el,parent:this}),store.get(this.instanceId+"_open")&&(this.toggleBody(),this.model.set("open",!0)),this.model.view=this,this.setupDefaultMenuItems(),KB.Views.Modules.on("KB::backend.module.view.deleted",function(view){view.$el.fadeOut(500,function(){view.$el.remove()})}),this.listenTo(this,"KB::backend.module.viewfile.changed",function(){})},setupDefaultMenuItems:function(){this.ModuleMenu.addItem(new KB.Backbone.ModuleSave({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDuplicate({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleDelete({model:this.model,parent:this})),this.ModuleMenu.addItem(new KB.Backbone.ModuleStatus({model:this.model,parent:this}))},toggleBody:function(speed){var duration=speed||400;KB.Checks.userCan("edit_kontentblocks")&&(this.$body.slideToggle(duration),this.$el.toggleClass("kb-open"),KB.currentModule=this.model)},setOpenStatus:function(){this.model.set("open",!this.model.get("open")),store.set(this.model.get("instance_id")+"_open",this.model.get("open"))},updateModuleForm:function(){KB.Ajax.send({action:"afterAreaChange",module:this.model.toJSON(),_ajax_nonce:KB.Config.getNonce("read")},this.insertNewUpdateForm,this)},insertNewUpdateForm:function(response){""!==response?this.$inner.html(response.html):this.$inner.html("empty"),response.json.Fields&&(KB.payload.Fields=_.extend(KB.payload.Fields,response.json.Fields)),KB.Ui.repaint(this.$el),KB.Fields.trigger("update"),this.trigger("kb:backend::viewUpdated")},fullscreen:function(){var that=this;this.sizeTimer=null;var $stage=jQuery("#kontentblocks_stage");$stage.addClass("fullscreen");var $title=jQuery(".fullscreen--title-wrapper",$stage),$description=jQuery(".fullscreen--description-wrapper",$stage),titleVal=this.$el.find(".block-title").val();$title.empty().append("<span class='dashicon fullscreen--close'></span><h2>"+titleVal+"</h2>").show(),$description.empty().append("<p class='description'>"+this.model.get("settings").description+"</p>").show(),jQuery(".fullscreen--close").on("click",_.bind(this.closeFullscreen,this)),this.$el.addClass("fullscreen-module"),jQuery("#post-body").removeClass("columns-2").addClass("columns-1"),this.model.get("open")||(this.setOpenStatus(),this.toggleBody()),this.sizeTimer=setInterval(function(){var h=jQuery(".kb-module__controls-inner",that.$el).height()+150;$stage.height(h)},750)},closeFullscreen:function(){var $stage=jQuery("#kontentblocks_stage");$stage.removeClass("fullscreen"),clearInterval(this.sizeTimer),this.$el.removeClass("fullscreen-module"),jQuery("#post-body").removeClass("columns-1").addClass("columns-2"),jQuery(".fullscreen--title-wrapper",$stage).hide(),$stage.css("height","100%")},serialize:function(){var formData,moduleData;return formData=jQuery("#post").serializeJSON(),moduleData=formData[this.model.get("instance_id")],delete moduleData.areaContext,delete moduleData.viewfile,delete moduleData.moduleName,this.trigger("kb::module.data.updated"),moduleData},addField:function(key,obj,arrayKey){_.isEmpty(arrayKey)?this.attachedFields[key]=obj:this.attachedFields[arrayKey][key]=obj},hasField:function(key,arrayKey){return _.isEmpty(arrayKey)?key in this.attachedFields:(this.attachedFields[arrayKey]||(this.attachedFields[arrayKey]={}),key in this.attachedFields[arrayKey])},getField:function(key,arrayKey){return _.isEmpty(arrayKey)?this.attachedFields[key]:this.attachedFields[arrayKey][key]},clearFields:function(){_K.info("Attached Fields were reset to empty object"),this.attachedFields={}}}),KB.currentModule={},KB.currentArea={},KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function init(){KB.Modules.on("add",createModuleViews),KB.Areas.on("add",createAreaViews),KB.Modules.on("remove",removeModule),addViews(),KB.Ui.init()}function addViews(){_.each(KB.payload.Areas,function(area){KB.Areas.add(new KB.Backbone.AreaModel(area))}),_.each(KB.payload.Modules,function(module){var m=KB.Modules.add(module),areaView=KB.Areas.get(module.area).view;areaView.addModuleView(m.view)})}function createModuleViews(module){_K.info("ModuleViews: new added"),KB.Views.Modules.add(module.get("instance_id"),new KB.Backbone.ModuleView({model:module,el:"#"+module.get("instance_id")})),KB.Ui.initTabs()}function createAreaViews(area){KB.Views.Areas.add(area.get("id"),new KB.Backbone.AreaView({model:area,el:"#"+area.get("id")+"-container"}))}function removeModule(model){KB.Views.Modules.remove(model.get("instance_id"))}return{init:init}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&!KB.appData.config.frontend&&(_K.info("Backend Modules Ready Event fired"),KB.Views.Modules.ready())});