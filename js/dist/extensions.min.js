/*! kontentblocks ProdVersion 2014-03-11 */
KB.Ext.Backup=function($){return{el:$("#backup-inspect"),lastItem:null,firstRun:!0,init:function(){if(KB.appData.config.frontend)return _K.info("Backup Inspect stopped"),!1;var that=this;this.listEl=$("<ul></ul>").appendTo(this.el),this.listEl.length>0&&this.update(),$(document).on("heartbeat-send",function(e,data){data.kbBackupWatcher=that.lastItem,data.post_id=KB.Screen.post_id}),$(document).on("heartbeat-tick",function(e,data){data.kbHasNewBackups&&_.isObject(data.kbHasNewBackups)&&that.renderList(data.kbHasNewBackups)})},update:function(){var that=this;KB.Ajax.send({action:"get_backups"},function(response){that.items=response,that.renderList(response)})},renderList:function(items){var that=this;this.listEl.empty(),_.each(items,function(item,key){that.lastItem=key,that.listEl.append(_.template("                <li>\n                    <details>\n                        <summary>\n                            <%= data.time %>\n                        </summary>\n                    <div class='actions' data-id='<%= key %>'>\n                        <span class='js-review'>Review</span>\n                        <span class='js-restore'>Restore</span>\n                        <p class='description'><b>Comment:</b> <%= item.msg %></p>\n                    </details>\n                </li>",{data:{time:new moment.unix(key).format("HH:mm:ss / DD.MMM")},item:item,key:key}))}),_K.info("Backup Inspect::FirstRun:",this.firstRun),this.firstRun||KB.Notice.notice("<p>New Backups were created</p>","success"),this.firstRun=!1,this.listEl.on("click",".js-restore",function(){var id=$(this).parent().attr("data-id");that.restore(id)})},restore:function(id){var location=window.location.href+"&restore_backup="+id+"&post_id="+$("#post_ID").val();window.location=location}}}(jQuery),KB.Ext.Backup.init();var KBAreaSelector;!function($){KBAreaSelector={init:function(){return KB.appData.config.frontend?(_K.info("Area Selector stopped"),!1):($("#existing-areas, #active-dynamic-areas").sortable({connectWith:".connect",cancel:"li.ui-state-disabled",placeholder:"sortable-placeholder",helper:"clone",receive:function(event,ui){item=ui.item,id=$(item).attr("id"),$(item).toggleClass("dynamic-area-active"),"active-dynamic-areas"==this.id?(action="<span><a href=''>edit</a></span>",content="<input id='"+id+"_hidden' type='hidden' name='active_sidebar_areas[]' value='"+id+"' />",$(item).append(content)):$("input#"+id+"_hidden").remove()}}),void 0)}},$(document).ready(KBAreaSelector.init)}(jQuery),jQuery(document).ready(function($){$("body").on("click","a.da-modal",function(e){e.preventDefault(),target=$(this).attr("data-url"),height=$(window).height(),$("#da-frame").attr("src",target).attr("height",height-200),$(window).resize(function(){height=$(window).height(),$("#da-frame").attr("height",height-200)});var $content=$("#da-modal");openedModal=vex.open({content:$content.html(),contentClassName:"editGlobalArea"})})}),function($){var LayoutTemplates={el:$("#layout-templates"),init:function(){return KB.appData.config.frontend?(_K.info("Layout Templates stopped"),!1):(_K.debug("Layout Templates loaded"),0===this.el.length?!1:(this.options={},this.areaConfig=this._areaConfig(),this.selectContainer=this._selectContainer(),this.selectMenuEl=this._createSelectMenu(),this.loadButton=this._loadButton(),this.deleteButton=this._deleteButton(),this.createContainer=this._createContainer(),this.createInput=this._createInput(),this.createButton=this._createButton(),this.update(),void 0))},_selectContainer:function(){return $("<div class='select-container'></div>").appendTo(this.el)},_createSelectMenu:function(){return $('<select name="layout-template"></select>').appendTo(this.selectContainer),$("select",this.el)},update:function(){var that=this;KB.Ajax.send({action:"get_layout_templates",data:{areaConfig:this.areaConfig}},function(response){that.options=response,that.renderSelectMenu(response)})},save:function(){var that=this,value=this.createInput.val();return _.isEmpty(value)?(KB.notice("Please enter a Name for the template","error"),!1):(KB.Ajax.send({action:"set_layout_template",data:{areaConfig:this.areaConfig,name:value}},function(){that.update(),that.createInput.val(""),KB.notice("Saved","success")}),void 0)},"delete":function(){var that=this,value=this.selectMenuEl.val();return _.isEmpty(value)?(KB.notice("Please chose a template to delete","error"),!1):(KB.Ajax.send({action:"delete_layout_template",data:{areaConfig:this.areaConfig,name:value}},function(){that.update(),KB.notice("Saved","success")}),void 0)},renderSelectMenu:function(data){var that=this;that.selectMenuEl.empty(),_.each(data,function(item,key){that.selectMenuEl.append(_.template("<option value='<%= data.key %>'><%= data.name %></option>",{data:{key:key,name:item.name}}))})},_areaConfig:function(){var concat="";return KB.fromServer.Areas&&_.each(KB.fromServer.Areas,function(context){concat+=context.id,_K.debug("Layout Templates: Concat",concat)}),this.hash(concat.replace(",",""))},hash:function(s){return s.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},_createContainer:function(){return $("<div class='create-container'></div>").appendTo(this.el)},_createInput:function(){return $("<input type='text' >").appendTo(this.createContainer)},_createButton:function(){var that=this,button=$("<a class='button'>Save</a>").appendTo(this.createContainer);return button.on("click",function(e){e.preventDefault(),that.save()}),button},_loadButton:function(){var that=this,button=$("<a class='button'>Load</a>").appendTo(this.selectContainer);return button.on("click",function(e){e.preventDefault(),that.load()}),button},_deleteButton:function(){var that=this,button=$("<a class='delete-js'>delete</a>").appendTo(this.selectContainer);return button.on("click",function(e){e.preventDefault(),that.delete()}),button},load:function(){var location=window.location.href+"&load_template="+this.selectMenuEl.val()+"&post_id="+$("#post_ID").val()+"&config="+this.areaConfig;window.location=location}};LayoutTemplates.init()}(jQuery);