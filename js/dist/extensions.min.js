/*! Kontentblocks ProdVersion 2014-03-25 11:03 */
!function(a){var b={el:a("#kb-layout-configurations"),init:function(){return KB.appData.config.frontend?(_K.info("Layout Configurations stopped"),!1):(_K.debug("Layout Configurations start up"),0===this.el.length?!1:(this.options={},this.areaConfig=this._areaConfig(),this.selectContainer=this._selectContainer(),this.selectMenuEl=this._createSelectMenu(),this.loadButton=this._loadButton(),this.deleteButton=this._deleteButton(),this.createContainer=this._createContainer(),this.createInput=this._createInput(),this.createButton=this._createButton(),this.update(),void 0))},_selectContainer:function(){return a("<div class='select-container clearfix'><p>Load an exisiting configuration. Note!: This will reset the current.</p></div>").appendTo(this.el)},_createSelectMenu:function(){return a('<select name="kb-layout-configuration"></select>').appendTo(this.selectContainer),a("select",this.el)},update:function(){var a=this;KB.Ajax.send({action:"get_layout_configurations",_ajax_nonce:kontentblocks.nonces.read,data:{areaConfig:this.areaConfig}},function(b){a.options=b,a.renderSelectMenu(b)})},save:function(){var a=this,b=this.createInput.val();return _.isEmpty(b)?(KB.notice("Please enter a Name for the template","error"),!1):(KB.Ajax.send({action:"set_layout_configuration",_ajax_nonce:kontentblocks.nonces.update,data:{areaConfig:this.areaConfig,name:b}},function(){a.update(),a.createInput.val(""),KB.notice("Saved","success")}),void 0)},"delete":function(){var a=this,b=this.selectMenuEl.val();return _.isEmpty(b)?(KB.notice("Please chose a template to delete","error"),!1):(KB.Ajax.send({action:"delete_layout_configuration",_ajax_nonce:kontentblocks.nonces.delete,data:{areaConfig:this.areaConfig,name:b}},function(){a.update(),KB.notice("Deleted","success")}),void 0)},renderSelectMenu:function(a){var b=this;b.selectMenuEl.empty(),_.each(a,function(a,c){b.selectMenuEl.append(_.template("<option value='<%= data.key %>'><%= data.name %></option>",{data:{key:c,name:a.name}}))})},_areaConfig:function(){var a="";return KB.payload.Areas&&_.each(KB.payload.Areas,function(b){a+=b.id,_K.debug("Layout Configurations: Concat",a)}),this.hash(a.replace(",",""))},hash:function(a){return a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},_createContainer:function(){return a("<div class='create-container'></div>").appendTo(this.el)},_createInput:function(){return a("<input type='text' >").appendTo(this.createContainer)},_createButton:function(){var b=this,c=a("<a class='button kb-lc-save'>Save</a>").appendTo(this.createContainer);return c.on("click",function(a){a.preventDefault(),b.save()}),c},_loadButton:function(){var b=this,c=a("<a class='button-primary kb-lc-load'>Load</a>").appendTo(this.selectContainer);return c.on("click",function(a){a.preventDefault(),b.load()}),c},_deleteButton:function(){var b=this,c=a("<a class='delete-js kb-lc-delete'>delete</a>").appendTo(this.selectContainer);return c.on("click",function(a){a.preventDefault(),b.delete()}),c},load:function(){var b=window.location.href+"&kb_load_configuration="+this.selectMenuEl.val()+"&post_id="+a("#post_ID").val()+"&config="+this.areaConfig;window.location=b}};b.init()}(jQuery),KB.AreaSelector=function(a){return{$stage:null,areaToEdit:null,$editWrap:null,init:function(){return KB.appData.config.frontend?(_K.info("Area Selector stopped"),!1):(this.sortable(),void 0)},sortable:function(){a("#existing-areas, #active-dynamic-areas").sortable({connectWith:".connect",cancel:"li.ui-state-disabled",placeholder:"sortable-placeholder",helper:"clone",receive:function(b,c){item=c.item,id=a(item).attr("id"),a(item).toggleClass("dynamic-area-active"),"active-dynamic-areas"==this.id?(action="<span><a href=''>edit</a></span>",content="<input id='"+id+"_hidden' type='hidden' name='active_sidebar_areas[]' value='"+id+"' />",a(item).append(content)):a("input#"+id+"_hidden").remove()}})}}}(jQuery).init(),KB.Ext.Backup=function(a){return{el:a("#backup-inspect"),lastItem:null,firstRun:!0,init:function(){if(KB.appData.config.frontend)return _K.info("Backup Inspect stopped"),!1;var b=this;this.listEl=a("<ul></ul>").appendTo(this.el),this.listEl.length>0&&this.update(),a(document).on("heartbeat-send",function(a,c){c.kbBackupWatcher=b.lastItem,c.post_id=KB.Screen.post_id}),a(document).on("heartbeat-tick",function(a,c){c.kbHasNewBackups&&_.isObject(c.kbHasNewBackups)&&b.renderList(c.kbHasNewBackups)})},update:function(){var a=this;KB.Ajax.send({action:"get_backups",_ajax_nonce:kontentblocks.nonces.read},function(b){a.items=b,a.renderList(b)})},renderList:function(b){var c=this;this.listEl.empty(),_.each(b,function(a,b){c.lastItem=b,c.listEl.append(_.template("                <li>\n                    <details>\n                        <summary>\n                            <%= data.time %>\n                        </summary>\n                    <div class='actions' data-id='<%= key %>'>\n                        <span class='js-restore'>Restore</span>\n                        <p class='description'><b>Comment:</b> <%= item.msg %></p>\n                    </details>\n                </li>",{data:{time:new moment.unix(b).format("HH:mm:ss / DD.MMM")},item:a,key:b}))}),_K.info("Backup Inspect::FirstRun:",this.firstRun),this.firstRun||KB.Notice.notice("<p>"+KB.i18n.Extensions.backups.newBackupcreated+"</p>","success"),this.firstRun=!1,this.listEl.on("click",".js-restore",function(){var b=a(this).parent().attr("data-id");c.restore(b)})},restore:function(b){var c=window.location.href+"&restore_backup="+b+"&post_id="+a("#post_ID").val();window.location=c}}}(jQuery),KB.Ext.Backup.init();