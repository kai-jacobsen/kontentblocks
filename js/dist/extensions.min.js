/*! kontentblocks 2013-10-17 */
var KB=KB||{};KB.Ext=KB.Ext||{},KB.Ext.Backup=function(a){return{el:a("#backup-inspect"),init:function(){this.listEl=a("<ul></ul>").appendTo(this.el),this.listEl.length>0&&this.update()},update:function(){var a=this;KB.ajax({action:"get_backups"},function(b){console.log(b),a.items=b,a.renderList(b)})},renderList:function(b){var c=this;this.listEl.empty(),_.each(b,function(a,b){c.listEl.append(_.template("                <li>\n                    <details>\n                        <summary>\n                            <%= data.time %>\n                        </summary>\n                    <div class='actions' data-id='<%= key %>'>\n                        <span class='js-review'>Review</span>\n                        <span class='js-restore'>Restore</span>\n                        <p class='description'><b>Comment:</b> <%= item.msg %></p>\n                    </details>\n                </li>",{data:{time:new moment.unix(b).format("HH:mm:ss / DD.MMM")},item:a,key:b}))}),this.listEl.on("click",".js-restore",function(){var b=a(this).parent().attr("data-id");c.restore(b)})},restore:function(b){var c=window.location.href+"&restore_backup="+b+"&post_id="+a("#post_ID").val();window.location=c}}}(jQuery),KB.Ext.Backup.init();var KBAreaSelector;!function(a){KBAreaSelector={init:function(){a("#existing-areas, #active-dynamic-areas").sortable({connectWith:".connect",cancel:"li.ui-state-disabled",placeholder:"sortable-placeholder",helper:"clone",receive:function(b,c){item=c.item,id=a(item).attr("id"),a(item).toggleClass("dynamic-area-active"),"active-dynamic-areas"==this.id?(action="<span><a href=''>edit</a></span>",content="<input id='"+id+"_hidden' type='hidden' name='active_sidebar_areas[]' value='"+id+"' />",a(item).append(content)):a("input#"+id+"_hidden").remove()}})}},a(document).ready(KBAreaSelector.init)}(jQuery),jQuery(document).ready(function(a){a("body").on("click","a.da-modal",function(b){b.preventDefault(),target=a(this).attr("data-url"),height=a(window).height(),a("#da-frame").attr("src",target).attr("height",height-200),a(window).resize(function(){height=a(window).height(),a("#da-frame").attr("height",height-200)});var c=a("#da-modal");openedModal=vex.open({content:c.html(),contentClassName:"editGlobalArea"})})});var KBCopyMove,post_id;!function(a){KBCopyMove={data:{"class":"",instance_id:"",payload:{}},init:function(){a(".kb-copymove").live("click",function(b){b.preventDefault(),KBCopyMove.data.instance_id=activeBlock,KBCopyMove.data.class=a("#"+activeBlock).attr("data-blockclass"),a("#kb-copymove").reveal({open:function(){KBCopyMove.modalOpen()}})}),a("#kb-copymove").on("click",".kb-copymove-send",function(a){a.preventDefault(),KBCopyMove.copy()}),a("#kb-copymove").on("click",".copymove-back",function(a){a.preventDefault(),KBCopyMove.prevSlide()}),a("#kb-copymove").on("change","select",function(){return getwhat=a(this).parent().attr("rel"),value=a(this).val(),""===value?!1:($section=a(this).closest(".copymove-section").toggleClass("loading"),KBCopyMove.data.payload[getwhat]=value,KB.ajax({type:getwhat,value:value,payload:KBCopyMove.data.payload,action:"copymove_get_"+getwhat},function(b){a("#copymove_"+getwhat).empty(),a("#copymove_"+getwhat).html(b),a($section).closest(".copymove-section").toggleClass("loading"),KBCopyMove.nextSlide()}),void 0)})},modalOpen:function(){KB.ajax({action:"kb_copymove",data:KBCopyMove.data,post_id:a("#post_ID").val()},function(b){a("#kb-copymove").html(b)})},copy:function(){KB.ajax({action:"kb_copymove_copy",data:KBCopyMove.data,post_id:a("#post_ID").val()},function(a){console.log(a)})},nextSlide:function(){var b=a(".copymove-wrapper");a(b).find(".holder").animate({top:"-=130px"},350)},prevSlide:function(){var b=a(".copymove-wrapper");a(b).find(".holder").animate({top:"+=130px"},350)}},a(document).ready(KBCopyMove.init)}(jQuery);var KBProxy;!function(a){KBProxy={init:function(){var b=KBProxy,c={};a(kbMetaBox).on("click",".proxy-toggle",function(){a(this).next().slideToggle(750)}),a(kbMetaBox).on("change",".block-select",function(){a("#"+activeBlock+"_block_chosen").val(a(this).val()),a("#"+activeBlock+"_select_block").removeAttr("disabled")}),a(kbMetaBox).on("click",".proxy-select-block",function(){b.result(c)}),a(kbMetaBox).on("change",".proxy-select",function(){getwhat=a(this).attr("rel"),value=a(this).val(),$section=a(this).closest(".proxy-section").toggleClass("loading"),c[getwhat]=value,KB.ajax({payload:c,type:getwhat,value:value,action:"proxy_get_"+getwhat},function(b){a("#"+activeBlock+"_"+getwhat).empty(),a("#"+activeBlock+"_"+getwhat).append("<option>select one</option>"),a("#"+activeBlock+"_"+getwhat).append(b),a($section).closest(".proxy-section").toggleClass("loading")})})},result:function(b){KB.ajax({payload:b,action:"proxy_get_result"},function(b){result=b,container=a("#"+activeBlock+"_proxy_result"),holder=a("#"+activeBlock).find(".holder"),a(container).empty().append(result.html),a(holder).slideToggle(750)})}},a(document).ready(KBProxy.init)}(jQuery),function(a){var b={el:a("#layout-templates"),init:function(){return 0===this.el.length?!1:(this.options={},this.areaConfig=this._areaConfig(),this.selectContainer=this._selectContainer(),this.selectMenuEl=this._createSelectMenu(),this.loadButton=this._loadButton(),this.deleteButton=this._deleteButton(),this.createContainer=this._createContainer(),this.createInput=this._createInput(),this.createButton=this._createButton(),this.update(),void 0)},_selectContainer:function(){return a("<div class='select-container'></div>").appendTo(this.el)},_createSelectMenu:function(){return a('<select name="layout-template"></select>').appendTo(this.selectContainer),a("select",this.el)},update:function(){var a=this;KB.ajax({action:"get_layout_templates",data:{areaConfig:this.areaConfig}},function(b){a.options=b,a.renderSelectMenu(b)})},save:function(){var a=this,b=this.createInput.val();return _.isEmpty(b)?(KB.notice("Please enter a Name for the template","error"),!1):(KB.ajax({action:"set_layout_template",data:{areaConfig:this.areaConfig,name:b}},function(){a.update(),a.createInput.val(""),KB.notice("Saved","success")}),void 0)},"delete":function(){var a=this,b=this.selectMenuEl.val();return _.isEmpty(b)?(KB.notice("Please chose a template to delete","error"),!1):(KB.ajax({action:"delete_layout_template",data:{areaConfig:this.areaConfig,name:b}},function(){a.update(),KB.notice("Saved","success")}),void 0)},renderSelectMenu:function(a){var b=this;b.selectMenuEl.empty(),_.each(a,function(a,c){b.selectMenuEl.append(_.template("<option value='<%= data.key %>'><%= data.name %></option>",{data:{key:c,name:a.name}}))})},_areaConfig:function(){var a="";return kbpage.areas&&_.each(kbpage.areas,function(b){a+=b.id}),this.hash(a.replace(",",""))},hash:function(a){return a.split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},_createContainer:function(){return a("<div class='create-container'></div>").appendTo(this.el)},_createInput:function(){return a("<input type='text' >").appendTo(this.createContainer)},_createButton:function(){var b=this,c=a("<a class='button'>Save</a>").appendTo(this.createContainer);return c.on("click",function(a){a.preventDefault(),b.save()}),c},_loadButton:function(){var b=this,c=a("<a class='button'>Load</a>").appendTo(this.selectContainer);return c.on("click",function(a){a.preventDefault(),b.load()}),c},_deleteButton:function(){var b=this,c=a("<a class='delete-js'>delete</a>").appendTo(this.selectContainer);return c.on("click",function(a){a.preventDefault(),b.delete()}),c},load:function(){var b=window.location.href+"&load_template="+this.selectMenuEl.val()+"&post_id="+a("#post_ID").val()+"&config="+this.areaConfig;window.location=b}};b.init()}(jQuery);