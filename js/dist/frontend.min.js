/*! Kontentblocks ProdVersion 2014-03-23 09:03 */
function initTinymce(a){KB.Checks.userCan("edit_kontentblocks")&&tinymce.init({selector:"#"+a.id,theme:"modern",skin:"lightgray",menubar:!1,add_unload_trigger:!1,fixed_toolbar_container:"#kb-toolbar",schema:"html5",inline:!0,toolbar:"kbcancleinline | undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image     | print preview media",statusbar:!1,setup:function(a){a.on("init",function(){var b=jQuery(a.bodyElement).data(),c=b.module;a.module=KB.Modules.get(c),a.kbDataRef={key:b.key,index:b.index,arrayKey:b.arraykey}}),a.on("focus",function(){jQuery("#kb-toolbar").show()}),a.addButton("kbcancleinline",{title:"Stop inline Edit",onClick:function(){tinymce.activeEditor=null,tinymce.focusedEditor=null,document.activeElement.blur(),jQuery("#kb-toolbar").hide()}}),a.on("blur",function(){jQuery("#kb-toolbar").hide();var b=a.kbDataRef,c=a.getContent(),d=_.clone(a.module.get("moduleData"));_.isUndefined(b.index)||_.isUndefined(b.arrayKey)?_.isUndefined(b.index)?_.isUndefined(b.arrayKey)?d[b.key]=c:d[b.arrayKey][b.key]=c:d[b.index][b.key]=c:d[b.arrayKey][b.index][b.key]=c,a.module.set("moduleData",d)})}})}KB.Templates=function(a){function b(b,d){if(!c[b]){var e,f=kontentblocks.config.url+"js/templates",g=f+"/"+b+".html";a.ajax({url:g,method:"GET",async:!1,success:function(a){e=a}}),c[b]=_.template(e)}return c[b](d)}var c={};return{render:b}}(jQuery),KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var a=this;KB.Ajax.send({action:"removeModules",instance_id:a.get("instance_id")},a.destroyed)},destroyed:function(){},setArea:function(a){this.area=a},areaChanged:function(){this.view.updateModuleForm()},save:function(a){var b=a.get("editableModel"),c=a.get("editable"),d=jQuery(c).data();d.data=jQuery(c).html(),d.postId=b.get("post_id"),jQuery.ajax({url:KBAppConfig.ajaxurl,data:{action:"saveInlineEdit",data:d},type:"POST",dataType:"json",cookie:encodeURIComponent(document.cookie),success:function(){console.log("sent")},error:function(){console.log("not sent")},complete:function(){console.log("no matter what")}})}}),KB.Stuff=function(a){var b,c;return b={selector:".editable-image",remove:".kb-js-reset-file",img:null,init:function(){var b=this;a("body").on("click",this.selector,function(c){c.preventDefault(),b.img=a(this),b.frame().open()}),a("body").on("click",this.remove,function(c){c.preventDefault(),b.container=a(".kb-field-file-wrapper",activeField),b.resetFields()})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:KB.i18n.Refields.file.modalTitle,button:{text:KB.i18n.Refields.common.select},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){a(".media-modal").addClass(" smaller no-sidebar")},select:function(){c=this.get("selection").first(),b.handleAttachment(c)},handleAttachment:function(a){var b=this,c=a.get("id"),d=this.img.attr("data-module"),e=this.img.attr("data-key"),f=KB.payload.FrontSettings[d][e],g=KB.Modules.get(d),h=g.get("moduleData");h[e]=_.extend(h[e],{id:c}),g.set("moduleData",h),jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:f,id:c,_ajax_nonce:kontentblocks.nonces.get},type:"GET",dataType:"json",success:function(a){b.img.attr("src",a)},error:function(){}})},resetFields:function(){a(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),a(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery),KB.Stuff.init();var KB=KB||{};KB.StuffBG=function(a){var b,c;return b={selector:".editable-bg-image",remove:".kb-js-reset-file",img:null,init:function(){var b=this;a("body").on("click",this.selector,function(c){c.preventDefault(),b.img=a(this),b.frame().open()}),a("body").on("click",this.remove,function(c){c.preventDefault(),b.container=a(".kb-field-file-wrapper",activeField),b.resetFields()})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:"Hello",button:{text:"Insert"},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){a(".media-modal").addClass(" smaller no-sidebar")},select:function(){c=this.get("selection").first(),b.handleAttachment(c)},handleAttachment:function(a){var b=this,c=a.get("id"),d=this.img.attr("data-module"),e=this.img.attr("data-key"),f=KB.payload.FrontSettings[d][e],g=KB.Modules.get(d),h=g.get("moduleData");h[e]=_.extend(h[e],{id:c}),g.set("moduleData",h),jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:f,id:c,_ajax_nonce:kontentblocks.nonces.get},type:"GET",dataType:"json",success:function(a){b.img.css("backgroundImage","url('"+a+"')")},error:function(){}})},resetFields:function(){a(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),a(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery),KB.StuffBG.init(),KB.ModuleLayoutControls=Backbone.View.extend({initialize:function(a){this.options=a,this.targetEl=this.options.parent.$el,this.render()},events:{"click a.close-controls":"destroy"},render:function(){var a=this;this.targetEl.addClass("edit-active"),this.$el.append(KB.Templates.render("frontend/module-layout-controls",{model:this.model.toJSON()}));var b=jQuery(".os-controls-container",this.$el);b.css("position","absolute").draggable({handle:"h2",containment:"window",stop:function(a,b){KB.OSConfig.Position=b.position}}),KB.OSConfig.Position&&b.css({top:KB.OSConfig.Position.top,left:KB.OSConfig.Position.left}),jQuery("body").append(this.$el),this.$el.tabs();var c=a.targetEl.css("marginTop");jQuery("#KBMarginTop").ionRangeSlider({from:parseInt(c,10),postfix:"px",onChange:function(b){a.targetEl.css("marginTop",b.fromNumber)}});var d=a.targetEl.css("marginBottom");jQuery("#KBMarginBottom").ionRangeSlider({from:parseInt(d,10),postfix:"px",onChange:function(b){a.targetEl.css("marginBottom",b.fromNumber)}})},destroy:function(){this.targetEl.removeClass("edit-active"),this.remove()}}),KB.Backbone.AreaView=Backbone.View.extend({initialize:function(){}}),KB.Backbone.FrontendEditView=Backbone.View.extend({$form:null,$formContent:null,timerId:null,initialize:function(a){var b=this;this.options=a,this.view=a.view,this.model.on("change",this.test,this),this.on("recalibrate",this.recalibrate,this),jQuery(KB.Templates.render("frontend/module-edit-form",{model:this.model.toJSON()})).appendTo(this.$el),this.$form=jQuery("#onsite-form",this.$el),this.$formContent=jQuery("#onsite-content",this.$el),this.$inner=jQuery(".os-content-inner",this.$formContent),this.$el.css("position","fixed").draggable({handle:"h2",containment:"window",stop:function(a,c){KB.OSConfig.wrapPosition=c.position,b.recalibrate(c.position)}}),jQuery(window).on("resize",function(){b.recalibrate()}),jQuery("body").on("kontentblocks::tabsChange",function(){b.recalibrate()}),KB.OSConfig.wrapPosition&&this.$el.css({top:KB.OSConfig.wrapPosition.top,left:KB.OSConfig.wrapPosition.left}),jQuery(document).on("newEditor",function(a,c){b.attachEditorEvents(c)}),jQuery(document).on("KB:osUpdate",function(){b.serialize(!1)}),jQuery(document).on("change",".kb-observe",function(){b.serialize(!1)}),jQuery("body").append(this.$el),this.render()},test:function(){_K.info("Test Debug: Module Data changed")},events:{keyup:"delayInput","click a.close-controls":"destroy","click a.kb-save-form":"update","click a.kb-preview-form":"preview"},preview:function(){this.serialize(!1)},update:function(){this.serialize(!0)},render:function(){var a=this;this.$el.show(),this.applyControlsSettings(this.$el),KB.lastAddedModule={view:a},jQuery.ajax({url:ajaxurl,data:{action:"getModuleOptions",module:a.model.toJSON(),_ajax_nonce:kontentblocks.nonces.read},type:"POST",dataType:"json",success:function(b){if(a.$inner.empty(),a.$inner.attr("id",a.view.model.get("instance_id")),a.$inner.append(b.html),b.json){var c=_.extend(KB.payload,b.json);KB.payload=c}KB.Ui.initTabs(),KB.Ui.initToggleBoxes(),KB.TinyMCE.addEditor(),KB.Fields.trigger("update");var d=_.clone(a.view);d.$el=a.$inner,d.parentView=a.view,a.view.trigger("kb:frontend::viewLoaded",d),_K.info("Frontend Modal opened with view of:"+a.view.model.get("instance_id")),setTimeout(function(){a.recalibrate()},1e3)},error:function(){console.log("e")}})},reload:function(a){return this.unload(),this.model&&this.model.get("instance_id")===a.model.get("instance_id")?!1:(this.model=a.model,this.options.view=a,this.view=a,this.render(),void 0)},unset:function(){this.model=null,this.options.view=null},recalibrate:function(){var a,b,c,d;a=jQuery(window).height()-40,b=jQuery(".os-content-inner").height(),c=this.$el.position(),d=b+c.top-a,d>0?this.initScrollbars(b-(d+30)):b-c.top<a?this.initScrollbars(b):this.initScrollbars(a-c.top),c.top<40&&this.$el.css("top","40px"),_K.info("Frontend Modal resizing done!")},initScrollbars:function(a){jQuery(".nano",this.$el).height(a),jQuery(".nano").nanoScroller({preventPageScrolling:!0}),_K.info("Nano Scrollbars (re)initialized!")},serialize:function(a){_K.info("Frontend Modal called serialize function. Savemode",a);var b=this;tinymce.triggerSave(),jQuery.ajax({url:ajaxurl,data:{action:"updateModuleOptions",data:b.$form.serialize().replace(/\'/g,"%27"),module:b.model.toJSON(),editmode:a?"update":"preview",_ajax_nonce:kontentblocks.nonces.update},type:"POST",dataType:"json",success:function(c){jQuery(".editable",b.options.view.$el).each(function(a,b){tinymce.remove("#"+b.id)}),b.options.view.$el.html(c.html),b.model.set("moduleData",c.newModuleData),b.model.view.render(),b.model.view.delegateEvents(),b.model.view.trigger("kb:moduleUpdated"),b.view.trigger("kb:frontend::viewUpdated"),jQuery(window).trigger("kontentblocks::ajaxUpdate"),jQuery(".editable",b.options.view.$el).each(function(a,b){initTinymce(b)}),a?(KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticeDataSaved,"success"),b.$el.removeClass("isDirty")):(KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticePreviewUpdated,"success"),b.$el.addClass("isDirty")),_K.info("Frontend Modal saved data for:"+b.model.get("instance_id"))},error:function(){console.log("e")}})},delayInput:function(){var a=this;this.options.timerId&&clearTimeout(this.options.timerId),this.options.timerId=setTimeout(function(){a.options.timerId=null,a.serialize()},500)},attachEditorEvents:function(a){var b=this;a.onKeyUp.add(function(){b.delayInput()})},destroy:function(){this.unload(),this.unbind(),this.remove(),KB.FrontendEditModal=null},unload:function(){this.unset(),jQuery(".wp-editor-area",this.$el).each(function(a,b){tinymce.remove("#"+b.id)})},applyControlsSettings:function(a){var b=this.model.get("settings");b.controls&&b.controls.width&&a.css("width",b.controls.width+"px")}}),KB.Backbone.ModuleView=Backbone.View.extend({initialize:function(){var a=this;KB.Checks.userCan("edit_kontentblocks")&&(this.model.bind("save",this.model.save),this.listenTo(this.model,"change",this.modelChange),this.model.view=this,this.render(),this.setControlsPosition(),jQuery(window).on("kontentblocks::ajaxUpdate",function(){a.setControlsPosition()}))},modelChange:function(){this.$el.addClass("isDirty")},save:function(){},events:{"click a.os-edit-block":"openOptions","click .editable":"reloadModal","click .kb-js-inline-update":"updateModule","click .kb-js-open-layout-controls":"openLayoutControls"},render:function(){this.$el.append(KB.Templates.render("frontend/module-controls",{model:this.model.toJSON()}))},openOptions:function(){return KB.FrontendEditModal?(this.reloadModal(),!1):(KB.FrontendEditModal=new KB.Backbone.FrontendEditView({tagName:"div",id:"onsite-modal",model:this.model,view:this}),KB.focusedModule=this.model,void 0)},reloadModal:function(){KB.FrontendEditModal&&KB.FrontendEditModal.reload(this),KB.CurrentModel=this.model,KB.focusedModule=this.model},openLayoutControls:function(){KB.OpenedLayoutControls&&KB.OpenedLayoutControls.destroy(),KB.OpenedLayoutControls=new KB.ModuleLayoutControls({tagName:"div",id:"slider-unique",className:"slider-controls-wrapper",model:this.model,parent:this})},setControlsPosition:function(){var a=this.model.get("settings"),b=jQuery(".os-controls",this.$el),c=this.$el.offset();this.$el.width()-150,a.controls&&a.controls.toolbar&&(c.top=a.controls.toolbar.top,c.left=a.controls.toolbar.left),b.offset({top:c.top+20,left:c.left-15,zIndex:999999})},updateModule:function(){var a=this,b={},c=!1;b[a.model.get("instance_id")]=a.model.get("moduleData"),jQuery.ajax({url:ajaxurl,data:{action:"updateModuleOptions",data:jQuery.param(b).replace(/\'/g,"%27"),module:a.model.toJSON(),editmode:"update",refresh:c,_ajax_nonce:kontentblocks.nonces.update},type:"POST",dataType:"json",success:function(b){c&&a.$el.html(b.html),tinymce.triggerSave(),a.model.set("moduleData",b.newModuleData),a.model.view.render(),a.model.view.trigger("kb:moduleUpdated"),jQuery(window).trigger("kontentblocks::ajaxUpdate"),KB.Notice.notice("Module saved successfully","success")},error:function(){console.log("e")}})}}),KB.currentModule={},KB.currentArea={},_.extend(KB,Backbone.Events),KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function a(){var a=jQuery('<div id="kb-toolbar"></div>').appendTo("body");a.hide(),KB.Modules.on("add",c),KB.Areas.on("add",d),KB.Modules.on("remove",e),b(),KB.Ui.init()}function b(){return console.log(KB),KB.appData.config.preview?!1:(_.each(KB.payload.Areas,function(a){KB.Areas.add(new KB.Backbone.AreaModel(a))}),_.each(KB.payload.Modules,function(a){KB.Modules.add(a)}),void 0)}function c(a){a.setArea(KB.Areas.get(a.get("area"))),a.bind("change:area",a.areaChanged),KB.Views.Modules.add(a.get("instance_id"),new KB.Backbone.ModuleView({model:a,el:"#"+a.get("instance_id")})),KB.Ui.initTabs()}function d(a){KB.Views.Areas.add(a.get("id"),new KB.Backbone.AreaView({model:a,el:"#"+a.get("id")+"-container"}))}function e(a){KB.Views.Modules.remove(a.get("instance_id"))}return{init:a}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&KB.appData.config.frontend&&(_K.info("Frontend Modules Ready Event fired"),KB.Views.Modules.readyOnFront())}),jQuery(document).ready(function(){jQuery("div.editable").each(function(a,b){initTinymce(b)}),jQuery(".editable-title").each(function(){KB.Checks.userCan("edit_kontentblocks")&&tinymce.init({selector:"#"+this.id,theme:"modern",skin:!1,menubar:!1,add_unload_trigger:!1,schema:"html5",fixed_toolbar_container:"#kb-toolbar",inline:!0,toolbar:"kbcancleinline",statusbar:!1,setup:function(a){a.on("init",function(){var b=jQuery(a.bodyElement).data(),c=b.module;a.module=KB.Modules.get(c),a.kbDataRef={key:b.key,index:b.index,arrayKey:b.arraykey}}),a.on("focus",function(){jQuery("#kb-toolbar").show()}),a.addButton("kbcancleinline",{title:"Stop inline Edit",onClick:function(){tinymce.activeEditor=null,tinymce.focusedEditor=null,document.activeElement.blur(),jQuery("#kb-toolbar").hide()}}),a.on("blur",function(){jQuery("#kb-toolbar").hide();var b=a.kbDataRef,c=a.getContent(),d=_.clone(a.module.get("moduleData"));_.isUndefined(b.index)||_.isUndefined(b.arrayKey)?_.isUndefined(b.index)?_.isUndefined(b.arrayKey)?d[b.key]=c:d[b.arrayKey][b.key]=c:d[b.index][b.key]=c:d[b.arrayKey][b.index][b.key]=c,a.module.set("moduleData",d)})}})})});