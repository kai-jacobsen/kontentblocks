/*! Kontentblocks ProdVersion 2015-02-16 09:02 */
KB.Backbone.AreaModel=Backbone.Model.extend({defaults:{id:"generic"},idAttribute:"id"}),KB.Backbone.Frontend.FieldConfigModel=Backbone.Model.extend({idAttribute:"uid",initialize:function(){var a,b=this.get("baseId");b&&(a=KB.Modules.get(b))&&this.set("ModuleModel",a),this.listenToOnce(a,"remove",this.remove),this.setupType()},setupType:function(){var a=this.get("type");if("EditableText"===a){if(!KB.Checks.userCan("edit_kontentblocks"))return;new KB.Backbone.Inline.EditableText({el:jQuery('*[data-kbfuid="'+this.get("uid")+'"]')[0],model:this})}if("EditableImage"===a){if(!KB.Checks.userCan("edit_kontentblocks"))return;new KB.Backbone.Inline.EditableImage({el:jQuery('*[data-kbfuid="'+this.get("uid")+'"]')[0],model:this})}},remove:function(){this.collection.remove(this)}}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var a=this;KB.Ajax.send({action:"removeModules",instance_id:a.get("instance_id")},a.destroyed)},dispose:function(){this.stopListening()},setArea:function(){},areaChanged:function(){this.view.updateModuleForm()}}),KB.Backbone.AreaLayoutView=Backbone.View.extend({hasLayout:!1,initialize:function(a){this.AreaView=a.AreaView,this.listenTo(this.AreaView,"kb.module.created",this.handleModuleCreated),this.listenTo(this.AreaView,"kb.module.deleted",this.handleModuleDeleted),this.listenTo(this.model,"change:layout",this.handleLayoutChange),this.setupLayout(),this.renderPlaceholder()},setupLayout:function(a){var b,c;return c=KB.payload.AreaTemplates||{},b=a||this.model.get("layout"),"default"===b?(this.hasLayout=!1,null):void(c[b]?(this.hasLayout=!0,this.LayoutIterator=new KB.LayoutIterator(c[b],this.AreaView)):this.hasLayout=!1)},unwrap:function(){_.each(this.AreaView.getAttachedModules(),function(a){a.$el.unwrap()});var a=jQuery(".kb-outer-wrap",this.AreaView.$el);a.each(function(a){jQuery(".kb-wrap:first-child",a).unwrap()})},render:function(a){this.hasLayout?this.LayoutIterator.applyLayout(a):this.unwrap()},applyClasses:function(){var a,b,c=this.AreaView.$el.find(".module");c.removeClass("first-module last-module repeater");for(var d=0;d<c.length;d++){var e=jQuery(c[d]).data("ModuleView");_.isUndefined(e)||(0===d&&e.$el.addClass("first-module"),d===c.length-1&&e.$el.addClass("last-module"),b&&e.model.get("settings").id===b&&e.$el.addClass("repeater"),b=e.model.get("settings").id,a=e.$el.parent(),a.hasClass("kb-wrap")&&a.attr("rel",e.$el.attr("rel")))}},handleModuleCreated:function(){this.applyClasses(),this.LayoutIterator&&this.LayoutIterator.applyLayout(null)},handleModuleDeleted:function(){this.applyClasses(),this.renderPlaceholder(),this.LayoutIterator&&this.LayoutIterator.applyLayout(null)},handleLayoutChange:function(){this.setupLayout(),this.AreaView.setupSortables(),this.render(null)},renderPlaceholder:function(){0===this.AreaView.getNumberOfModules()&&this.AreaView.$el.addClass("kb-area__empty")}}),KB.LayoutIterator=function(a,b){this.AreaView=b,this.raw=a,this.position=0,this.current=null,this.maxNum=a.layout.length,this.id=a.id,this.label=a.label,this.lastItem=a["last-item"],this.cycle=a.cycle||!1,this.layout=a.layout,this.wrap=a.wrap||!1,this.setPosition=function(a){return this.position=a%this.maxNum,this.setCurrent(),this.position},this.getPosition=function(){return this.position},this.getLayout=function(a){return a&&this.cycle?this.layout[a%this.maxNum]:a&&!this.cycle?a>this.maxNum-1?this.layout[this.maxNum-1]:this.layout[a]:void 0},this.next=function(){this.position===this.maxNum-1&&this.cycle?this.position=0:this.position!==this.maxNum-1||this.cycle?this.position++:this.position=this.maxNum-1,this.setCurrent()},this.setCurrent=function(){this.current=this.layout[this.position]},this.getCurrent=function(){return this.current},this.hasWrap=function(){return this.wrap!==!1},this.applyLayout=function(a){{var b=this,c=this.AreaView.$el.find('.module:not(".ignore")'),d=[];jQuery(".kb-outer-wrap")}if(b.setPosition(0),jQuery(".kb-wrap").each(function(a,b){jQuery(b).parent().hasClass("kb-outer-wrap")&&jQuery(b).unwrap()}),_.each(c,function(c){var d=jQuery(c),e=d.parent(".kb-wrap");if(0===e.length){var f=jQuery('<div class="kb-wrap '+b.getCurrent().classes+'"></div>');d.wrap(f)}else e.removeClass(),e.addClass("kb-wrap "+b.getCurrent().classes);a&&a.placeholder&&a.placeholder.addClass("kb-front-sortable-placeholder"),b.next()}),this.hasWrap()){d=jQuery('.kb-wrap:not(".ignore")');for(var e=0;e<d.length;e+=this.maxNum)d.slice(e,e+this.maxNum).wrapAll("<div class='kb-outer-wrap "+this.wrap["class"]+"'></div>")}},this.setCurrent()},KB.Backbone.AreaView=Backbone.View.extend({isSorting:!1,events:{dblclick:"openModuleBrowser"},initialize:function(){this.attachedModuleViews={},this.settings=this.model.get("settings"),this.listenToOnce(KB.Events,"KB.frontend.init",this.setupUi),this.listenTo(this,"kb.module.deleted",this.removeModule),this.model.View=this},setupUi:function(){this.Layout=new KB.Backbone.AreaLayoutView({model:new Backbone.Model(this.settings),AreaView:this}),this.model.get("sortable")?(this.setupSortables(),_K.info("Area sortable initialized")):_K.info("Area sortable skipped")},openModuleBrowser:function(){return this.ModuleBrowser||(this.ModuleBrowser=new KB.Backbone.ModuleBrowser({area:this})),this.ModuleBrowser.render(),this.ModuleBrowser},addModuleView:function(a){this.attachedModuleViews[a.model.get("instance_id")]=a,this.listenTo(a.model,"change:area",this.removeModule),_K.info("Module:"+a.model.id+" was added to area:"+this.model.id),this.getNumberOfModules()>0&&this.$el.removeClass("kb-area__empty"),this.trigger("kb.module.created",a)},getNumberOfModules:function(){return _.size(this.attachedModuleViews)},getAttachedModules:function(){return this.attachedModuleViews},setupSortables:function(){var a=this;this.$el.sortable(this.Layout.hasLayout?{handle:".kb-module-inline-move",items:".kb-wrap",helper:"clone",opacity:.5,forcePlaceholderSize:!0,delay:150,placeholder:"kb-front-sortable-placeholder",start:function(b,c){a.isSorting=!0,c.helper.hasClass("ui-draggable-dragging")&&c.helper.addClass("kb-wrap"),c.placeholder.attr("class",c.helper.attr("class")),c.placeholder.addClass("kb-front-sortable-placeholder"),c.placeholder.append("<div class='module kb-dummy'></div>"),jQuery(".module",c.helper).addClass("ignore"),c.helper.addClass("ignore"),a.Layout.applyClasses(),a.Layout.render(c)},receive:function(b,c){var d=c.item.data("module");a.isSorting=!1,d.create(c)},beforeStop:function(b,c){var d={};return a.isSorting=!1,d[a.model.get("id")]=a.$el.sortable("serialize",{attribute:"rel"}),jQuery(".ignore",c.helper).removeClass("ignore"),KB.Ajax.send({action:"resortModules",data:d,_ajax_nonce:KB.Config.getNonce("update")},function(){KB.Notice.notice("Order was updated successfully","success"),a.Layout.render(c)},a)},change:function(b,c){a.Layout.applyClasses(),a.Layout.render(c)},over:function(b){a.Layout.applyClasses(),a.Layout.render(b)}}:{handle:".kb-module-inline-move",items:".module",helper:"clone",cursorAt:{top:5,left:5},delay:150,placeholder:"kb-front-sortable-placeholder",start:function(){a.isSorting=!0},receive:function(b,c){var d=c.item.data("module");a.isSorting=!1,d.create(c)},stop:function(){a.isSorting&&(a.isSorting=!1,a.resort(a.model))},change:function(){a.Layout.applyClasses()}})},changeLayout:function(a){this.Layout.model.set("layout",a),this.$el.sortable("destroy"),this.setupSortables()},removeModule:function(a){var b=a.model.get("mid");this.attachedModuleViews[b]&&delete this.attachedModuleViews[b],_K.info("Module:"+a.model.id+" was removed from area:"+this.model.id),this.getNumberOfModules()<0&&this.$el.addClass("kb-area__empty")},resort:function(a){var b={};return b[a.get("id")]=a.View.$el.sortable("serialize",{attribute:"rel"}),KB.Ajax.send({action:"resortModules",postId:a.get("envVars").postId,data:b,_ajax_nonce:KB.Config.getNonce("update")},function(){KB.Notice.notice("Order was updated successfully","success")},null)}}),KB.Backbone.EditModalAreas=Backbone.View.extend({tagName:"div",id:"kb-area-modal",$target:null,$layoutList:null,AreaView:null,LayoutDefs:KB.payload.AreaTemplates||{},events:{"click li":"layoutSelect","click .close-controls":"close"},initialize:function(a){var b=this;this.setTarget(a.target),this.AreaView=a.AreaView,jQuery(KB.Templates.render("frontend/area-edit-form",{model:this.model.toJSON(),i18n:KB.i18n.jsFrontend})).appendTo(this.$el),jQuery("body").append(this.$el),jQuery(window).on("resize",function(){b.reposition()}),this.$layoutList=jQuery("ul",this.$el),this.render()},render:function(){this.$el.show(),this.setOptions(),this.reposition()},layoutSelect:function(a){var b=jQuery(a.currentTarget);this.$el.find(".kb-active-area-layout").removeClass(),b.addClass("kb-active-area-layout"),this.AreaView.changeLayout(b.data("item"))},setModel:function(a){return this.model=a,this},setArea:function(a){return this.AreaView=a,this},setTarget:function(a){this.$target=jQuery(a)},close:function(){this.$el.hide()},setOptions:function(){var a="",b=this.model.get("layouts");this.$layoutList.find("li").remove(),b&&b.length>0&&(_.each(this.prepareLayouts(b),function(b){a+=KB.Templates.render("frontend/area-layout-item",{item:b})}),this.$layoutList.append(a))},prepareLayouts:function(a){var b=this,c=this.model.get("settings").layout;return _.map(a,function(a){if(b.LayoutDefs[a]){var d=b.LayoutDefs[a];return d.currentClass=d.id===c?"kb-active-area-layout":"",d}})},reposition:function(){var a=this.$target.offset();console.log(a);var b=this.$el.outerHeight();a.top=a.top-b,this.$el.offset({top:a.top-27,left:a.left})}}),KB.Backbone.EditModalModules=Backbone.View.extend({tagName:"div",id:"onsite-modal",timerId:null,initialize:function(){var a=this;return jQuery(KB.Templates.render("frontend/module-edit-form",{model:{},i18n:KB.i18n.jsFrontend})).appendTo(this.$el),this.$form=jQuery("#onsite-form",this.$el),this.$formContent=jQuery("#onsite-content",this.$el),this.$inner=jQuery(".os-content-inner",this.$formContent),this.$title=jQuery(".controls-title",this.$el),this.$draft=jQuery(".kb-modal__draft-notice",this.$el),this.LoadingAnimation=new KB.Backbone.Shared.LoadingAnimation({el:this.$form}),this.$el.css("position","fixed").draggable({handle:"h2",containment:"window",stop:function(b,c){KB.OSConfig.wrapPosition=c.position,a.recalibrate(c.position)}}),this.listenTo(KB.Events,"kb.modal.refresh",this.recalibrate),this.listenTo(KB.Events,"kb.modal.preview",this.preview),jQuery(window).on("resize",function(){a.recalibrate()}),this.listenTo(KB.Events,"KB::tinymce.new-editor",function(b){b.settings&&b.settings.kblive&&a.attachEditorEvents(b)}),jQuery(document).on("change",".kb-observe",function(){a.serialize(!1,!0)}),this},events:{keyup:"delayInput","click a.close-controls":"destroy","click a.kb-save-form":"update","click a.kb-preview-form":"preview","change .kb-template-select":"viewfileChange"},openView:function(a,b){return this.setupWindow(),b=_.isUndefined(b)?!1:!0,this.ModuleView&&this.ModuleView.cid===a.cid?(_K.log("Module View already set"),this):(this.ModuleView=a,this.model=a.model,this.attach(),this.render(),this)},attach:function(){var a=this;this.listenTo(this.ModuleView,"kb.frontend.module.inline.saved",this.frontendViewUpdated),this.listenTo(this.model,"change:viewfile",function(){a.serialize(!1,!0),a.render()}),this.listenTo(this.model,"kb.frontend.module.inlineUpdate",function(){a.render(!0),a.$el.addClass("isDirty")}),this.listenTo(this.ModuleView,"kb.module.view.delete",this.destroy)},detach:function(){this.stopListening(this.ModuleView),this.stopListening(this.model),this.ModuleView.attachedFields={},delete this.ModuleView},destroy:function(){var a=this;a.detach(),jQuery(".wp-editor-area",this.$el).each(function(a,b){tinymce.remove("#"+b.id)}),a.unbind(),a.$el.detach()},setupWindow:function(){this.$el.appendTo("body").show(),KB.OSConfig.wrapPosition&&this.$el.css({top:KB.OSConfig.wrapPosition.top,left:KB.OSConfig.wrapPosition.left})},frontendViewUpdated:function(){this.$el.removeClass("isDirty"),this.render()},preview:function(){this.serialize(!1,!1)},update:function(){this.serialize(!0,!0),this.switchDraftOff()},render:function(a){var b,c=this;_KS.info("Frontend modal retrieves data from the server"),a=!_.isUndefined(a),b=this.model.toJSON(),this.applyControlsSettings(this.$el),this.updateViewClassTo=!1,jQuery.ajax({url:ajaxurl,data:{action:"getModuleForm",module:b,moduleData:b.moduleData,overloadData:a,_ajax_nonce:KB.Config.getNonce("read")},type:"POST",dataType:"json",beforeSend:function(){c.LoadingAnimation.show()},success:function(a){c.$inner.empty(),c.ModuleView.clearFields(),c.$inner.attr("id",c.model.get("instance_id")),c.$inner.append(a.data.html),c.model.get("state").draft?c.$draft.show(150):c.$draft.hide(),a.json&&(KB.payload=_.extend(KB.payload,a.data.json)),KB.Ui.initTabs(),KB.Ui.initToggleBoxes(),KB.TinyMCE.addEditor(c.$form),_K.info("Frontend Modal opened with view of:"+c.model.get("instance_id")),_KS.info("Frontend modal done."),c.$title.text(c.model.get("settings").name),setTimeout(function(){KB.Fields.trigger("frontUpdate",c.ModuleView)},500),setTimeout(function(){c.$el.show(),c.recalibrate(),c.LoadingAnimation.hide()},550)},error:function(){KB.Notice.notice("There went something wrong","error")}})},recalibrate:function(){var a,b,c,d;a=jQuery(window).height()-40,b=jQuery(".os-content-inner").height(),c=this.$el.position(),d=b+c.top-a,this.initScrollbars(d>0?b-(d+30):b-c.top<a?b:a-c.top),c.top<35&&this.$el.css("top","35px"),_K.info("Frontend Modal resizing done!")},initScrollbars:function(a){jQuery(".kb-nano",this.$el).height(a+20),jQuery(".kb-nano").nanoScroller({preventPageScrolling:!0,contentClass:"kb-nano-content"}),_K.info("Nano Scrollbars (re)initialized!")},serialize:function(a,b){var c,d=this,e=a||!1,f=b!==!1;this.LoadingAnimation.show(.5),_K.info("Frontend Modal called serialize function. Savemode:",a),tinymce.triggerSave(),jQuery.ajax({url:ajaxurl,data:{action:"updateModule",data:d.$form.serializeJSON(),module:d.model.toJSON(),editmode:e?"update":"preview",_ajax_nonce:KB.Config.getNonce("update")},type:"POST",dataType:"json",success:function(a){var b;b=jQuery(".kb-module-controls",d.ModuleView.$el),b.length>0&&b.detach(),jQuery(".editable",d.ModuleView.$el).each(function(a,b){tinymce.remove("#"+b.id)}),c=d.ModuleView.$el.height(),d.updateViewClassTo!==!1&&d.updateContainerClass(d.updateViewClassTo),d.ModuleView.$el.html(a.html),d.model.set("moduleData",a.newModuleData),e&&d.model.trigger("saved"),jQuery(document).trigger("kb:module-update-"+d.model.get("settings").id,d.ModuleView),d.ModuleView.delegateEvents(),d.ModuleView.trigger("kb:frontend::viewUpdated"),KB.Events.trigger("KB::ajax-update"),KB.trigger("kb:frontendModalUpdated"),setTimeout(function(){jQuery(".editable",d.ModuleView.$el).each(function(a,b){KB.IEdit.Text(b)}),d.ModuleView.render(),d.ModuleView.setControlsPosition()},400),e?(f&&KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticeDataSaved,"success"),d.$el.removeClass("isDirty"),d.ModuleView.getClean(),d.trigger("kb:frontend-save")):(f&&KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticePreviewUpdated,"success"),d.$el.addClass("isDirty")),b.length>0&&d.ModuleView.$el.append(b),d.ModuleView.trigger("kb.view.module.HTMLChanged"),_K.info("Frontend Modal saved data for:"+d.model.get("instance_id")),d.LoadingAnimation.hide()},error:function(){_K.error("serialize | FrontendModal | Ajax error")}})},viewfileChange:function(a){this.updateViewClassTo={current:this.ModuleView.model.get("viewfile"),target:a.currentTarget.value},this.model.set("viewfile",a.currentTarget.value)},updateContainerClass:function(a){a&&a.current&&a.target||_K.error("updateContainerClass | frontendModal | parameter exception"),this.ModuleView.$el.removeClass(this._classifyView(a.current)),this.ModuleView.$el.addClass(this._classifyView(a.target)),this.updateViewClassTo=!1},delayInput:function(){var a=this;this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(function(){a.timerId=null,a.serialize(!1,!1)},750)},attachEditorEvents:function(a){var b=this;a.onKeyUp.add(function(){b.delayInput()})},applyControlsSettings:function(a){var b=this.model.get("settings");b.controls&&b.controls.width&&a.css("width",b.controls.width+"px"),b.controls&&b.controls.fullscreen?a.width("100%").height("100%").addClass("fullscreen"):a.height("").removeClass("fullscreen")},_classifyView:function(a){return"view-"+a.replace(".twig","")},switchDraftOff:function(){var a=this.model.toJSON(),b=this;this.model.get("state").draft&&KB.Ajax.send({action:"undraftModule",mid:a.instance_id,_ajax_nonce:KB.Config.getNonce("update")},function(a){a.success&&b.$draft.hide(150)},this)}}),KB.Backbone.Shared.LoadingAnimation=Backbone.View.extend({$overlay:jQuery('<div class="kb-loading-overlay" style="display: none;"><span class="kb-loading-loader"><span class="kb-loading-loader-inner"></span></span></div>'),initialize:function(){this.$el.css("position","relative").append(this.$overlay)},show:function(a){a?this.$overlay.fadeTo(150,a):this.$overlay.show()},hide:function(){this.$overlay.fadeOut(350)}}),KB.Backbone.ModuleMenuItem=Backbone.View.extend({initialize:function(){var a=this;this.parentView=this.model,this.el=KB.Templates.render("frontend/module-menu-item",{view:this.parentView.model.toJSON()}),this.$el=jQuery(this.el),this.parentView.controlView=this,jQuery(window).scroll(function(){a.parentView.$el.visible(!0,!0)?(a.$el.addClass("in-viewport"),a.$el.show(250)):(a.$el.removeClass("in-viewport"),a.$el.hide(250))}),this.parentView.$el.on("mouseenter",function(){a.$el.addClass("in-viewport-active")}),this.parentView.$el.on("mouseleave",function(){a.$el.removeClass("in-viewport-active")})},events:{mouseenter:"over",mouseleave:"out",click:"scrollTo","click .kb-menubar-item__edit":"openControls","click .kb-js-inline-update":"inlineUpdate"},render:function(){return this.$el},over:function(){this.parentView.$el.addClass("kb-menubar-active")},out:function(){this.parentView.$el.removeClass("kb-menubar-active")},openControls:function(a){a.stopPropagation(),this.parentView.openOptions()},inlineUpdate:function(a){a.stopPropagation(),this.parentView.Controls.UpdateControl.update(),this.parentView.getClean()},scrollTo:function(){var a=this;jQuery("html, body").animate({scrollTop:a.parentView.$el.offset().top-100},750)}}),KB.Backbone.AreaNavItem=Backbone.View.extend({events:{mouseenter:"over",mouseleave:"out","click .kb-menubar-item__edit":"openAreaSettings","click .kb-menubar-item__update":"updateAreaSettings"},initialize:function(){this.parentView=this.model,this.el=KB.Templates.render("frontend/area-menu-item",{view:this.parentView.model.toJSON()}),this.$el=jQuery(this.el),this.parentView.controlView=this},render:function(){return this.$el},over:function(){this.parentView.$el.addClass("kb-menubar-area-active")},out:function(){this.parentView.$el.removeClass("kb-menubar-area-active")},openAreaSettings:function(a){return KB.EditModalAreas?(KB.EditModalAreas.setArea(this.parentView).setModel(this.parentView.model),KB.EditModalAreas.render(),this):void(KB.EditModalAreas=new KB.Backbone.EditModalAreas({model:this.parentView.model,target:a.currentTarget,AreaView:this.parentView}))},updateAreaSettings:function(){KB.Ajax.send({action:"saveAreaLayout",area:this.model.model.toJSON(),layout:this.model.Layout.model.get("layout"),_ajax_nonce:KB.Config.getNonce("update")},this.updateSuccess,this)},updateSuccess:function(a){200===a.status?KB.Notice.notice(a.response,"success"):KB.Notice.notice("That did not work","error")}}),KB.Backbone.MenubarView=Backbone.View.extend({subviews:[],tagName:"div",className:"kb-menubar-container",invisible:!0,initialize:function(){this.AreaViews={},this.$title=jQuery('<div class="kb-module-controls__title"> </div>').appendTo(this.$el),this.show=_.isNull(KB.Util.stex.get("kb-menubar-show"))?!0:KB.Util.stex.get("kb-menubar-show"),this.$toggle=jQuery('<div class="kb-menubar-toggle genericon genericon-menu"></div>').appendTo(this.$el),this.$modulesTab=jQuery('<div data-list="modules" class="kb-menubar-tab kb-menubar-tab__modules kb-tab-active">Modules</div>').appendTo(this.$title),this.$areasTab=jQuery('<div data-list="areas" class="kb-menubar-tab kb-menubar-tab__areas">Areas</div>').appendTo(this.$title),this.StatusBar=new KB.Backbone.Frontend.StatusBar({el:this.$title}),this.render()},events:{"click .kb-menubar-toggle":"toggleView","click .kb-menubar-add_module":"renderDropzones","mouseenter .kb-menubar-toggle":"over","mouseleave .kb-menubar-toggle":"out","click .kb-menubar-tab":"switchTabs"},render:function(){this.$el.appendTo("body"),this.$modulesList=jQuery('<ul class="kb-menubar__modules"></ul>').appendTo(this.$el),this.$areasList=jQuery('<ul class="kb-menubar__areas"></ul>').appendTo(this.$el),this.$areasList.hide(),this.show&&this.$el.addClass("kb-menubar-show")},attachModuleView:function(a){a.Menubar=this,this.renderModuleViewItem(a)},renderModuleViewItem:function(a){var b=new KB.Backbone.ModuleMenuItem({model:a});this.$modulesList.append(b.render())},attachAreaView:function(a){a.model.get("internal")||(a.Menubar=this,this.renderAreaViewItem(a),this.AreaViews[a.model.get("id")]=a)},renderAreaViewItem:function(a){var b=new KB.Backbone.AreaNavItem({model:a});this.$areasList.append(b.render())},toggleView:function(){this.$el.toggleClass("kb-menubar-show"),this.$el.removeClass("kb-menubar-show-partly");var a=!this.show;this.show=a,KB.Util.stex.set("kb-menubar-show",a,864e5)},over:function(){this.show||this.$el.addClass("kb-menubar-show-partly")},out:function(){this.show||this.$el.removeClass("kb-menubar-show-partly")},switchTabs:function(a){var b,c;b=jQuery(a.currentTarget),jQuery(".kb-tab-active").removeClass("kb-tab-active"),c=b.data("list"),b.addClass("kb-tab-active"),"areas"===c?(this.$modulesList.hide(),this.$areasList.show()):(this.$modulesList.show(),this.$areasList.hide()),jQuery(window).trigger("scroll")}}),KB.Backbone.Frontend.ModuleMenuItemView=Backbone.View.extend({tagName:"a",isValid:function(){return!0}}),KB.Backbone.Frontend.ModuleDelete=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{},this.Parent=a.parent,this.$el.append('<span class="dashicons dashicons-trash"></span><span class="os-action">'+KB.i18n.jsFrontend.moduleControls.controlsDelete+"</span>")},className:"kb-module-inline-delete kb-nbt kb-nbb kb-js-inline-delete",events:{click:"confirmRemoval"},confirmRemoval:function(){KB.Notice.confirm(KB.i18n.EditScreen.notices.confirmDeleteMsg,this.removeModule,this.cancelRemoval,this)},removeModule:function(){KB.Ajax.send({action:"removeModules",_ajax_nonce:KB.Config.getNonce("delete"),module:this.model.get("instance_id")},this.afterRemoval,this)},afterRemoval:function(){this.Parent.trigger("kb.module.view.delete"),this.Parent.$el.parent(".kb-wrap").remove(),this.trigger("remove"),KB.Modules.remove(this.model)},cancelRemoval:function(){return!1},isValid:function(){return KB.Checks.userCan("delete_kontentblocks")}}),KB.Backbone.Frontend.ModuleEdit=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{},this.Parent=a.parent,this.$el.append('<span class="dashicons dashicons-edit"></span><span class="os-action">'+KB.i18n.jsFrontend.moduleControls.controlsEdit+"</span>")},className:"os-edit-block kb-module-edit",events:{click:"openForm"},openForm:function(){return KB.EditModalModules.openView(this.Parent),KB.focusedModule=this.model,this},isValid:function(){return KB.Checks.userCan("edit_kontentblocks")},success:function(){}}),KB.Backbone.Frontend.ModuleMove=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{},this.Parent=a.parent,this.$el.append('<span class="genericon genericon-draggable"></span><span class="os-action"></span>')},className:"kb-module-inline-move kb-nbt kb-nbb",isValid:function(){return this.Parent.Area?KB.Checks.userCan("edit_kontentblocks")&&this.Parent.Area.get("sortable"):!1}}),KB.Backbone.Frontend.ModuleUpdate=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(a){this.options=a||{},this.Parent=a.parent,this.$el.append('<span class="dashicons dashicons-update"></span><span class="os-action">'+KB.i18n.jsFrontend.moduleControls.controlsUpdate+"</span>")},className:"kb-module-inline-update kb-nbt kb-nbb kb-js-inline-update",events:{click:"update"},update:function(){var a=this,b={},c=!1;b[a.model.get("instance_id")]=a.model.get("moduleData"),jQuery.ajax({url:ajaxurl,data:{action:"updateModule",data:b,module:a.model.toJSON(),editmode:"update",refresh:c,_ajax_nonce:KB.Config.getNonce("update")},type:"POST",dataType:"json",success:function(b){c&&a.$el.html(b.html),tinymce.triggerSave(),a.model.set("moduleData",b.newModuleData),a.Parent.render(),a.Parent.trigger("kb.frontend.module.inline.saved"),a.model.trigger("saved"),KB.Events.trigger("KB::ajax-update"),KB.Notice.notice("Module saved successfully","success"),a.Parent.$el.removeClass("isDirty")},error:function(){KB.Notice.notice("There went something wrong","error")}})},isValid:function(){return KB.Checks.userCan("edit_kontentblocks")}}),KB.Backbone.Frontend.ModuleControlsView=Backbone.View.extend({ModuleView:null,$menuList:null,initialize:function(a){this.ModuleView=a.ModuleView,this.renderControls(),this.EditControl=this.addItem(new KB.Backbone.Frontend.ModuleEdit({model:this.ModuleView.model,parent:this.ModuleView})),this.UpdateControl=this.addItem(new KB.Backbone.Frontend.ModuleUpdate({model:this.ModuleView.model,parent:this.ModuleView})),this.DeleteControl=this.addItem(new KB.Backbone.Frontend.ModuleDelete({model:this.ModuleView.model,parent:this.ModuleView})),this.MoveControl=this.addItem(new KB.Backbone.Frontend.ModuleMove({model:this.ModuleView.model,parent:this.ModuleView}))},renderControls:function(){this.ModuleView.$el.append(KB.Templates.render("frontend/module-controls",{model:this.ModuleView.model.toJSON(),i18n:KB.i18n.jsFrontend})),this.$el=jQuery(".kb-module-controls",this.ModuleView.$el),this.$menuList=jQuery('<ul class="controls-wrap"></ul>').appendTo(this.$el)},addItem:function(a){if(a.isValid&&a.isValid()===!0){var b=jQuery("<li></li>").appendTo(this.$menuList),c=b.append(a.el);return this.$menuList.append(c),a}}}),KB.Backbone.ModuleView=Backbone.View.extend({focus:!1,$dropZone:jQuery('<div class="kb-module__dropzone"><span class="dashicons dashicons-plus"></span> add </div>'),attachedFields:[],initialize:function(a){return KB.Checks.userCan("edit_kontentblocks")?(this.Area=a.Area,this.Area.View.addModuleView(this),this.model.view=this,this.listenTo(this.model,"change",this.modelChange),this.listenTo(this.model,"save",this.model.save),this.$el.data("ModuleView",this),this.render(),this.setControlsPosition(),void(this.Controls=new KB.Backbone.Frontend.ModuleControlsView({ModuleView:this}))):void _K.log("Permission insufficient")},events:{"click .kb-module__placeholder":"openOptions","click .kb-module__dropzone":"setDropZone","click .kb-js-inline-delete":"confirmDelete","click .editable":"reloadModal","mouseenter.first":"setActive","mouseenter.second":"setControlsPosition"},openOptions:function(){this.Controls.EditControl.openForm()},setActive:function(){KB.currentModule=this},render:function(){var a;this.$el.hasClass("draft")&&""===this.model.get("moduleData")&&this.renderPlaceholder(),this.$el.attr("rel",this.model.get("mid")+"_"+_.uniqueId()),a=this.model.get("settings"),a.controls&&a.controls.hide||jQuery(".os-controls",this.$el).length>0},setControlsPosition:function(){var a,b,c,d,e,f;a=0,b=0,c=this.model.get("settings"),d=jQuery(".os-controls",this.$el),e=this.$el.offset(),f=this.$el.height(),c.controls&&c.controls.toolbar&&(e.top=c.controls.toolbar.top,e.left=c.controls.toolbar.left),"hidden"!==this.$el.css("overflow")&&e.top>60&&119>f&&(a=-25),"hidden"!==this.$el.css("overflow")&&e.left>100&&f>120&&this.$el["class"]&&(a=0,b=-30,d.addClass("kb-module-nav__vertical")),e.top<20&&(a=10),d.css({top:a+"px",left:b})},reloadModal:function(a){return KB.EditModalModules&&KB.EditModalModules.reload(this,a),KB.CurrentModel=this.model,KB.focusedModule=this.model,this},insertDropZone:function(){this.focus=!0,this.$el.append(this.$dropZone)},removeDropZone:function(){this.focus=!1,this.$el.find(".kb-module__dropzone").remove()},setDropZone:function(){var a;a=this.Area.openModuleBrowser(),a.dropZone=this},renderPlaceholder:function(){this.$el.append(KB.Templates.render("frontend/module-placeholder",{model:this.model.toJSON()}))},addField:function(a,b,c){_.isEmpty(c)?this.attachedFields[a]=b:this.attachedFields[c][a]=b},hasField:function(a,b){return _.isEmpty(b)?a in this.attachedFields:(this.attachedFields[b]||(this.attachedFields[b]={}),a in this.attachedFields[b])},getField:function(a,b){return _.isEmpty(b)?this.attachedFields[a]:this.attachedFields[b][a]},clearFields:function(){_K.info("Attached Fields were reset to empty object"),this.attachedFields={}},getDirty:function(){this.$el.addClass("isDirty")},getClean:function(){this.$el.removeClass("isDirty")},modelChange:function(){this.getDirty()},save:function(){},dispose:function(){delete this.model.view,this.stopListening(),this.remove()}}),KB.Backbone.SidebarView=Backbone.View.extend({currentView:null,viewStack:[],initialize:function(){this.render();var a=KB.Templates.render("frontend/sidebar/sidebar-nav",{});this.$navControls=jQuery(a),this.bindHandlers(),this.AreaList=new KB.Backbone.Sidebar.AreaOverview.AreaOverviewController({controller:this}),this.CategoryFilter=new KB.Backbone.Sidebar.CategoryFilter,this.setView(this.AreaList)},events:{"click .kb-js-sidebar-nav-back":"rootView"},render:function(){this.$el=jQuery('<div class="kb-sidebar-wrap" style="display: none;"></div>').appendTo("body"),this.$toggle=jQuery('<div class="kb-sidebar-wrap--toggle cbutton cbutto-effect--boris"></div>').appendTo("body"),this.Header=new KB.Backbone.Sidebar.Header({}),this.$el.append(this.Header.render()),this.$container=jQuery('<div class="kb-sidebar-wrap__container"></div>').appendTo(this.$el),this.setLayout()},bindHandlers:function(){var a=this;jQuery(window).resize(function(){a.setLayout()}),this.$toggle.on("click",function(){a.toggleSidebar()})},setLayout:function(){var a=jQuery(window).height();this.$el.height(a);var b=KB.Util.stex.get("kb-sidebar-visible");b&&this.toggleSidebar()},setView:function(a){this.currentView&&this.currentView.$el.detach(),this.currentView=a,this.viewStack.push(a),this.$container.html(a.render()),this.handleNavigationControls()},prevView:function(){var a=this.viewStack.shift();a&&this.setView(a)},rootView:function(){this.viewStack=[],this.setView(this.AreaList)},handleNavigationControls:function(){this.viewStack.length>=2?this.$navControls.prependTo(this.$container):this.$navControls.detach()},toggleSidebar:function(){this.visible=!this.visible,this.$el.fadeToggle(),jQuery("body").toggleClass("kb-sidebar-visible"),KB.Util.stex.set("kb-sidebar-visible",this.visible,36e5)}}),KB.Backbone.Sidebar.AreaDetails.AreaDetailsController=Backbone.View.extend({tagName:"div",className:"kb-sidebar__module-list",initialize:function(a){this.controller=a.controller,this.sidebarController=a.sidebarController,this.categories=this.sidebarController.CategoryFilter.filter(this.model),this.Settings=new KB.Backbone.Sidebar.AreaDetails.AreaSettings({model:this.model,controller:this,sidebarController:this.sidebarController}),this.renderHeader(),this.$settingsContainer.append(this.Settings.render()),this.renderCategories()},events:{"click .kb-sidebar-area-details__cog":"toggle"},render:function(){return this.$el},renderHeader:function(){this.$el.append(KB.Templates.render("frontend/sidebar/area-details-header",this.model.toJSON())),this.$settingsContainer=this.$el.find(".kb-sidebar-area-details__settings")},renderCategories:function(){var a=this;_.each(this.categories.toJSON(),function(b){var c=new KB.Backbone.Sidebar.AreaDetails.CategoryController({model:new Backbone.Model(b),controller:a});a.$el.append(c.render())})},toggle:function(){this.$settingsContainer.slideToggle()
}}),KB.Backbone.Sidebar.AreaDetails.AreaSettings=Backbone.View.extend({tagName:"ul",className:"kb-sidebar-area-details__templates",LayoutDefs:KB.payload.AreaTemplates||{},events:{"click li":"layoutSelect"},initialize:function(a){this.controller=a.controller,this.sidebarController=a.SidebarController,this.setOptions()},render:function(){return this.$el},layoutSelect:function(a){var b=jQuery(a.currentTarget);this.$el.find(".kb-active-area-layout").removeClass(),b.addClass("kb-active-area-layout"),this.model.View.changeLayout(b.data("item"))},setOptions:function(){var a="",b=this.model.get("layouts");b&&b.length>0&&(this.$el.prepend('<div class="kb-sidebar-area-details__subheader">Layouts</div>'),_.each(this.prepareLayouts(b),function(b){a+=KB.Templates.render("frontend/area-layout-item",{item:b})}),this.$el.append(a))},prepareLayouts:function(a){var b=this,c=this.model.get("settings").layout;return _.map(a,function(a){if(b.LayoutDefs[a]){var d=b.LayoutDefs[a];return d.currentClass=d.id===c?"kb-active-area-layout":"",d}})}}),KB.Backbone.Sidebar.AreaDetails.CategoryController=Backbone.View.extend({tagName:"div",className:"kb-sidebar__module-category",initialize:function(a){this.controller=a.controller,this.$el.append(KB.Templates.render("frontend/sidebar/category-list",this.model.toJSON())),this.$list=this.$el.find("ul"),this.setupModuleItems()},render:function(){return this.$el},setupModuleItems:function(){var a=this;_.each(this.model.get("modules"),function(b){var c=new KB.Backbone.Sidebar.AreaDetails.ModuleDragItem({model:new Backbone.Model(b),listController:a.controller,controller:a});a.$list.append(c.render())})}}),KB.Backbone.Sidebar.CategoryFilter=Backbone.View.extend({categories:KB.payload.ModuleCategories,definitions:KB.payload.ModuleDefinitions,initialize:function(){this.setupSortTable()},filter:function(a){var b=this.setupSortTable(),c=a.get("assignedModules");return _.each(this.definitions,function(a,d){-1!==_.indexOf(c,d)&&(b[a.settings.category].modules[d]=a)}),new Backbone.Model(this.removeEmptyCats(b))},setupSortTable:function(){var a={};return _.each(this.categories,function(b,c){a[c]={name:b,id:c,modules:{}}}),a},removeEmptyCats:function(a){return _.each(a,function(b,c){_.isEmpty(b.modules)&&delete a[c]}),a.core&&delete a.core,a}}),KB.Backbone.Sidebar.AreaDetails.ModuleDragItem=Backbone.View.extend({tagName:"li",className:"kb-sidebar-module",initialize:function(a){var b=this;this.controller=a.controller,this.listController=a.listController,this.$el.append(KB.Templates.render("frontend/sidebar/category-module-item",this.model.toJSON())),this.$dropHelper=jQuery("<div class='kb-sidebar-drop-helper ui-sortable-helper'></div>"),this.model.set("area",this.listController.model),this.$el.draggable({appendTo:b.listController.model.View.$el.selector,revert:"invalid",refreshPositions:!0,cursorAt:{top:5,left:5},stop:function(){b.listController.model.View.$el.css("overflow","")},helper:function(){return b.listController.model.View.$el.css("overflow","hidden"),b.$dropHelper},drag:function(){b.$dropHelper.css("zIndex","10000")},connectToSortable:this.listController.model.View.$el.selector}).data("module",this)},render:function(){return this.$el},create:function(a){var b,c,d;return KB.Checks.userCan("create_kontentblocks")||KB.Notice.notice("You're not allowed to do this","error"),b=KB.Areas.get(this.model.get("area").get("id")),KB.Checks.blockLimit(b)?(d=this.model,c={action:"createNewModule","class":d.get("settings")["class"],master:d.get("master"),masterRef:d.get("masterRef"),template:d.get("template"),templateRef:d.get("templateRef"),areaContext:b.get("context"),area:b.get("id"),_ajax_nonce:KB.Config.getNonce("create"),frontend:KB.appData.config.frontend},void KB.Ajax.send(c,this.success,this,{ui:a})):(KB.Notice.notice("Limit for this area reached","error"),!1)},success:function(a,b){var c;b.ui.helper.replaceWith(a.data.html),c=KB.Modules.add(new KB.Backbone.ModuleModel(a.data.module)),this.model.get("area").View.addModuleView(c.view),KB.Backbone.AreaView.prototype.resort(this.model.get("area"))}}),KB.Backbone.Sidebar.AreaOverview.AreaListItem=Backbone.View.extend({tagName:"ul",className:"kb-sidebar-areaview__modules-list",ModuleViews:{},initialize:function(a){this.Modules=new Backbone.Collection,this.$parent=a.$el,this.controller=a.controller,this.sidebarController=a.sidebarController,this.$toggleHandle=this.$parent.find(".kb-sidebar-areaview__title"),this.ModuleList=new KB.Backbone.Sidebar.AreaDetails.AreaDetailsController({controller:a.controller,sidebarController:a.sidebarController,model:this.model}),this.render(),this.bindHandlers()},render:function(){this.$el.appendTo(this.$parent).hide()},bindHandlers:function(){var a=this;this.listenTo(this.Modules,"add",this.renderModuleItem),this.$toggleHandle.on("click",function(){a.controller.setActiveList(a)}),this.$parent.on("click",".kb-js-sidebar-add-module",function(){a.sidebarController.setView(a.ModuleList)}),this.listenToOnce(KB.Events,"KB.frontend.init",this.afterInit)},activate:function(){this.$parent.removeClass("kb-sidebar-areaview--inactive"),this.model.View.$el.addClass("kb-in-sidebar-active")},deactivate:function(){this.$parent.addClass("kb-sidebar-areaview--inactive"),this.model.View.$el.removeClass("kb-in-sidebar-active")},renderModuleItem:function(a){this.ModuleViews[a.id]=new KB.Backbone.Sidebar.AreaOverview.ModuleListItem({$parent:this.$el,model:a})},attachModuleView:function(a){this.Modules.add(a.model),this.listenToOnce(a.model,"remove",this.removeModuleView)},removeModuleView:function(a){var b=this.ModuleViews[a.id];this.Modules.remove(a),delete this.ModuleViews[a.id],b.dispose()},afterInit:function(){0===this.Modules.models.length&&this.model.View.$el.is(":visible")&&this.$el.append(KB.Templates.render("frontend/sidebar/empty-area",{}))}}),KB.Backbone.Sidebar.AreaOverview.AreaOverviewController=Backbone.View.extend({tagName:"div",className:"kb-sidebar-main-panel",Areas:new Backbone.Collection,AreaViews:{},activeList:null,events:{"click .kb-sidebar-areaview__title":"toggleList"},initialize:function(a){this.sidebarController=a.controller,this.render(),this.bindHandlers()},render:function(){return this.$el},bindHandlers:function(){this.listenTo(KB.Views.Areas,"view:add",this.attachAreaView),this.listenTo(KB.Views.Modules,"view:add",this.attachModuleView),this.listenTo(this.Areas,"add",this.createAreaItem)},attachAreaView:function(a){this.Areas.add(a.model)},attachModuleView:function(a){var b=this.AreaViews[a.model.get("area")];b&&b.attachModuleView(a)},createAreaItem:function(a){if(!a.get("internal")){var b=jQuery(KB.Templates.render("frontend/sidebar/sidebar-area-view",a.toJSON())).appendTo(this.$el);this.AreaViews[a.get("id")]=new KB.Backbone.Sidebar.AreaOverview.AreaListItem({$el:b,controller:this,sidebarController:this.sidebarController,model:a})}},setActiveList:function(a){return this.activeList&&this.activeList.cid?this.activeList.cid===a.cid?!1:(this.activeList.$el.slideUp(),this.activeList.deactivate(),this.activeList=null,this.setActiveList(a),void 0):(this.activeList=a,a.$el.slideDown(),a.activate(),!0)}}),KB.Backbone.Sidebar.AreaOverview.ModuleListItem=Backbone.View.extend({tagName:"li",initialize:function(a){this.$parent=a.$parent,this.parentView=this.model.view,this.bindHandlers(),this.render()},events:{mouseenter:"over",mouseleave:"out",click:"scrollTo","click .kb-sidebar-item__edit":"openControls","click .kb-js-inline-update":"inlineUpdate","click .kb-js-inline-delete":"inlineDelete"},bindHandlers:function(){this.listenTo(this.parentView.model,"change",this.getDirty),this.listenTo(this.parentView.model,"saved",this.getClean)},getDirty:function(){this.$el.addClass("kb-module-dirty")},getClean:function(){this.$el.removeClass("kb-module-dirty")},over:function(){this.parentView.$el.addClass("kb-in-sidebar-active")},out:function(){this.parentView.$el.removeClass("kb-in-sidebar-active")},openControls:function(a){a.stopPropagation(),this.parentView.openOptions()},inlineUpdate:function(a){a.stopPropagation(),this.parentView.Controls.UpdateControl.update(),this.parentView.getClean()},inlineDelete:function(a){a.stopPropagation(),this.parentView.Controls.DeleteControl.confirmRemoval()},scrollTo:function(){var a=this;jQuery("html, body").animate({scrollTop:a.parentView.$el.offset().top-100},750)},render:function(){this.$el.append(KB.Templates.render("frontend/sidebar/module-view-item",{view:this.model.toJSON()})),this.$el.appendTo(this.$parent)},dispose:function(){this.stopListening(),this.remove(),delete this.model,delete this.parentView}}),KB.Backbone.Sidebar.Header=Backbone.View.extend({tagName:"div",className:"kb-sidebar__header",initialize:function(){this.$el.append(KB.Templates.render("frontend/sidebar/sidebar-header",{}))},render:function(){return this.$el}}),KB.Backbone.Frontend.FieldConfigsCollection=Backbone.Collection.extend({model:KB.Backbone.Frontend.FieldConfigModel}),KB.Backbone.Frontend.ModuleViewsCollection=Backbone.Collection.extend({initialize:function(){this.listenTo(this,"add",this.added)},added:function(a){return console.log("added"),a}}),KB.Backbone.ModuleBrowser.prototype.success=function(a){var b;this.dropZone?(this.dropZone.$el.after(a.data.html),this.dropZone.removeDropZone()):this.options.area.$el.append(a.data.html).removeClass("kb-area__empty"),console.log(a.data.module),b=KB.Modules.add(new KB.Backbone.ModuleModel(a.data.module)),_K.info("new module created",{view:b.view}),this.parseAdditionalJSON(a.data.json),KB.TinyMCE.addEditor(b.view.$el),KB.Fields.trigger("newModule",KB.Views.Modules.lastViewAdded),this.options.area.trigger("kb.module.created"),setTimeout(function(){b.view.openOptions()},300)},function(a){KB.Backbone.ModuleBrowser.prototype.close=function(){delete this.dropZone,a.call(this)}}(KB.Backbone.ModuleBrowser.prototype.close),KB.Backbone.Inline.EditableImage=Backbone.View.extend({initialize:function(){this.$el.removeAttr("data-kbfuid"),this.$el.addClass("kb-inline-imageedit-attached"),this.$caption=jQuery("*[data-"+this.model.get("uid")+"-caption]"),console.log(this),this.$el.css("min-height","200px"),this.mode=this.model.get("mode"),this.defaultState=this.model.get("state")||"replace-image"},events:{click:"openFrame"},openFrame:function(){var a=this;if(this.frame)return this.frame.open();var b={post__in:[this.model.get("id")]};wp.media.query(b).more().done(function(){var b=a.attachment=this.first();a.attachment.set("attachment_id",b.get("id")),a.frame=wp.media({frame:"image",state:a.defaultState,metadata:b.toJSON(),imageEditView:a}).on("update",function(b){a.update(b)}).on("ready",function(){a.ready()}).on("replace",function(){a.replace(a.frame.image.attachment)}).on("select",function(){alert("select")}).open()})},ready:function(){jQuery(".media-modal").addClass("smaller no-sidebar")},replace:function(a){this.attachment=a,this.handleAttachment(a)},update:function(a){this.attachment.set(a),this.attachment.sync("update",this.attachment),this.$caption.length>0&&this.$caption.html(this.attachment.get("caption"))},handleAttachment:function(a){var b=this,c=a.get("id"),d=this.prepareValue(a),e=_.clone(this.model.get("ModuleModel").get("moduleData")),f=this.model.get("kpath");KB.Util.setIndex(e,f,d),this.model.get("ModuleModel").set("moduleData",e),this.model.get("ModuleModel").trigger("kb.frontend.module.inlineUpdate");var g={width:b.model.get("width"),height:b.model.get("height"),crop:b.model.get("crop"),upscale:b.model.get("upscale")};jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:g,id:c,_ajax_nonce:KB.Config.getNonce("read")},type:"GET",dataType:"json",success:function(a){"simple"===b.mode?b.$el.attr("src",a):"background"===b.mode&&b.$el.css("backgroundImage","url('"+a+"')"),b.delegateEvents()},error:function(){}})},prepareValue:function(a){return{id:a.get("id"),title:a.get("title"),caption:a.get("caption")}}}),KB.Backbone.Inline.EditableText=Backbone.View.extend({initialize:function(){this.id=this.el.id,this.$el.removeAttr("data-kbfuid"),this.placeHolderSet=!1,this.placeholder="<span class='kb-editable-text-placeholder'>Start typing here</span>",this.setupDefaults(),this.maybeSetPlaceholder(),this.listenToOnce(this.model.get("ModuleModel"),"remove",this.deactivate)},events:{click:"activate"},setupDefaults:function(){var a=this,b={theme:"modern",skin:!1,menubar:!1,add_unload_trigger:!1,fixed_toolbar_container:"#kb-toolbar",schema:"html5",inline:!0,plugins:"textcolor, wplink",statusbar:!1,preview_styles:!1,setup:function(b){b.on("init",function(){a.editor=b,b.module=a.model.get("ModuleModel"),b.kfilter=a.model.get("filter")&&"content"===a.model.get("filter")?!0:!1,b.kpath=a.model.get("kpath"),b.module.view.$el.addClass("inline-editor-attached"),KB.Events.trigger("KB::tinymce.new-inline-editor",b),b.fire("focus"),b.focus()}),b.on("click",function(a){a.stopPropagation()}),b.on("focus",function(){a.placeHolderSet&&(a.$el.html(""),a.placeHolderSet=!1);var c=KB.Util.getIndex(b.module.get("moduleData"),b.kpath);b.previousContent=b.getContent(),b.kfilter&&b.setContent(switchEditors.wpautop(c)),jQuery("#kb-toolbar").show(),b.module.view.$el.addClass("inline-edit-active"),b.placeholder!==!1&&b.setContent("")}),b.on("change",function(){_K.info("Got Dirty")}),b.addButton("kbcancleinline",{title:"Stop inline Edit",onClick:function(){tinymce.activeEditor.isDirty()&&tinymce.activeEditor.module.view.getDirty(),tinymce.activeEditor.fire("blur"),tinymce.activeEditor=null,tinymce.focusedEditor=null,document.activeElement.blur(),jQuery("#kb-toolbar").hide()}}),b.on("blur",function(){var c,d,e;b.module.view.$el.removeClass("inline-edit-active"),jQuery("#kb-toolbar").hide(),c=b.getContent(),b.kfilter&&(c=switchEditors._wp_Nop(b.getContent())),d=_.clone(b.module.get("moduleData")),e=b.kpath,KB.Util.setIndex(d,e,c),b.isDirty()?(b.placeholder=!1,b.kfilter?jQuery.ajax({url:ajaxurl,data:{action:"applyContentFilter",content:c,postId:b.module.toJSON().post_id,_ajax_nonce:KB.Config.getNonce("read")},type:"POST",dataType:"json",success:function(a){b.setContent(a.data.content),b.module.set("moduleData",d),b.module.trigger("kb.frontend.module.inlineUpdate")},error:function(){}}):(b.module.set("moduleData",d),b.module.trigger("kb.frontend.module.inlineUpdate"))):b.setContent(b.previousContent),a.maybeSetPlaceholder()})}};this.defaults=_.extend(b,this.settings)},activate:function(a){a.stopPropagation(),this.editor||tinymce.init(_.defaults(this.defaults,{selector:"#"+this.id}))},deactivate:function(){alert("deactivated"),tinyMCE.execCommand("mceRemoveEditor",!1,this.id),this.editor=null},maybeSetPlaceholder:function(){var a=this.editor?this.editor.getContent():this.$el.html(),b=this.cleanString(a);_.isEmpty(b)&&(this.$el.html(this.placeholder),this.placeHolderSet=!0)},cleanString:function(a){return a.replace(/\s/g,"").replace(/&nbsp;/g,"").replace(/<br>/g,"").replace(/<p><\/p>/g,"")}}),KB.IEdit.Link=function(a){var b,c,d,e,f,g;return{selector:".editable-link",oWpLink:null,$anchor:null,init:function(){var b=this;e=a("body"),e.on("click",this.selector,function(c){c.stopPropagation(),c.ctrlKey&&(c.preventDefault(),c.stopPropagation(),b.$anchor=a(this),b.open())}),e.on("click","#wp-link-close",function(){b.close()})},open:function(){var b=this;return window.wpLink?(this.restore_htmlUpdate=wpLink.htmlUpdate,this.restore_isMce=wpLink.isMCE,this.restore_close=wpLink.close,wpLink.isMCE=function(){return!1},wpLink.open(),this.addLinktextField(),this.customizeDialog(),this.setValues(),void(wpLink.htmlUpdate=function(){var c,e=wpLink.textarea;e&&(c=wpLink.getAttrs(),d&&(c.linktext=a("input",d).val()),c.href&&"http://"!=c.href&&(b.$anchor.attr("href",c.href),b.$anchor.html(c.linktext),b.$anchor.attr("target",c.target),b.updateModel(c),b.close(),wpLink.close()))})):!1},addLinktextField:function(){b=a("form#wp-link"),c=a(".link-target",b),d=a('<div><label><span>LinkText</span><input type="text" value="hello" name="linktext" ></label></div>').insertBefore(c)},customizeDialog:function(){a("#wp-link-wrap").addClass("kb-customized")},setValues:function(){f=a("#url-field",b),g=a("#link-title-field",b);var c=this.$anchor.data(),e=c.module,h=KB.Modules.get(e).get("moduleData"),i={};i=KB.Util.getIndex(h,c.kpath),f.val(i.link),g.val(i.title),d.find("input").val(i.linktext),"_blank"===i.target&&a("#link-target-checkbox").prop("checked",!0)},close:function(){wpLink.isMCE=this.restore_isMce,wpLink.htmlUpdate=this.restore_htmlUpdate,wpLink.close=this.restore_close,d.remove()},updateModel:function(a){var b=this.$anchor.data(),c=b.module,d=KB.Modules.get(c),e={link:a.href,title:a.title,target:a.target,linktext:a.linktext},f=_.clone(d.get("moduleData")),g=b.kpath;KB.Util.setIndex(f,g,e),d.set("moduleData",f),d.trigger("kb.frontend.module.inlineUpdate")}}}(jQuery),KB.Events.on("KB::ready",function(){KB.IEdit.Link.init()}),KB.currentModule={},KB.currentArea={},KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function a(){var a=jQuery('<div id="kb-toolbar"></div>').appendTo("body");a.hide(),KB.appData.config.useModuleNav&&(KB.Sidebar=new KB.Backbone.SidebarView),KB.EditModalModules=new KB.Backbone.EditModalModules({}),KB.Modules.on("add",d),KB.Areas.on("add",e),KB.Modules.on("remove",f),c(),KB.FieldConfigs=new KB.Backbone.Frontend.FieldConfigsCollection(_.toArray(KB.payload.Fields)),KB.Ui.init()}function b(){_.each(KB.Modules.toArray(),function(a){KB.Modules.remove(a)}),jQuery(".editable").each(function(a,b){tinymce.remove("#"+b.id)}),jQuery("body").off("click",".editable-image"),jQuery("body").off("click",".editable-link")}function c(){return KB.appData.config.preview?!1:(_.each(KB.payload.Areas,function(a){KB.Areas.add(a)}),_.each(KB.payload.Modules,function(a){KB.Modules.add(a)}),KB.trigger("kb:moduleControlsAdded"),void KB.Events.trigger("KB.frontend.init"))}function d(a){var b,c;c=KB.Areas.get(a.get("area"))||null,null!==c&&(a.setArea(c),a.bind("change:area",a.areaChanged)),b=KB.Views.Modules.add(a.get("instance_id"),new KB.Backbone.ModuleView({model:a,el:"#"+a.get("instance_id"),Area:c})),b.$el.data("ModuleView",b),KB.Ui.initTabs()}function e(a){KB.Views.Areas.add(a.get("id"),new KB.Backbone.AreaView({model:a,el:"#"+a.get("id")}))}function f(a){a.dispose(),KB.Views.Modules.remove(a.get("instance_id"))}return{init:a,shutdown:b}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&KB.appData.config.frontend&&(KB.Views.Modules.readyOnFront(),_K.info("Frontend Modules Ready Event fired"),_KS.info("Frontend welcomes you")),KB.Events.trigger("KB::ready"),setUserSetting("editor","tinymce"),jQuery("body").on("click",".cbutton",function(a){jQuery(this).addClass("cbutton--click"),jQuery(a.currentTarget).one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){a.currentTarget.classList.remove("cbutton--click")})})});