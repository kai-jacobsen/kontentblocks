/*! kontentblocks 2013-11-08 */
function pasteHtmlAtCaret(html){var sel,range;if(window.getSelection){if(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0),range.deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);range.insertNode(frag),lastNode&&(range=range.cloneRange(),range.setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range))}}else document.selection&&"Control"!==document.selection.type&&document.selection.createRange().pasteHTML(html)}!function($){"use strict";var models={},views={},collections={},etch={};etch.VERSION="0.6.2",etch.config={selector:".editable",buttonClasses:{"default":["bold","italic","underline","unordered-list","ordered-list","link","clear-formatting","save"],all:["bold","italic","underline","unordered-list","ordered-list","link","clear-formatting","save"],title:["bold","italic","underline","save"]}},models.Editor=Backbone.Model,views.Editor=Backbone.View.extend({initialize:function(){this.$el=$(this.el),_.bindAll(this,"changeButtons","changePosition","changeEditable","insertImage"),this.model.bind("change:buttons",this.changeButtons),this.model.bind("change:position",this.changePosition),this.model.bind("change:editable",this.changeEditable),this.changeEditable()},events:{"click .etch-bold":"toggleBold","click .etch-italic":"toggleItalic","click .etch-underline":"toggleUnderline","click .etch-heading":"toggleHeading","click .etch-unordered-list":"toggleUnorderedList","click .etch-justify-left":"justifyLeft","click .etch-justify-center":"justifyCenter","click .etch-justify-right":"justifyRight","click .etch-ordered-list":"toggleOrderedList","click .etch-link":"toggleLink","click .etch-image":"getImage","click .etch-save":"save","click .etch-clear-formatting":"clearFormatting"},changeEditable:function(){this.setButtonClass()},setButtonClass:function(){var editorModel=this.model,buttonClass=editorModel.get("editable").attr("data-button-class")||"default";editorModel.set({buttons:etch.config.buttonClasses[buttonClass]})},changeButtons:function(){this.$el.empty();var view=this,buttons=this.model.get("buttons");return buttons.length?(_.each(this.model.get("buttons"),function(button){var $buttonEl=$('<a href="#" class="etch-editor-button etch-'+button+'" title="'+button.replace("-"," ")+'"><span></span></a>');view.$el.append($buttonEl)}),$(this.el).show("fast"),void 0):($(this.el).hide(),void 0)},changePosition:function(){var pos=this.model.get("position");this.$el.animate({top:pos.y,left:pos.x},{queue:!1})},wrapSelection:function(selectionOrRange,elString){var range=selectionOrRange===Range?selectionOrRange:selectionOrRange.getRangeAt(0),el=document.createElement(elString);range.surroundContents(el)},clearFormatting:function(e){e.preventDefault(),document.execCommand("removeFormat",!1,null)},toggleBold:function(e){e.preventDefault(),document.execCommand("bold",!1,null)},toggleItalic:function(e){e.preventDefault(),document.execCommand("italic",!1,null)},toggleUnderline:function(e){e.preventDefault(),document.execCommand("underline",!1,null)},toggleHeading:function(e){e.preventDefault();var range=window.getSelection().getRangeAt(0),wrapper=range.commonAncestorContainer.parentElement;if($(wrapper).is("h3"))return $(wrapper).replaceWith(wrapper.textContent),void 0;var h3=document.createElement("h3");range.surroundContents(h3)},urlPrompt:function(callback){var url=prompt("Enter a url","http://");/^((http|https)...)/.test(url)?callback(url):callback("http://"+url)},toggleLink:function(e){e.preventDefault();var range=window.getSelection().getRangeAt(0);"A"===range.startContainer.parentNode.tagName||"A"===range.endContainer.parentNode.tagName?document.execCommand("unlink",!1,null):this.urlPrompt(function(url){document.execCommand("createLink",!1,url)})},toggleUnorderedList:function(e){e.preventDefault(),document.execCommand("insertUnorderedList",!1,null)},toggleOrderedList:function(e){e.preventDefault(),document.execCommand("insertOrderedList",!1,null)},justifyLeft:function(e){e.preventDefault(),document.execCommand("justifyLeft",!1,null)},justifyCenter:function(e){e.preventDefault(),document.execCommand("justifyCenter",!1,null)},justifyRight:function(e){e.preventDefault(),document.execCommand("justifyRight",!1,null)},getImage:function(e){e.preventDefault(),this.startUploader(this.insertImage)},startUploader:function(cb){var model=new models.ImageUploader,view=new views.ImageUploader({model:model});model._imageCallback=function(image){view.startCropper(image,cb)},this._savedRange=window.getSelection().getRangeAt(0),$("body").append(view.render().el)},insertImage:function(image){var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(this._savedRange);var attrs={editable:this.model.get("editable"),editableModel:this.model.get("editableModel")};_.extend(attrs,image);var model=new models.EditableImage(attrs),view=new views.EditableImage({model:model});this._savedRange.insertNode($(view.render().el).addClass("etch-float-left")[0])},save:function(e){console.log(this),e.preventDefault();var editableModel=this.model.get("editableModel");editableModel.trigger("save",this.model)}}),_.extend(etch,{models:models,views:views,collections:collections,editableInit:function(e){e.stopPropagation();var self=this,target=e.target||e.srcElement,$editable=$(target).etchFindEditable();$editable.on("keydown",function(){}),$editable.attr("contenteditable",!0);var $editor=$(".etch-editor-panel"),editorModel=$editor.data("model");if($editor.size())$editable[0]!==editorModel.get("editable")[0]&&editorModel.set({editable:$editable,editableModel:this.model});else{$editor=$('<div class="etch-editor-panel">');var editorAttrs={editable:$editable,editableModel:this.model};document.body.appendChild($editor[0]),$editor.etchInstantiate({classType:"Editor",attrs:editorAttrs}),editorModel=$editor.data("model")}try{document.execCommand("StyleWithCSS",!1,!1)}catch(err){if("Invalid argument."!==err.message)throw err}if(models.EditableImage){var $imgs=$editable.find("img");if($imgs.size()){var attrs={editable:$editable,editableModel:this.model};$imgs.each(function(){var $this=$(this);if(!$this.data("editableImageModel")){var editableImageModel=new models.EditableImage(attrs);new views.EditableImage({model:editableImageModel,el:this,tagName:this.tagName}),$this.data("editableImageModel",editableImageModel)}})}}self.model&&self.model.trigger("etch:init"),$("body").bind("mousedown.editor",function(e){var target=e.target||e.srcElement;$(target).not(".etch-editor-panel, .etch-editor-panel *, .etch-image-tools, .etch-image-tools *").size()&&(self.model&&self.model.trigger("etch:remove"),$editor.remove(),models.EditableImage&&($editable.find("img").unbind("mouseenter"),$(etch.config.selector+" img").data("editableImageModel",!1)),$(this).unbind("mousedown.editor"))}),editorModel.set({position:{x:e.pageX-15,y:e.pageY-80}})}}),$.fn.etchInstantiate=function(options,cb){return this.each(function(){var $el=$(this);options||(options={});var settings={el:this,attrs:{}};_.extend(settings,options);var model=new models[settings.classType](settings.attrs,settings);if(_.isFunction(views[settings.classType]))var view=new views[settings.classType]({model:model,el:this,tagName:this.tagName});$el.data({model:model}),$el.data({view:view}),_.isFunction(cb)&&cb({model:model,view:view})})},$.fn.etchFindEditable=function(){var $el=$(this);return $el.is(etch.config.selector)?$el:$el.closest(etch.config.selector)},window.etch=etch}(jQuery);var KB=KB||{};KB.ModulesCollection=Backbone.Collection.extend({});var KB=KB||{};KB.Templates=function($){function render(tmpl_name,tmpl_data){if(!tmpl_cache[tmpl_name]){var tmpl_string,tmpl_dir=kontentblocks.config.url+"js/templates",tmpl_url=tmpl_dir+"/"+tmpl_name+".html";$.ajax({url:tmpl_url,method:"GET",async:!1,success:function(data){tmpl_string=data}}),tmpl_cache[tmpl_name]=_.template(tmpl_string)}return tmpl_cache[tmpl_name](tmpl_data)}var tmpl_cache={};return{render:render}}(jQuery);var KB=KB||{};KB.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",save:function(model){var module=model.get("editableModel"),el=model.get("editable"),dataset=jQuery(el).data();dataset.data=jQuery(el).html(),dataset.postId=module.get("post_id"),jQuery.ajax({url:KBAppConfig.ajaxurl,data:{action:"saveInlineEdit",data:dataset},type:"POST",dataType:"json",success:function(){console.log("sent")},error:function(){console.log("not sent")},complete:function(){console.log("no matter what")}})}});var KB=KB||{};KB.ModuleView=Backbone.View.extend({initialize:function(){this.model.bind("save",this.model.save),this.render()},save:function(){},events:{"click a.os-edit-block":"openVex","click .editable":"initEtch","click .slider-controls":"openSlider"},render:function(){this.$el.append(KB.Templates.render("module-controls",{model:this.model.toJSON()}))},initEtch:etch.editableInit,openVex:function(){target=this.model.get("editURL"),height=jQuery(window).height(),jQuery("#osframe").attr("src",target).attr("height",height-200),KB.openedModal=vex.open({content:jQuery("#onsite-modal").html(),contentClassName:"onsite",afterOpen:function(){jQuery(".nano").nanoScroller()}})},openSlider:function(){KB.OpenSlider&&KB.OpenSlider.destroy(),KB.OpenSlider=new KB.SliderView({tagName:"div",id:"slider-unique",className:"slider-controls-wrapper",model:this.model,parent:this})}});var KB=KB||{};KB.OSConfig=KB.OSConfig||{},KB.SliderView=Backbone.View.extend({initialize:function(){this.targetEl=this.options.parent.$el,this.render()},events:{"click a.close-controls":"destroy"},render:function(){var that=this;this.targetEl.addClass("edit-active"),this.$el.append(KB.Templates.render("slider",{model:this.model.toJSON()}));var container=jQuery(".os-controls-container",this.$el);container.css("position","absolute").draggable({handle:"h2",containment:"window",stop:function(eve,ui){KB.OSConfig.Position=ui.position}}),KB.OSConfig.Position&&container.css({top:KB.OSConfig.Position.top,left:KB.OSConfig.Position.left}),jQuery("body").append(this.$el),this.$el.tabs();var mt=that.targetEl.css("marginTop");jQuery("#KBMarginTop").ionRangeSlider({from:parseInt(mt,10),postfix:"px",onChange:function(obj){that.targetEl.css("marginTop",obj.fromNumber)}});var mb=that.targetEl.css("marginBottom");jQuery("#KBMarginBottom").ionRangeSlider({from:parseInt(mb,10),postfix:"px",onChange:function(obj){that.targetEl.css("marginBottom",obj.fromNumber)}})},destroy:function(){this.targetEl.removeClass("edit-active"),this.remove()}});var KBApp=KBApp||{},KBApp=function($){var app={},Views=[],Collection=new KB.ModulesCollection(Konfig,{model:KB.ModuleModel});return _.each(Collection.models,function(model){Views.push(new KB.ModuleView({el:"#"+model.get("instance_id"),model:model}))}),$("body").append(KB.Templates.render("fe_iframe",{})),app.Collection=Collection,app.Views=Views,app}(jQuery);