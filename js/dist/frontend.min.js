/*! Kontentblocks ProdVersion 2014-11-24 03:11 */
KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var that=this;KB.Ajax.send({action:"removeModules",instance_id:that.get("instance_id")},that.destroyed)},destroyed:function(){},setArea:function(){},areaChanged:function(){this.view.updateModuleForm()}}),KB.Backbone.AreaLayoutView=Backbone.View.extend({hasLayout:!1,initialize:function(options){this.AreaView=options.AreaView,this.listenTo(this.AreaView,"kb.module.created",this.handleModuleCreated),this.listenTo(this.AreaView,"kb.module.deleted",this.handleModuleDeleted),this.listenTo(this.model,"change:layout",this.handleLayoutChange),this.setupLayout(),this.renderPlaceholder()},setupLayout:function(layout){var at,collection;return collection=KB.payload.AreaTemplates||{},at=layout||this.model.get("layout"),"default"===at?(this.hasLayout=!1,null):(collection[at]?(this.hasLayout=!0,this.LayoutIterator=new KB.LayoutIterator(collection[at],this.AreaView)):this.hasLayout=!1,void 0)},unwrap:function(){_.each(this.AreaView.getAttachedModules(),function(ModuleView){ModuleView.$el.unwrap()});var $outer=jQuery(".kb-outer-wrap",this.AreaView.$el);$outer.each(function(item){jQuery(".kb-wrap:first-child",item).unwrap()})},render:function(ui){this.hasLayout?this.LayoutIterator.applyLayout(ui):this.unwrap()},applyClasses:function(){var $parent,prev,$modules=this.AreaView.$el.find(".module");$modules.removeClass("first-module last-module repeater");for(var i=0;i<$modules.length;i++){var View=jQuery($modules[i]).data("ModuleView");_.isUndefined(View)||(0===i&&View.$el.addClass("first-module"),i===$modules.length-1&&View.$el.addClass("last-module"),prev&&View.model.get("settings").id===prev&&View.$el.addClass("repeater"),prev=View.model.get("settings").id,$parent=View.$el.parent(),$parent.hasClass("kb-wrap")&&$parent.attr("rel",View.$el.attr("rel")))}},handleModuleCreated:function(){this.applyClasses(),this.LayoutIterator&&this.LayoutIterator.applyLayout()},handleModuleDeleted:function(){this.applyClasses(),this.renderPlaceholder(),this.LayoutIterator&&this.LayoutIterator.applyLayout()},handleLayoutChange:function(){this.setupLayout(),this.AreaView.setupSortables(),this.render(null)},renderPlaceholder:function(){0===this.AreaView.getNumberOfModules()&&this.AreaView.$el.addClass("kb-area__empty")}}),KB.LayoutIterator=function(layout,AreaView){this.AreaView=AreaView,this.raw=layout,this.position=0,this.current=null,this.maxNum=layout.layout.length,this.id=layout.id,this.label=layout.label,this.lastItem=layout["last-item"],this.cycle=layout.cycle||!1,this.layout=layout.layout,this.wrap=layout.wrap||!1,this.setPosition=function(pos){return this.position=pos%this.maxNum,this.setCurrent(),this.position},this.getPosition=function(){return this.position},this.getLayout=function(pos){return pos&&this.cycle?this.layout[pos%this.maxNum]:pos&&!this.cycle?pos>this.maxNum-1?this.layout[this.maxNum-1]:this.layout[pos]:void 0},this.next=function(){this.position===this.maxNum-1&&this.cycle?this.position=0:this.position!==this.maxNum-1||this.cycle?this.position++:this.position=this.maxNum-1,this.setCurrent()},this.setCurrent=function(){this.current=this.layout[this.position]},this.getCurrent=function(){return this.current},this.hasWrap=function(){return this.wrap!==!1},this.applyLayout=function(ui){var Iterator=this,modules=this.AreaView.$el.find('.module:not(".ignore")'),wraps=[],$outer=jQuery(".kb-outer-wrap");if(Iterator.setPosition(0),$outer.each(function(item){jQuery(".kb-wrap:first-child",item).unwrap()}),_.each(modules,function(ModuleEl){var $el=jQuery(ModuleEl),$wrap=$el.parent(".kb-wrap");0===$wrap.length?($wrapEl=jQuery('<div class="kb-wrap '+Iterator.getCurrent().classes+'"></div>'),$el.wrap($wrapEl)):($wrap.removeClass(),$wrap.addClass("kb-wrap "+Iterator.getCurrent().classes)),console.log(Iterator.getCurrent().classes),ui&&ui.placeholder.addClass("kb-front-sortable-placeholder"),Iterator.next()}),this.hasWrap()){wraps=jQuery('.kb-wrap:not(".ignore")');for(var i=0;i<wraps.length;i+=this.maxNum)wraps.slice(i,i+this.maxNum).wrapAll("<div class='kb-outer-wrap "+this.wrap.class+"'></div>")}},this.setCurrent()},KB.Backbone.AreaView=Backbone.View.extend({isSorting:!1,events:{dblclick:"openModuleBrowser"},initialize:function(){this.attachedModuleViews={},this.settings=this.model.get("settings"),this.listenToOnce(KB.Events,"KB::frontend-init",this.setupUi),this.listenTo(this,"kb.module.deleted",this.removeModule),KB.appData.config.useModuleNav&&KB.Menubar.attachAreaView(this)},setupUi:function(){this.Layout=new KB.Backbone.AreaLayoutView({model:new Backbone.Model(this.settings),AreaView:this}),this.model.get("sortable")?(this.setupSortables(),_K.info("Area sortable initialized")):_K.info("Area sortable skipped")},openModuleBrowser:function(){return this.ModuleBrowser||(this.ModuleBrowser=new KB.Backbone.ModuleBrowser({area:this})),this.ModuleBrowser.render(),this.ModuleBrowser},addModuleView:function(moduleView){this.attachedModuleViews[moduleView.model.get("instance_id")]=moduleView,this.listenTo(moduleView.model,"change:area",this.removeModule),_K.info("Module:"+moduleView.model.id+" was added to area:"+this.model.id)},getNumberOfModules:function(){return _.size(this.attachedModuleViews)},getAttachedModules:function(){return this.attachedModuleViews},setupSortables:function(){var that=this;this.Layout.hasLayout?this.$el.sortable({handle:".kb-module-inline-move",items:".kb-wrap",helper:"original",opacity:.5,delay:150,placeholder:"kb-front-sortable-placeholder",start:function(e,ui){that.isSorting=!0,ui.placeholder.attr("class",ui.helper.attr("class")),ui.placeholder.addClass("kb-front-sortable-placeholder"),ui.placeholder.append("<div class='module kb-dummy'></div>"),jQuery(".module",ui.helper).addClass("ignore"),ui.helper.addClass("ignore")},beforeStop:function(e,ui){var serializedData={};return that.isSorting=!1,serializedData[that.model.get("id")]=that.$el.sortable("serialize",{attribute:"rel"}),jQuery(".ignore",ui.helper).removeClass("ignore"),KB.Ajax.send({action:"resortModules",data:serializedData,_ajax_nonce:KB.Config.getNonce("update")},function(){KB.Notice.notice("Order was updated successfully","success"),that.Layout.render(ui)},that)},change:function(e,ui){that.Layout.applyClasses(),that.Layout.render(ui)}}):this.$el.sortable({handle:".kb-module-inline-move",items:".module",helper:"original",opacity:.5,delay:150,placeholder:"kb-front-sortable-placeholder",start:function(){that.isSorting=!0},beforeStop:function(){var serializedData={};return that.isSorting=!1,serializedData[that.model.get("id")]=that.$el.sortable("serialize",{attribute:"rel"}),KB.Ajax.send({action:"resortModules",data:serializedData,_ajax_nonce:KB.Config.getNonce("update")},function(){KB.Notice.notice("Order was updated successfully","success")},that)},change:function(){that.Layout.applyClasses()}})},changeLayout:function(l){this.Layout.model.set("layout",l)},removeModule:function(ModuleView){var id=ModuleView.model.get("mid");this.attachedModuleViews[id]&&delete this.attachedModuleViews[id]}}),KB.Backbone.EditModalAreas=Backbone.View.extend({tagName:"div",id:"kb-area-modal",$target:null,$layoutList:null,AreaView:null,LayoutDefs:KB.payload.AreaTemplates||{},events:{"click li":"layoutSelect","click .close-controls":"close"},initialize:function(options){var that=this;this.setTarget(options.target),this.AreaView=options.AreaView,jQuery(KB.Templates.render("frontend/area-edit-form",{model:this.model.toJSON(),i18n:KB.i18n.jsFrontend})).appendTo(this.$el),jQuery("body").append(this.$el),jQuery(window).on("resize",function(){that.reposition()}),this.$layoutList=jQuery("ul",this.$el),this.render()},render:function(){this.$el.show(),this.setOptions(),this.reposition()},layoutSelect:function(e){var $li=jQuery(e.currentTarget);this.$el.find(".kb-active-area-layout").removeClass(),$li.addClass("kb-active-area-layout"),this.AreaView.changeLayout($li.data("item"))},setModel:function(model){return this.model=model,this},setArea:function(AreaView){return this.AreaView=AreaView,this},setTarget:function(target){this.$target=jQuery(target)},close:function(){this.$el.hide()},setOptions:function(){var options="",layouts=this.model.get("layouts");this.$layoutList.find("li").remove(),layouts&&layouts.length>0&&(_.each(this.prepareLayouts(layouts),function(item){options+=KB.Templates.render("frontend/area-layout-item",{item:item})}),this.$layoutList.append(options))},prepareLayouts:function(layouts){var that=this,stored=this.model.get("settings").layout;return _.map(layouts,function(l){if(that.LayoutDefs[l]){var def=that.LayoutDefs[l];return def.currentClass=def.id===stored?"kb-active-area-layout":"",def}})},reposition:function(){var pos=this.$target.offset();console.log(pos);var lh=this.$el.outerHeight();pos.top=pos.top-lh,this.$el.offset({top:pos.top-27,left:pos.left})}}),KB.Backbone.EditModalModules=Backbone.View.extend({tagName:"div",id:"onsite-modal",timerId:null,initialize:function(){var that=this;return jQuery(KB.Templates.render("frontend/module-edit-form",{model:{},i18n:KB.i18n.jsFrontend})).appendTo(this.$el),this.$form=jQuery("#onsite-form",this.$el),this.$formContent=jQuery("#onsite-content",this.$el),this.$inner=jQuery(".os-content-inner",this.$formContent),this.$title=jQuery(".controls-title",this.$el),this.LoadingAnimation=new KB.Backbone.Shared.LoadingAnimation({el:this.$form}),this.$el.css("position","fixed").draggable({handle:"h2",containment:"window",stop:function(eve,ui){KB.OSConfig.wrapPosition=ui.position,that.recalibrate(ui.position)}}),this.listenTo(KB.Events,"KB::edit-modal-refresh",this.recalibrate),jQuery(window).on("resize",function(){that.recalibrate()}),this.listenTo(KB.Events,"KB::tinymce.new-editor",function(ed){ed.settings&&ed.settings.kblive&&that.attachEditorEvents(ed)}),jQuery(document).on("change",".kb-observe",function(){that.serialize(!1,!0)}),this},events:{keyup:"delayInput","click a.close-controls":"destroy","click a.kb-save-form":"update","click a.kb-preview-form":"preview","change .kb-template-select":"viewfileChange"},openView:function(ModuleView,force){return force=_.isUndefined(force)?!1:!0,this.setupWindow(),this.ModuleView&&this.ModuleView.cid===ModuleView.cid?(_K.log("Module View already set"),this):(this.ModuleView=ModuleView,this.model=ModuleView.model,this.attach(),this.render(),this)},attach:function(){var that=this;this.listenTo(this.ModuleView,"kb.frontend.module.inline.saved",this.frontendViewUpdated),this.listenTo(this.model,"change:viewfile",function(){that.serialize(!1,!0),that.render()}),this.listenTo(this.model,"kb.frontend.module.inlineUpdate",function(){that.render(!0),that.$el.addClass("isDirty")}),this.listenTo(this.ModuleView,"kb.module.view.delete",this.destroy)},detach:function(){this.stopListening(this.ModuleView),this.stopListening(this.model),this.ModuleView.attachedFields={},delete this.ModuleView},destroy:function(){var that=this;that.detach(),jQuery(".wp-editor-area",this.$el).each(function(i,item){tinymce.remove("#"+item.id)}),that.unbind(),that.$el.detach()},setupWindow:function(){this.$el.appendTo("body").show(),KB.OSConfig.wrapPosition&&this.$el.css({top:KB.OSConfig.wrapPosition.top,left:KB.OSConfig.wrapPosition.left})},frontendViewUpdated:function(){this.$el.removeClass("isDirty"),this.render()},preview:function(){this.serialize(!1,!1)},update:function(){this.serialize(!0,!0)},render:function(overloadData){var json,that=this;_KS.info("Frontend modal retrieves data from the server"),overloadData=!_.isUndefined(overloadData),json=this.model.toJSON(),this.applyControlsSettings(this.$el),this.updateViewClassTo=!1,jQuery.ajax({url:ajaxurl,data:{action:"getModuleOptions",module:json,moduleData:json.moduleData,overloadData:overloadData,_ajax_nonce:KB.Config.getNonce("read")},type:"POST",dataType:"json",beforeSend:function(){that.LoadingAnimation.show()},success:function(res){that.$inner.empty(),that.ModuleView.clearFields(),that.$inner.attr("id",that.model.get("instance_id")),that.$inner.append(res.html),res.json&&(KB.payload=_.extend(KB.payload,res.json)),KB.Ui.initTabs(),KB.Ui.initToggleBoxes(),KB.TinyMCE.addEditor(that.$form),_K.info("Frontend Modal opened with view of:"+that.model.get("instance_id")),_KS.info("Frontend modal done."),that.$title.text(that.model.get("settings").name),setTimeout(function(){KB.Fields.trigger("frontUpdate",that.ModuleView)},500),setTimeout(function(){that.$el.show(),that.recalibrate(),that.LoadingAnimation.hide()},550)},error:function(){KB.Notice.notice("There went something wrong","error")}})},recalibrate:function(){var winH,conH,position,winDiff;winH=jQuery(window).height()-40,conH=jQuery(".os-content-inner").height(),position=this.$el.position(),winDiff=conH+position.top-winH,winDiff>0?this.initScrollbars(conH-(winDiff+30)):conH-position.top<winH?this.initScrollbars(conH):this.initScrollbars(winH-position.top),position.top<40&&this.$el.css("top","40px"),_K.info("Frontend Modal resizing done!")},initScrollbars:function(height){jQuery(".kb-nano",this.$el).height(height+20),jQuery(".kb-nano").nanoScroller({preventPageScrolling:!0,contentClass:"kb-nano-content"}),_K.info("Nano Scrollbars (re)initialized!")},serialize:function(mode,showNotice){var height,that=this,save=mode||!1,notice=showNotice!==!1;this.LoadingAnimation.show(.5),_K.info("Frontend Modal called serialize function. Savemode:",mode),tinymce.triggerSave(),jQuery.ajax({url:ajaxurl,data:{action:"updateModuleOptions",data:that.$form.serialize().replace(/\'/g,"%27"),module:that.model.toJSON(),editmode:save?"update":"preview",_ajax_nonce:KB.Config.getNonce("update")},type:"POST",dataType:"json",success:function(res){var $controls;$controls=jQuery(".kb-module-controls",that.ModuleView.$el),$controls.length>0&&$controls.detach(),jQuery(".editable",that.ModuleView.$el).each(function(i,el){tinymce.remove("#"+el.id)}),height=that.ModuleView.$el.height(),that.updateViewClassTo!==!1&&that.updateContainerClass(that.updateViewClassTo),that.ModuleView.$el.html(res.html),that.model.set("moduleData",res.newModuleData),jQuery(document).trigger("kb:module-update-"+that.model.get("settings").id,that.ModuleView),that.ModuleView.delegateEvents(),that.ModuleView.trigger("kb:frontend::viewUpdated"),KB.Events.trigger("KB::ajax-update"),KB.trigger("kb:frontendModalUpdated"),setTimeout(function(){jQuery(".editable",that.ModuleView.$el).each(function(i,el){KB.IEdit.Text(el)}),that.ModuleView.render(),that.ModuleView.setControlsPosition()},400),save?(notice&&KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticeDataSaved,"success"),that.$el.removeClass("isDirty"),that.ModuleView.getClean(),that.trigger("kb:frontend-save")):(notice&&KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticePreviewUpdated,"success"),that.$el.addClass("isDirty")),$controls.length>0&&that.ModuleView.$el.append($controls),that.ModuleView.trigger("kb.view.module.HTMLChanged"),_K.info("Frontend Modal saved data for:"+that.model.get("instance_id")),that.LoadingAnimation.hide()},error:function(){_K.error("serialize | FrontendModal | Ajax error")}})},viewfileChange:function(e){this.updateViewClassTo={current:this.ModuleView.model.get("viewfile"),target:e.currentTarget.value},this.model.set("viewfile",e.currentTarget.value)},updateContainerClass:function(viewfile){viewfile&&viewfile.current&&viewfile.target||_K.error("updateContainerClass | frontendModal | parameter exception"),this.ModuleView.$el.removeClass(this._classifyView(viewfile.current)),this.ModuleView.$el.addClass(this._classifyView(viewfile.target)),this.updateViewClassTo=!1},delayInput:function(){var that=this;this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(function(){that.timerId=null,that.serialize(!1,!1)},750)},attachEditorEvents:function(ed){var that=this;ed.onKeyUp.add(function(){that.delayInput()})},applyControlsSettings:function($el){var settings=this.model.get("settings");settings.controls&&settings.controls.width&&$el.css("width",settings.controls.width+"px"),settings.controls&&settings.controls.fullscreen?$el.width("100%").height("100%").addClass("fullscreen"):$el.height("").removeClass("fullscreen")},_classifyView:function(str){return"view-"+str.replace(".twig","")}}),KB.Backbone.Shared.LoadingAnimation=Backbone.View.extend({$overlay:jQuery('<div class="kb-loading-overlay" style="display: none;"><span class="kb-loading-loader"><span class="kb-loading-loader-inner"></span></span></div>'),initialize:function(){this.$el.css("position","relative").append(this.$overlay)},show:function(opacity){opacity?this.$overlay.fadeTo(150,opacity):this.$overlay.show()},hide:function(){this.$overlay.fadeOut(350)}}),KB.Backbone.ModuleMenuItem=Backbone.View.extend({initialize:function(){var that=this;this.parentView=this.model,this.el=KB.Templates.render("frontend/module-menu-item",{view:this.parentView.model.toJSON()}),this.$el=jQuery(this.el),this.parentView.controlView=this,jQuery(window).scroll(function(){that.parentView.$el.visible(!0,!0)?(that.$el.addClass("in-viewport"),that.$el.show(250)):(that.$el.removeClass("in-viewport"),that.$el.hide(250))}),this.parentView.$el.on("mouseenter",function(){that.$el.addClass("in-viewport-active")}),this.parentView.$el.on("mouseleave",function(){that.$el.removeClass("in-viewport-active")})},events:{mouseenter:"over",mouseleave:"out",click:"scrollTo","click .kb-menubar-item__edit":"openControls","click .kb-js-inline-update":"inlineUpdate"},render:function(){return this.$el},over:function(){this.parentView.$el.addClass("kb-menubar-active")},out:function(){this.parentView.$el.removeClass("kb-menubar-active")},openControls:function(e){e.stopPropagation(),this.parentView.openOptions()},inlineUpdate:function(e){e.stopPropagation(),this.parentView.updateModule(),this.parentView.getClean()},scrollTo:function(){var that=this;jQuery("html, body").animate({scrollTop:that.parentView.$el.offset().top-100},750)}}),KB.Backbone.AreaNavItem=Backbone.View.extend({events:{mouseenter:"over",mouseleave:"out","click .kb-menubar-item__edit":"openAreaSettings","click .kb-menubar-item__update":"updateAreaSettings"},initialize:function(){this.parentView=this.model,this.el=KB.Templates.render("frontend/area-menu-item",{view:this.parentView.model.toJSON()}),this.$el=jQuery(this.el),this.parentView.controlView=this},render:function(){return this.$el},over:function(){this.parentView.$el.addClass("kb-menubar-area-active")},out:function(){this.parentView.$el.removeClass("kb-menubar-area-active")},openAreaSettings:function(e){return KB.EditModalAreas?(KB.EditModalAreas.setArea(this.model).setModel(this.model.model),KB.EditModalAreas.render(),this):(KB.EditModalAreas=new KB.Backbone.EditModalAreas({model:this.model.model,target:e.currentTarget,AreaView:this.model}),void 0)},updateAreaSettings:function(){KB.Ajax.send({action:"saveAreaLayout",area:this.model.model.toJSON(),layout:this.model.Layout.model.get("layout"),_ajax_nonce:KB.Config.getNonce("update")},this.updateSuccess,this)},updateSuccess:function(res){200===res.status?KB.Notice.notice(res.response,"success"):KB.Notice.notice("That did not work","error")}}),KB.Backbone.MenubarView=Backbone.View.extend({subviews:[],tagName:"div",className:"kb-menubar-container",initialize:function(){this.$title=jQuery('<div class="kb-module-controls__title"> </div>').appendTo(this.$el),this.$helpbox=jQuery('<div class="kb-menubar-helpbox"></div>').appendTo(this.$el),this.show=_.isNull(KB.Util.stex.get("kb-nav-show"))?!0:KB.Util.stex.get("kb-nav-show"),this.$toggle=jQuery('<div class="kb-menubar-toggle genericon genericon-menu"></div>').appendTo(this.$el),this.$modulesTab=jQuery('<div data-list="modules" class="kb-menubar-tab kb-menubar-tab__modules kb-tab-active">Modules</div>').appendTo(this.$title),this.$areasTab=jQuery('<div data-list="areas" class="kb-menubar-tab kb-menubar-tab__areas">Areas</div>').appendTo(this.$title),this.StatusBar=new KB.Backbone.Frontend.StatusBar({el:this.$title}),this.render()},events:{"click .kb-menubar-toggle":"toggleView","mouseenter .kb-menubar-toggle":"over","mouseleave .kb-menubar-toggle":"out","click .kb-menubar-tab":"switchTabs"},render:function(){this.$el.appendTo("body"),this.$modulesList=jQuery('<ul class="kb-menubar__modules"></ul>').appendTo(this.$el),this.$areasList=jQuery('<ul class="kb-menubar__areas"></ul>').appendTo(this.$el),this.$areasList.hide(),this.show&&this.$el.addClass("kb-menubar-show")},attachModuleView:function(moduleView){moduleView.Menubar=this,this.renderModuleViewItem(moduleView)},renderModuleViewItem:function(moduleView){var Item=new KB.Backbone.ModuleMenuItem({model:moduleView});this.$modulesList.append(Item.render())},attachAreaView:function(areaView){areaView.Menubar=this,this.renderAreaViewItem(areaView)},renderAreaViewItem:function(areaView){var Item=new KB.Backbone.AreaNavItem({model:areaView});this.$areasList.append(Item.render())},toggleView:function(){this.$el.toggleClass("kb-menubar-show"),this.$el.removeClass("kb-menubar-show-partly");var show=!this.show;this.show=show,KB.Util.stex.set("kb-menubar-show",show,864e5)},over:function(){this.show||this.$el.addClass("kb-menubar-show-partly")},out:function(){this.show||this.$el.removeClass("kb-menubar-show-partly")},switchTabs:function(e){var $targetEl,targetList;$targetEl=jQuery(e.currentTarget),jQuery(".kb-tab-active").removeClass("kb-tab-active"),targetList=$targetEl.data("list"),$targetEl.addClass("kb-tab-active"),"areas"===targetList?(this.$modulesList.hide(),this.$areasList.show()):(this.$modulesList.show(),this.$areasList.hide()),jQuery(window).trigger("scroll")}}),KB.Backbone.Frontend.ModuleMenuItemView=Backbone.View.extend({tagName:"a",isValid:function(){return!0}}),KB.Backbone.Frontend.ModuleDelete=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(options){this.options=options||{},this.Parent=options.parent,this.$el.append('<span class="dashicons dashicons-trash"></span><span class="os-action">'+KB.i18n.jsFrontend.moduleControls.controlsDelete+"</span>")},className:"kb-module-inline-delete kb-nbt kb-nbb kb-js-inline-delete",events:{click:"confirmRemoval"},confirmRemoval:function(){KB.Notice.confirm(KB.i18n.EditScreen.notices.confirmDeleteMsg,this.removeModule,this.cancelRemoval,this)},removeModule:function(){KB.Ajax.send({action:"removeModules",_ajax_nonce:KB.Config.getNonce("delete"),module:this.model.get("instance_id")},this.afterRemoval,this)},afterRemoval:function(){this.Parent.trigger("kb.module.view.delete"),this.Parent.$el.remove(),KB.Modules.remove(this.model)},cancelRemoval:function(){return!1},isValid:function(){return KB.Checks.userCan("delete_kontentblocks")}}),KB.Backbone.Frontend.ModuleEdit=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(options){this.options=options||{},this.Parent=options.parent,this.$el.append('<span class="dashicons dashicons-edit"></span><span class="os-action">'+KB.i18n.jsFrontend.moduleControls.controlsEdit+"</span>")},className:"os-edit-block kb-module-edit",events:{click:"openForm"},openForm:function(){return KB.EditModalModules.openView(this.Parent),KB.focusedModule=this.model,this},isValid:function(){return KB.Checks.userCan("edit_kontentblocks")},success:function(){}}),KB.Backbone.Frontend.ModuleMove=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(options){this.options=options||{},this.Parent=options.parent,this.$el.append('<span class="dashicons dashicons-menu"></span><span class="os-action"></span>')},className:"kb-module-inline-move kb-nbt kb-nbb",isValid:function(){return KB.Checks.userCan("edit_kontentblocks")&&this.Parent.Area.model.get("sortable")}}),KB.Backbone.Frontend.ModuleUpdate=KB.Backbone.Frontend.ModuleMenuItemView.extend({initialize:function(options){this.options=options||{},this.Parent=options.parent,this.$el.append('<span class="dashicons dashicons-update"></span><span class="os-action">'+KB.i18n.jsFrontend.moduleControls.controlsUpdate+"</span>")},className:"kb-module-inline-update kb-nbt kb-nbb kb-js-inline-update",events:{click:"update"},update:function(){var that=this,moduleData={},refresh=!1;moduleData[that.model.get("instance_id")]=that.model.get("moduleData"),jQuery.ajax({url:ajaxurl,data:{action:"updateModuleOptions",data:jQuery.param(moduleData).replace(/\'/g,"%27"),module:that.model.toJSON(),editmode:"update",refresh:refresh,_ajax_nonce:KB.Config.getNonce("update")},type:"POST",dataType:"json",success:function(res){refresh&&that.$el.html(res.html),tinymce.triggerSave(),that.model.set("moduleData",res.newModuleData),that.Parent.render(),that.Parent.trigger("kb.frontend.module.inline.saved"),KB.Events.trigger("KB::ajax-update"),KB.Notice.notice("Module saved successfully","success"),that.Parent.$el.removeClass("isDirty")},error:function(){KB.Notice.notice("There went something wrong","error")}})},isValid:function(){return KB.Checks.userCan("edit_kontentblocks")}}),KB.Backbone.Frontend.ModuleControlsView=Backbone.View.extend({ModuleView:null,$menuList:null,initialize:function(options){this.ModuleView=options.ModuleView,this.renderControls(),this.EditControl=this.addItem(new KB.Backbone.Frontend.ModuleEdit({model:this.ModuleView.model,parent:this.ModuleView})),this.UpdateControl=this.addItem(new KB.Backbone.Frontend.ModuleUpdate({model:this.ModuleView.model,parent:this.ModuleView})),this.DeleteControl=this.addItem(new KB.Backbone.Frontend.ModuleDelete({model:this.ModuleView.model,parent:this.ModuleView})),this.MoveControl=this.addItem(new KB.Backbone.Frontend.ModuleMove({model:this.ModuleView.model,parent:this.ModuleView}))},renderControls:function(){this.ModuleView.$el.append(KB.Templates.render("frontend/module-controls",{model:this.ModuleView.model.toJSON(),i18n:KB.i18n.jsFrontend})),this.$el=jQuery(".kb-module-controls",this.ModuleView.$el),this.$menuList=jQuery('<ul class="controls-wrap"></ul>').appendTo(this.$el)},addItem:function(view){if(view.isValid&&view.isValid()===!0){var $liItem=jQuery("<li></li>").appendTo(this.$menuList),$menuItem=$liItem.append(view.el);return this.$menuList.append($menuItem),view}}}),KB.Backbone.ModuleView=Backbone.View.extend({focus:!1,$dropZone:jQuery('<div class="kb-module__dropzone"><span class="dashicons dashicons-plus"></span> add </div>'),attachedFields:[],initialize:function(options){var that=this;return KB.Checks.userCan("edit_kontentblocks")?(this.Area=options.Area,this.model.view=this,this.listenTo(this.model,"change",this.modelChange),this.listenTo(this.model,"save",this.model.save),this.$el.data("ModuleView",this),this.render(),KB.appData.config.useModuleNav&&KB.Menubar.attachModuleView(this),this.setControlsPosition(),this.Controls=new KB.Backbone.Frontend.ModuleControlsView({ModuleView:this}),jQuery(window).on("kontentblocks::ajaxUpdate",function(){that.setControlsPosition()}),void 0):(_K.log("Permission insufficient"),void 0)},events:{"click .kb-module__placeholder":"openOptions","click .kb-module__dropzone":"setDropZone","click .kb-js-inline-delete":"confirmDelete","click .editable":"reloadModal","hover.first":"setActive","hover.second":"setControlsPosition"},openOptions:function(){this.Controls.EditControl.openForm()},setActive:function(){KB.currentModule=this},render:function(){var settings;this.$el.hasClass("draft")&&""===this.model.get("moduleData")&&this.renderPlaceholder(),this.$el.attr("rel",this.model.get("mid")+"_"+_.uniqueId()),settings=this.model.get("settings"),settings.controls&&settings.controls.hide||jQuery(".os-controls",this.$el).length>0},setControlsPosition:function(){var elpostop,elposleft,mSettings,$controls,pos,height;elpostop=0,elposleft=0,mSettings=this.model.get("settings"),$controls=jQuery(".os-controls",this.$el),pos=this.$el.offset(),height=this.$el.height(),mSettings.controls&&mSettings.controls.toolbar&&(pos.top=mSettings.controls.toolbar.top,pos.left=mSettings.controls.toolbar.left),"hidden"!==this.$el.css("overflow")&&pos.top>60&&119>height&&(elpostop=-25),"hidden"!==this.$el.css("overflow")&&pos.left>100&&height>120&&this.$el.class&&(elpostop=0,elposleft=-30,$controls.addClass("kb-module-nav__vertical")),pos.top<20&&(elpostop=10),$controls.css({top:elpostop+"px",left:elposleft})},reloadModal:function(force){return KB.EditModalModules&&KB.EditModalModules.reload(this,force),KB.CurrentModel=this.model,KB.focusedModule=this.model,this},insertDropZone:function(){this.focus=!0,this.$el.append(this.$dropZone)},removeDropZone:function(){this.focus=!1,this.$el.find(".kb-module__dropzone").remove()},setDropZone:function(){var ModuleBrowser;ModuleBrowser=this.Area.openModuleBrowser(),ModuleBrowser.dropZone=this},renderPlaceholder:function(){this.$el.append(KB.Templates.render("frontend/module-placeholder",{model:this.model.toJSON()}))},addField:function(key,obj,arrayKey){_.isEmpty(arrayKey)?this.attachedFields[key]=obj:this.attachedFields[arrayKey][key]=obj},hasField:function(key,arrayKey){return _.isEmpty(arrayKey)?key in this.attachedFields:(this.attachedFields[arrayKey]||(this.attachedFields[arrayKey]={}),key in this.attachedFields[arrayKey])},getField:function(key,arrayKey){return _.isEmpty(arrayKey)?this.attachedFields[key]:this.attachedFields[arrayKey][key]},clearFields:function(){_K.info("Attached Fields were reset to empty object"),this.attachedFields={}},getDirty:function(){this.$el.addClass("isDirty"),KB.appData.config.useModuleNav&&this.Menubar.$el.addClass("isDirty")},getClean:function(){this.$el.removeClass("isDirty"),KB.appData.config.useModuleNav&&this.Menubar.$el.removeClass("isDirty")},modelChange:function(){this.getDirty()},save:function(){}}),KB.Backbone.ModuleBrowser.prototype.success=function(data){var model;this.dropZone?(this.dropZone.$el.after(data.html),this.dropZone.removeDropZone()):this.options.area.$el.append(data.html).removeClass("kb-area__empty"),model=KB.Modules.add(new KB.Backbone.ModuleModel(data.module)),_K.info("new module created",{view:model.view}),this.parseAdditionalJSON(data.json),KB.TinyMCE.addEditor(model.view.$el),KB.Fields.trigger("newModule",KB.Views.Modules.lastViewAdded),KB.Environment.moduleCount++,this.options.area.trigger("kb.module.created"),setTimeout(function(){model.view.openOptions(),model.view.renderPlaceholder()},300)},function(close){KB.Backbone.ModuleBrowser.prototype.close=function(){delete this.dropZone,close.call(this)}}(KB.Backbone.ModuleBrowser.prototype.close),KB.IEdit.BackgroundImage=function($){var self,attachment;return self={selector:".editable-bg-image",remove:".kb-js-reset-file",img:null,init:function(){var that=this;$("body").on("click",this.selector,function(e){e.preventDefault(),that.img=$(this),that.parent=KB.currentModule,that.frame().open()}),$("body").on("click",this.remove,function(e){e.preventDefault(),that.container=$(".kb-field-file-wrapper",activeField),that.resetFields()}),this.renderControls()},renderControls:function(){$(this.selector).each(function(){$("body").on("mouseover",".editable-bg-image",function(){$(this).css("cursor","pointer")})})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:"Change background image",button:{text:"Insert"},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){$(".media-modal").addClass(" smaller no-sidebar")},select:function(){attachment=this.get("selection").first(),self.handleAttachment(attachment)},handleAttachment:function(attachment){var that=this,id=attachment.get("id"),value={id:id,title:attachment.get("title"),caption:attachment.get("caption")},data=this.img.data(),mId=data.module,cModule=KB.Modules.get(mId),moduleData=_.clone(cModule.get("moduleData")),path=data.kpath,settings=KB.payload.FrontSettings[data.uid];KB.Util.setIndex(moduleData,path,value),cModule.set("moduleData",moduleData),cModule.trigger("kb.frontend.module.inlineUpdate"),jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:settings,id:id,_ajax_nonce:KB.Config.getNonce("read")},type:"GET",dataType:"json",success:function(res){that.img.css("backgroundImage","url('"+res+"')"),that.parent.$el.addClass("isDirty")
},error:function(){}})},resetFields:function(){$(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),$(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery),KB.IEdit.Image=function($){var self,attachment;return self={selector:".editable-image",remove:".kb-js-reset-file",img:null,init:function(){var that=this,$body=$("body");$body.on("click",this.selector,function(e){e.preventDefault(),that.img=$(this),that.parent=KB.currentModule,that.frame().open()}),$body.on("click",this.remove,function(e){e.preventDefault(),that.container=$(".kb-field-file-wrapper",activeField),that.resetFields()}),this.renderControls()},renderControls:function(){$(this.selector).each(function(){$("body").on("mouseover",".editable-image",function(){$(this).css("cursor","pointer")})})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:KB.i18n.Refields.file.modalTitle,button:{text:KB.i18n.Refields.common.select},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){$(".media-modal").addClass("smaller no-sidebar")},select:function(){attachment=this.get("selection").first(),self.handleAttachment(attachment)},handleAttachment:function(attachment){var that=this,id=attachment.get("id"),value=this.prepareValue(attachment),data=this.img.data(),mId=data.module,cModule=KB.Modules.get(mId),moduleData=_.clone(cModule.get("moduleData")),path=data.kpath;KB.Util.setIndex(moduleData,path,value);var settings=KB.payload.FrontSettings[data.uid];cModule.set("moduleData",moduleData),cModule.trigger("kb.frontend.module.inlineUpdate"),jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:settings,id:id,_ajax_nonce:KB.Config.getNonce("read")},type:"GET",dataType:"json",success:function(res){that.img.attr("src",res),that.parent.$el.addClass("isDirty")},error:function(){}})},prepareValue:function(attachment){return{id:attachment.get("id"),title:attachment.get("title"),caption:attachment.get("caption")}},resetFields:function(){$(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),$(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery),_.extend(KB.IEdit.Image,Backbone.Events),KB.IEdit.Link=function($){var $form,$linkTarget,$linktext,$body,$href,$title;return{selector:".editable-link",oWpLink:null,$anchor:null,init:function(){var that=this;$body=$("body"),$body.on("click",this.selector,function(e){e.stopPropagation(),e.ctrlKey&&(e.preventDefault(),e.stopPropagation(),that.$anchor=$(this),that.open())}),$body.on("click","#wp-link-close",function(){that.close()})},open:function(){var that=this;return window.wpLink?(this.restore_htmlUpdate=wpLink.htmlUpdate,this.restore_isMce=wpLink.isMCE,this.restore_close=wpLink.close,wpLink.isMCE=function(){return!1},wpLink.open(),this.addLinktextField(),this.customizeDialog(),this.setValues(),wpLink.htmlUpdate=function(){var attrs,textarea=wpLink.textarea;textarea&&(attrs=wpLink.getAttrs(),$linktext&&(attrs.linktext=$("input",$linktext).val()),attrs.href&&"http://"!=attrs.href&&(that.$anchor.attr("href",attrs.href),that.$anchor.html(attrs.linktext),that.$anchor.attr("target",attrs.target),that.updateModel(attrs),that.close(),wpLink.close()))},void 0):!1},addLinktextField:function(){$form=$("form#wp-link"),$linkTarget=$(".link-target",$form),$linktext=$('<div><label><span>LinkText</span><input type="text" value="hello" name="linktext" ></label></div>').insertBefore($linkTarget)},customizeDialog:function(){$("#wp-link-wrap").addClass("kb-customized")},setValues:function(){$href=$("#url-field",$form),$title=$("#link-title-field",$form);var data=this.$anchor.data(),mId=data.module,moduleData=KB.Modules.get(mId).get("moduleData"),lData={};lData=KB.Util.getIndex(moduleData,data.kpath),$href.val(lData.link),$title.val(lData.title),$linktext.find("input").val(lData.linktext),"_blank"===lData.target&&$("#link-target-checkbox").prop("checked",!0)},close:function(){wpLink.isMCE=this.restore_isMce,wpLink.htmlUpdate=this.restore_htmlUpdate,wpLink.close=this.restore_close,$linktext.remove()},updateModel:function(attrs){var data=this.$anchor.data(),mId=data.module,cModule=KB.Modules.get(mId),value={link:attrs.href,title:attrs.title,target:attrs.target,linktext:attrs.linktext},moduleData=_.clone(cModule.get("moduleData")),path=data.kpath;KB.Util.setIndex(moduleData,path,value),cModule.set("moduleData",moduleData),cModule.trigger("kb.frontend.module.inlineUpdate")}}}(jQuery),KB.IEdit.Text=function(el){var settings;if(_.isUndefined(el))return!1;KB.payload.FrontSettings&&KB.payload.FrontSettings[el.id]&&(settings=KB.payload.FrontSettings[el.id].tinymce?KB.payload.FrontSettings[el.id].tinymce:{});var defaults={theme:"modern",skin:!1,menubar:!1,add_unload_trigger:!1,fixed_toolbar_container:"#kb-toolbar",schema:"html5",inline:!0,plugins:"textcolor, wplink",statusbar:!1,preview_styles:!1,setup:function(ed){ed.on("init",function(){var cleaned,$placeholder,data=jQuery(ed.bodyElement).data(),module=data.module;ed.kfilter=data.filter&&"content"===data.filter?!0:!1,ed.module=KB.Modules.get(module),ed.kpath=data.kpath,ed.module.view.$el.addClass("inline-editor-attached"),$placeholder=jQuery("<span class='kb-text-placeholder'>Your voice is missing</span>"),KB.Events.trigger("KB::tinymce.new-inline-editor",ed),cleaned=ed.getContent().replace(/\s/g,"").replace(/&nbsp;/g,"").replace(/<br>/g,"").replace(/<p><\/p>/g,""),""===cleaned?(ed.setContent($placeholder.html()),ed.placeholder=!0):ed.placeholder=!1}),ed.on("click",function(e){e.stopPropagation()}),ed.on("focus",function(){var con=KB.Util.getIndex(ed.module.get("moduleData"),ed.kpath);ed.previousContent=ed.getContent(),ed.kfilter&&ed.setContent(switchEditors.wpautop(con)),jQuery("#kb-toolbar").show(),ed.module.view.$el.addClass("inline-edit-active"),ed.placeholder!==!1}),ed.on("change",function(){_K.info("Got Dirty")}),ed.addButton("kbcancleinline",{title:"Stop inline Edit",onClick:function(){tinymce.activeEditor.isDirty()&&tinymce.activeEditor.module.view.getDirty(),tinymce.activeEditor.fire("blur"),tinymce.activeEditor=null,tinymce.focusedEditor=null,document.activeElement.blur(),jQuery("#kb-toolbar").hide()}}),ed.on("blur",function(){var content,moduleData,path;ed.module.view.$el.removeClass("inline-edit-active"),jQuery("#kb-toolbar").hide(),content=ed.getContent(),ed.kfilter&&(content=switchEditors._wp_Nop(ed.getContent())),moduleData=_.clone(ed.module.get("moduleData")),path=ed.kpath,KB.Util.setIndex(moduleData,path,content),ed.isDirty()?(ed.placeholder=!1,ed.kfilter?jQuery.ajax({url:ajaxurl,data:{action:"applyContentFilter",data:content.replace(/\'/g,"%27"),module:ed.module.toJSON(),_ajax_nonce:KB.Config.getNonce("read")},type:"POST",dataType:"html",success:function(res){ed.setContent(res),ed.module.set("moduleData",moduleData),ed.module.trigger("kb.frontend.module.inlineUpdate")},error:function(){}}):(ed.module.set("moduleData",moduleData),ed.module.trigger("kb.frontend.module.inlineUpdate"))):ed.setContent(ed.previousContent)})}};defaults=_.extend(defaults,settings),tinymce.init(_.defaults(defaults,{selector:"#"+el.id}))},KB.Events.on("KB::ready",function(){return KB.Checks.userCan("edit_kontentblocks")?(jQuery(".editable").each(function(i,item){KB.Checks.userCan("edit_kontentblocks")&&KB.IEdit.Text(item)}),KB.IEdit.Image.init(),KB.IEdit.BackgroundImage.init(),KB.IEdit.Link.init(),void 0):!1}),KB.currentModule={},KB.currentArea={},KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function init(){var $toolbar=jQuery('<div id="kb-toolbar"></div>').appendTo("body");$toolbar.hide(),KB.appData.config.useModuleNav&&(KB.Menubar=new KB.Backbone.MenubarView),KB.EditModalModules=new KB.Backbone.EditModalModules({}),KB.Modules.on("add",createModuleViews),KB.Areas.on("add",createAreaViews),KB.Modules.on("remove",removeModule),addViews(),KB.Ui.init()}function shutdown(){_.each(KB.Modules.toArray(),function(item){KB.Modules.remove(item)}),jQuery(".editable").each(function(i,el){tinymce.remove("#"+el.id)}),jQuery("body").off("click",".editable-image"),jQuery("body").off("click",".editable-link")}function addViews(){return KB.appData.config.preview?!1:(_.each(KB.payload.Areas,function(area){KB.Areas.add(new KB.Backbone.AreaModel(area))}),_.each(KB.payload.Modules,function(module){KB.Modules.add(module)}),KB.trigger("kb:moduleControlsAdded"),KB.Events.trigger("KB::frontend-init"),void 0)}function createModuleViews(ModuleModel){var ModuleView,Area;ModuleModel.setArea(KB.Areas.get(ModuleModel.get("area"))),ModuleModel.bind("change:area",ModuleModel.areaChanged),Area=KB.Views.Areas.get(ModuleModel.get("area")),ModuleView=KB.Views.Modules.add(ModuleModel.get("instance_id"),new KB.Backbone.ModuleView({model:ModuleModel,el:"#"+ModuleModel.get("instance_id"),Area:Area})),ModuleView.$el.data("ModuleView",ModuleView),Area.addModuleView(ModuleView),KB.Ui.initTabs()}function createAreaViews(AreaModel){KB.Views.Areas.add(AreaModel.get("id"),new KB.Backbone.AreaView({model:AreaModel,el:"#"+AreaModel.get("id")}))}function removeModule(ModuleModel){KB.Views.Modules.remove(ModuleModel.get("instance_id"))}return{init:init,shutdown:shutdown}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&KB.appData.config.frontend&&(KB.Views.Modules.readyOnFront(),_K.info("Frontend Modules Ready Event fired"),_KS.info("Frontend welcomes you")),KB.Events.trigger("KB::ready"),setUserSetting("editor","tinymce")});