/*! Kontentblocks ProdVersion 2014-07-28 10:07 */
KB.IEdit.BackgroundImage=function($){var self,attachment;return self={selector:".editable-bg-image",remove:".kb-js-reset-file",img:null,init:function(){var that=this;$("body").on("click",this.selector,function(e){e.preventDefault(),that.img=$(this),that.parent=KB.currentModule,that.frame().open()}),$("body").on("click",this.remove,function(e){e.preventDefault(),that.container=$(".kb-field-file-wrapper",activeField),that.resetFields()}),this.renderControls()},renderControls:function(){$(this.selector).each(function(){$("body").on("mouseover",".editable-bg-image",function(){$(this).css("cursor","pointer")})})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:"Change background image",button:{text:"Insert"},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){$(".media-modal").addClass(" smaller no-sidebar")},select:function(){attachment=this.get("selection").first(),self.handleAttachment(attachment)},handleAttachment:function(attachment){var that=this,id=attachment.get("id"),value={id:id,title:attachment.get("title"),caption:attachment.get("caption")},data=this.img.data(),mId=data.module,cModule=KB.Modules.get(mId),moduleData=_.clone(cModule.get("moduleData"));_.isEmpty(data.index)||_.isEmpty(data.arraykey)?_.isEmpty(data.index)?_.isEmpty(data.arraykey)?moduleData[data.key]=value:moduleData[data.arraykey][data.key]=value:moduleData[data.index][data.key]=value:moduleData[data.arraykey][data.index][data.key]=value;var settings=KB.payload.FrontSettings[data.uid];cModule.set("moduleData",moduleData),jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:settings,id:id,_ajax_nonce:kontentblocks.nonces.get},type:"GET",dataType:"json",success:function(res){that.img.css("backgroundImage","url('"+res+"')"),that.parent.$el.addClass("isDirty")},error:function(){}})},resetFields:function(){$(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),$(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery),KB.IEdit.Image=function($){var self,attachment;return self={selector:".editable-image",remove:".kb-js-reset-file",img:null,init:function(){var that=this,$body=$("body");$body.on("click",this.selector,function(e){e.preventDefault(),that.img=$(this),that.parent=KB.currentModule,that.frame().open()}),$body.on("click",this.remove,function(e){e.preventDefault(),that.container=$(".kb-field-file-wrapper",activeField),that.resetFields()}),this.renderControls()},renderControls:function(){$(this.selector).each(function(){$("body").on("mouseover",".editable-image",function(){$(this).css("cursor","pointer")})})},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:KB.i18n.Refields.file.modalTitle,button:{text:KB.i18n.Refields.common.select},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame)},ready:function(){$(".media-modal").addClass(" smaller no-sidebar")},select:function(){attachment=this.get("selection").first(),self.handleAttachment(attachment)},handleAttachment:function(attachment){var that=this,id=attachment.get("id"),value=this.prepareValue(attachment),data=this.img.data(),mId=data.module,cModule=KB.Modules.get(mId),moduleData=_.clone(cModule.get("moduleData")),path=data.kpath;KB.Util.setIndex(moduleData,path,value);var settings=KB.payload.FrontSettings[data.uid];cModule.set("moduleData",moduleData),jQuery.ajax({url:ajaxurl,data:{action:"fieldGetImage",args:settings,id:id,_ajax_nonce:kontentblocks.nonces.get},type:"GET",dataType:"json",success:function(res){that.img.attr("src",res),that.parent.$el.addClass("isDirty")},error:function(){}})},prepareValue:function(attachment){return{id:attachment.get("id"),title:attachment.get("title"),caption:attachment.get("caption")}},resetFields:function(){$(".kb-file-attachment-id",this.container).val(""),this.container.hide(750),$(this.remove,activeField).hide()},update:function(){this.init()}}}(jQuery),_.extend(KB.IEdit.Image,Backbone.Events),KB.IEdit.Link=function($){var $form,$linkTarget,$linktext,$body,$href,$title;return{selector:".editable-link",oWpLink:null,$anchor:null,init:function(){var that=this;$body=$("body"),$body.on("click",this.selector,function(e){e.stopPropagation(),e.ctrlKey&&(e.preventDefault(),e.stopPropagation(),that.$anchor=$(this),that.open())}),$body.on("click","#wp-link-close",function(){that.close()})},open:function(){var that=this;return window.wpLink?(this.restore_htmlUpdate=wpLink.htmlUpdate,this.restore_isMce=wpLink.isMCE,this.restore_close=wpLink.close,wpLink.isMCE=function(){return!1},wpLink.open(),this.addLinktextField(),this.customizeDialog(),this.setValues(),wpLink.htmlUpdate=function(){var attrs,textarea=wpLink.textarea;textarea&&(attrs=wpLink.getAttrs(),$linktext&&(attrs.linktext=$("input",$linktext).val()),attrs.href&&"http://"!=attrs.href&&(that.$anchor.attr("href",attrs.href),that.$anchor.html(attrs.linktext),that.$anchor.attr("target",attrs.target),that.updateModel(attrs),that.close(),wpLink.close()))},void 0):!1},addLinktextField:function(){$form=$("form#wp-link"),$linkTarget=$(".link-target",$form),$linktext=$('<div><label><span>LinkText</span><input type="text" value="hello" name="linktext" ></label></div>').insertBefore($linkTarget)},customizeDialog:function(){$("#wp-link-wrap").addClass("kb-customized")},setValues:function(){$href=$("#url-field",$form),$title=$("#link-title-field",$form);var data=this.$anchor.data(),mId=data.module,moduleData=KB.Modules.get(mId).get("moduleData"),lData={};lData=KB.Util.getIndex(moduleData,data.kpath),$href.val(lData.link),$title.val(lData.title),$linktext.find("input").val(lData.linktext),"_blank"===lData.target&&$("#link-target-checkbox").prop("checked",!0)},close:function(){wpLink.isMCE=this.restore_isMce,wpLink.htmlUpdate=this.restore_htmlUpdate,wpLink.close=this.restore_close,$linktext.remove()},updateModel:function(attrs){var data=this.$anchor.data(),mId=data.module,cModule=KB.Modules.get(mId),value={link:attrs.href,title:attrs.title,target:attrs.target,linktext:attrs.linktext},moduleData=_.clone(cModule.get("moduleData")),path=data.kpath;KB.Util.setIndex(moduleData,path,value),cModule.set("moduleData",moduleData)}}}(jQuery),KB.IEdit.Text=function(el){var settings;if(_.isUndefined(el))return!1;KB.payload.FrontSettings&&KB.payload.FrontSettings[el.id]&&(settings=KB.payload.FrontSettings[el.id].tinymce?KB.payload.FrontSettings[el.id].tinymce:{});var defaults={theme:"modern",skin:!1,menubar:!1,add_unload_trigger:!1,fixed_toolbar_container:"#kb-toolbar",schema:"html5",inline:!0,plugins:"textcolor, wplink",statusbar:!1,preview_styles:!1,setup:function(ed){ed.on("init",function(){var data=jQuery(ed.bodyElement).data(),module=data.module;ed.kfilter=data.filter&&"content"===data.filter?!0:!1,ed.module=KB.Modules.get(module),ed.kpath=data.kpath,ed.module.view.$el.addClass("inline-editor-attached"),KB.Events.trigger("KB::tinymce.new-inline-editor",ed)}),ed.on("click",function(e){e.stopPropagation()}),ed.on("focus",function(){var con=KB.Util.getIndex(ed.module.get("moduleData"),ed.kpath);ed.previousContent=ed.getContent(),ed.setContent(switchEditors.wpautop(con)),jQuery("#kb-toolbar").show(),ed.module.view.$el.addClass("inline-edit-active")}),ed.on("change",function(){_K.info("Got Dirty")}),ed.addButton("kbcancleinline",{title:"Stop inline Edit",onClick:function(){tinymce.activeEditor.isDirty()&&tinymce.activeEditor.module.view.getDirty(),tinymce.activeEditor.fire("blur"),tinymce.activeEditor=null,tinymce.focusedEditor=null,document.activeElement.blur(),jQuery("#kb-toolbar").hide()}}),ed.on("blur",function(){ed.module.view.$el.removeClass("inline-edit-active"),jQuery("#kb-toolbar").hide();var value=switchEditors._wp_Nop(ed.getContent()),moduleData=_.clone(ed.module.get("moduleData")),path=ed.kpath;KB.Util.setIndex(moduleData,path,value),ed.isDirty()?ed.kfilter&&jQuery.ajax({url:ajaxurl,data:{action:"applyContentFilter",data:value.replace(/\'/g,"%27"),module:ed.module.toJSON(),_ajax_nonce:kontentblocks.nonces.read},type:"POST",dataType:"html",success:function(res){ed.setContent(res),ed.module.trigger("change"),ed.module.set("moduleData",moduleData)},error:function(){ed.module.trigger("change"),ed.module.set("moduleData",moduleData)}}):ed.setContent(ed.previousContent)})}};defaults=_.extend(defaults,settings),tinymce.init(_.defaults(defaults,{selector:"#"+el.id}))},KB.Backbone.AreaModel=Backbone.Model.extend({idAttribute:"id"}),KB.Backbone.ModuleModel=Backbone.Model.extend({idAttribute:"instance_id",destroy:function(){var that=this;KB.Ajax.send({action:"removeModules",instance_id:that.get("instance_id")},that.destroyed)},destroyed:function(){},setArea:function(area){this.area=area},areaChanged:function(){this.view.updateModuleForm()}}),KB.Backbone.AreaView=Backbone.View.extend({initialize:function(){}}),KB.Backbone.FrontendEditView=Backbone.View.extend({$form:null,$formContent:null,timerId:null,initialize:function(options){var that=this;this.options=options,this.view=options.view,this.model.on("change",this.test,this),this.listenTo(this.view,"template::changed",function(){that.serialize(!1),that.render()}),this.listenTo(this.view,"kb:moduleUpdated",function(){that.$el.removeClass("isDirty")}),this.listenTo(KB,"frontend::recalibrate",this.recalibrate),this.listenTo(KB.Events,"KB::edit-modal-refresh",this.recalibrate),this.listenTo(this,"recalibrate",this.recalibrate),jQuery(KB.Templates.render("frontend/module-edit-form",{model:this.model.toJSON(),i18n:KB.i18n.jsFrontend})).appendTo(this.$el),this.$form=jQuery("#onsite-form",this.$el),this.$formContent=jQuery("#onsite-content",this.$el),this.$inner=jQuery(".os-content-inner",this.$formContent),this.$el.css("position","fixed").draggable({handle:"h2",containment:"window",stop:function(eve,ui){KB.OSConfig.wrapPosition=ui.position,that.recalibrate(ui.position)}}),jQuery(window).on("resize",function(){that.recalibrate()}),KB.OSConfig.wrapPosition&&this.$el.css({top:KB.OSConfig.wrapPosition.top,left:KB.OSConfig.wrapPosition.left}),this.listenTo(KB.Events,"KB::tinymce.new-editor",function(ed){ed.settings&&ed.settings.kblive&&that.attachEditorEvents(ed)}),jQuery(document).on("KB:osUpdate",function(){that.serialize(!1)}),jQuery(document).on("change",".kb-observe",function(){that.serialize(!1)}),jQuery("body").append(this.$el),this.$el.hide(),this.render()},test:function(){},events:{keyup:"delayInput","click a.close-controls":"destroy","click a.kb-save-form":"update","click a.kb-preview-form":"preview"},preview:function(){this.serialize(!1)},update:function(){this.serialize(!0)},render:function(){var that=this;this.applyControlsSettings(this.$el),KB.lastAddedModule={view:that},jQuery.ajax({url:ajaxurl,data:{action:"getModuleOptions",module:that.model.toJSON(),_ajax_nonce:kontentblocks.nonces.read},type:"POST",dataType:"json",success:function(res){if(that.$inner.empty(),that.view.clearFields(),that.$inner.attr("id",that.view.model.get("instance_id")),that.$inner.append(res.html),that.$el.fadeTo(750,.1),res.json){var merged=_.extend(KB.payload,res.json);KB.payload=merged}KB.Ui.initTabs(),KB.Ui.initToggleBoxes(),KB.TinyMCE.addEditor();var localView=_.clone(that.view);localView.$el=that.$inner,localView.parentView=that.view,that.view.trigger("kb:frontend::viewLoaded",localView),_K.info("Frontend Modal opened with view of:"+that.view.model.get("instance_id")),setTimeout(function(){KB.Fields.trigger("frontUpdate",localView)},500),setTimeout(function(){that.recalibrate(),that.$el.fadeTo(300,1)},600)},error:function(){console.log("e")}})},reload:function(moduleView){var that=this;return _K.log("Frontend Modal reload"),this.unload(),this.model&&this.model.get("instance_id")===moduleView.model.get("instance_id")?!1:(this.model=moduleView.model,this.options.view=moduleView,this.view=moduleView,this.$el.fadeTo(250,.1,function(){that.render()}),void 0)},unset:function(){this.model=null,this.options.view=null,this.view.attachedFields={}},recalibrate:function(){var winH,conH,position,winDiff;winH=jQuery(window).height()-40,conH=jQuery(".os-content-inner").height(),position=this.$el.position(),winDiff=conH+position.top-winH,winDiff>0?this.initScrollbars(conH-(winDiff+30)):conH-position.top<winH?this.initScrollbars(conH):this.initScrollbars(winH-position.top),position.top<40&&this.$el.css("top","40px"),_K.info("Frontend Modal resizing done!")},initScrollbars:function(height){jQuery(".nano",this.$el).height(height),jQuery(".nano").nanoScroller({preventPageScrolling:!0}),_K.info("Nano Scrollbars (re)initialized!")},serialize:function(mode,showNotice){_K.info("Frontend Modal called serialize function. Savemode",save);var that=this,save=mode||!1,notice=showNotice!==!1;tinymce.triggerSave(),jQuery.ajax({url:ajaxurl,data:{action:"updateModuleOptions",data:that.$form.serialize().replace(/\'/g,"%27"),module:that.model.toJSON(),editmode:save?"update":"preview",_ajax_nonce:kontentblocks.nonces.update},type:"POST",dataType:"json",success:function(res){jQuery(".editable",that.options.view.$el).each(function(i,el){tinymce.remove("#"+el.id)});var height=that.options.view.$el.height();that.options.view.$el.height(height),that.options.view.$el.html(res.html),that.options.view.$el.css("height","auto"),that.model.set("moduleData",res.newModuleData),jQuery(document).trigger("kb:module-update-"+that.model.get("settings").id,that.options.view),that.model.view.delegateEvents(),that.model.view.trigger("kb:moduleUpdated"),that.view.trigger("kb:frontend::viewUpdated"),KB.Events.trigger("KB::ajax-update"),KB.trigger("kb:frontendModalUpdated"),setTimeout(function(){jQuery(".editable",that.options.view.$el).each(function(i,el){KB.IEdit.Text(el)}),that.model.view.render()},400),save?(notice&&KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticeDataSaved,"success"),that.$el.removeClass("isDirty"),that.model.view.getClean(),that.trigger("kb:frontend-save")):(notice&&KB.Notice.notice(KB.i18n.jsFrontend.frontendModal.noticePreviewUpdated,"success"),that.$el.addClass("isDirty")),_K.info("Frontend Modal saved data for:"+that.model.get("instance_id"))},error:function(){console.log("e")}})},delayInput:function(){var that=this;this.options.timerId&&clearTimeout(this.options.timerId),this.options.timerId=setTimeout(function(){that.options.timerId=null,that.serialize(!1,!1)},750)},attachEditorEvents:function(ed){var that=this;ed.onKeyUp.add(function(){that.delayInput()})},destroy:function(){var that=this;this.$el.fadeTo(500,0,function(){that.unload(),that.unbind(),that.remove(),KB.FrontendEditModal=null})},unload:function(){this.unset(),jQuery(".wp-editor-area",this.$el).each(function(i,item){tinymce.remove("#"+item.id)})},applyControlsSettings:function($el){var settings=this.model.get("settings");settings.controls&&settings.controls.width&&$el.css("width",settings.controls.width+"px")}}),KB.Backbone.ModuleView=Backbone.View.extend({attachedFields:[],initialize:function(){KB.Checks.userCan("edit_kontentblocks")&&(this.model.view=this,this.listenTo(this.model,"change",this.modelChange),this.model.bind("save",this.model.save),this.render(),KB.ModuleNav.attach(this))},events:{"click a.os-edit-block":"openOptions","click .editable":"reloadModal","click .kb-js-inline-update":"updateModule",hover:"setActive"},setActive:function(){KB.currentModule=this},render:function(){},openOptions:function(){return KB.FrontendEditModal?(this.reloadModal(),!1):(KB.FrontendEditModal=new KB.Backbone.FrontendEditView({tagName:"div",id:"onsite-modal",model:this.model,view:this}),KB.focusedModule=this.model,void 0)},reloadModal:function(){KB.FrontendEditModal&&KB.FrontendEditModal.reload(this),KB.CurrentModel=this.model,KB.focusedModule=this.model},updateModule:function(){var that=this,moduleData={},refresh=!1;moduleData[that.model.get("instance_id")]=that.model.get("moduleData"),jQuery.ajax({url:ajaxurl,data:{action:"updateModuleOptions",data:jQuery.param(moduleData).replace(/\'/g,"%27"),module:that.model.toJSON(),editmode:"update",refresh:refresh,_ajax_nonce:kontentblocks.nonces.update},type:"POST",dataType:"json",success:function(res){refresh&&that.$el.html(res.html),tinymce.triggerSave(),that.model.set("moduleData",res.newModuleData),that.render(),that.trigger("kb:moduleUpdated"),KB.Events.trigger("KB::ajax-update"),KB.Notice.notice("Module saved successfully","success"),that.$el.removeClass("isDirty")},error:function(){console.log("e")}})},addField:function(key,obj,arrayKey){_.isEmpty(arrayKey)?this.attachedFields[key]=obj:this.attachedFields[arrayKey][key]=obj},hasField:function(key,arrayKey){return _.isEmpty(arrayKey)?key in this.attachedFields:(this.attachedFields[arrayKey]||(this.attachedFields[arrayKey]={}),key in this.attachedFields[arrayKey])},getField:function(key,arrayKey){return _.isEmpty(arrayKey)?this.attachedFields[key]:this.attachedFields[arrayKey][key]},clearFields:function(){_K.info("Attached Fields were reset to empty object"),this.attachedFields={}},getDirty:function(){this.$el.addClass("isDirty"),this.controlView.$el.addClass("isDirty")},getClean:function(){this.$el.removeClass("isDirty"),this.controlView.$el.removeClass("isDirty")},modelChange:function(){this.getDirty()},save:function(){}}),KB.Backbone.ModuleNavItem=Backbone.View.extend({initialize:function(){var that=this;this.el=KB.Templates.render("frontend/module-nav-item",{view:this.model.model.toJSON()}),this.$el=jQuery(this.el),this.model.controlView=this,jQuery(window).scroll(function(){that.model.$el.visible(!0,!0)?that.$el.addClass("in-viewport"):that.$el.removeClass("in-viewport")}),this.model.$el.on("mouseenter",function(){that.$el.addClass("in-viewport-active")}),this.model.$el.on("mouseleave",function(){that.$el.removeClass("in-viewport-active")})},events:{mouseenter:"over",mouseleave:"out",click:"scrollTo","click .kb-module-nav-item__edit":"openControls","click .kb-js-inline-update":"inlineUpdate"},render:function(){return this.$el},over:function(){this.model.$el.addClass("kb-nav-active")},out:function(){this.model.$el.removeClass("kb-nav-active")},openControls:function(e){e.stopPropagation(),this.model.openOptions()},inlineUpdate:function(){this.model.updateModule(),this.model.getClean()},scrollTo:function(){var that=this;jQuery("html, body").animate({scrollTop:that.model.$el.offset().top-100},750)}}),KB.Backbone.ModuleNavView=Backbone.View.extend({subviews:[],tagName:"div",className:"kb-module-nav-container",initialize:function(){this.show=_.isNull(KB.Util.stex.get("kb-nav-show"))?!0:KB.Util.stex.get("kb-nav-show"),this.render()},events:{"click .kb-nav-toggle":"toggleView","mouseenter .kb-nav-toggle":"over","mouseleave .kb-nav-toggle":"out"},render:function(){this.$el.appendTo("body"),this.$list=jQuery("<ul></ul>").appendTo(this.$el),this.$toggle=jQuery('<div class="kb-nav-toggle genericon genericon-menu"></div>').appendTo(this.$el),this.show&&this.$el.addClass("kb-nav-show")},attach:function(moduleView){moduleView.ModuleNav=this,this.renderItem(moduleView)},renderItem:function(moduleView){var Item=new KB.Backbone.ModuleNavItem({model:moduleView});this.$list.append(Item.render())},toggleView:function(){this.$el.toggleClass("kb-nav-show"),this.$el.removeClass("kb-nav-show-partly");var show=!this.show;this.show=show,KB.Util.stex.set("kb-nav-show",show,6e5)},over:function(){this.show||this.$el.addClass("kb-nav-show-partly")},out:function(){this.show||this.$el.removeClass("kb-nav-show-partly")}}),KB.currentModule={},KB.currentArea={},KB.Views={Modules:new KB.ViewsCollection,Areas:new KB.ViewsCollection,Context:new KB.ViewsCollection},KB.Modules=new Backbone.Collection([],{model:KB.Backbone.ModuleModel}),KB.Areas=new Backbone.Collection([],{model:KB.Backbone.AreaModel}),KB.App=function(){function init(){var $toolbar=jQuery('<div id="kb-toolbar"></div>').appendTo("body");$toolbar.hide(),KB.ModuleNav=new KB.Backbone.ModuleNavView,KB.Modules.on("add",createModuleViews),KB.Areas.on("add",createAreaViews),KB.Modules.on("remove",removeModule),addViews(),KB.Ui.init(),jQuery(".koolkip").powerTip({placement:"ne",followMouse:!0,fadeInTime:0,fadeOutTime:0})}function shutdown(){jQuery.powerTip.destroy(".koolkip"),_.each(KB.Modules.toArray(),function(item){KB.Modules.remove(item)}),jQuery(".editable").each(function(i,el){tinymce.remove("#"+el.id)}),jQuery("body").off("click",".editable-image"),jQuery("body").off("click",".editable-link")}function addViews(){return KB.appData.config.preview?!1:(_.each(KB.payload.Areas,function(area){KB.Areas.add(new KB.Backbone.AreaModel(area))}),_.each(KB.payload.Modules,function(module){KB.Modules.add(module)}),KB.trigger("kb:moduleControlsAdded"),KB.Events.trigger("KB::frontend-init"),void 0)}function createModuleViews(module){module.setArea(KB.Areas.get(module.get("area"))),module.bind("change:area",module.areaChanged),KB.Views.Modules.add(module.get("instance_id"),new KB.Backbone.ModuleView({model:module,el:"#"+module.get("instance_id")})),KB.Ui.initTabs()}function createAreaViews(area){KB.Views.Areas.add(area.get("id"),new KB.Backbone.AreaView({model:area,el:"#"+area.get("id")+"-container"}))}function removeModule(model){KB.Views.Modules.remove(model.get("instance_id"))}return{init:init,shutdown:shutdown}}(jQuery),KB.App.init(),jQuery(document).ready(function(){KB.appData&&KB.appData.config.frontend&&(_K.info("Frontend Modules Ready Event fired"),KB.Views.Modules.readyOnFront()),KB.Events.trigger("KB::ready"),jQuery(".koolkip").powerTip({placement:"ne",followMouse:!0,fadeInTime:0,fadeOutTime:0}),KB.on("kb:frontendModalUpdated",function(){jQuery(".koolkip").powerTip({placement:"ne",followMouse:!0,fadeInTime:0,fadeOutTime:0})}),jQuery(window).on("resize DOMNodeInserted",function(){}),setUserSetting("editor","tinymce")}),KB.Events.on("KB::ready",function(){return KB.Checks.userCan("edit_kontentblocks")?(jQuery(".editable").each(function(i,item){KB.Checks.userCan("edit_kontentblocks")&&KB.IEdit.Text(item)}),KB.IEdit.Image.init(),KB.IEdit.BackgroundImage.init(),KB.IEdit.Link.init(),void 0):!1});